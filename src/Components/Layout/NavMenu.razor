@using AzureNamingTool.Helpers
@using AzureNamingTool.Models
@using AzureNamingTool.Components.General
@inject StateContainer state
@inject ProtectedSessionStorage session
@inject IJSRuntime JsRuntime
@inject ILogger<NavMenu> Logger
@inject ProtectedLocalStorage storage
@inject NavigationManager NavigationManager
@inject ServicesHelper ServicesHelper

<div class="modern-sidebar-header">
    <div class="sidebar-brand">
        <div class="brand-logo">
            <img src="@logopath" alt="@toolname Logo" />
        </div>
        <div class="brand-text">
            <span class="brand-title">@toolname</span>
        </div>
    </div>
    <button type="button" 
            title="Navigation menu" 
            class="navbar-toggler" 
            @onclick="ToggleNavMenu">
        <span class="navbar-toggler-icon"></span>
    </button>
</div>

<div class="@NavMenuCssClass">
    <nav class="flex-column">
        <div class="nav-item px-2">
            <NavLink class="nav-link" href="" Match="NavLinkMatch.All">
                <span class="nav-icon oi oi-home" aria-hidden="true" title="Home"></span>
                <span class="nav-text">Home</span>
            </NavLink>
        </div>
        <div class="nav-item px-2">
            <NavLink class="nav-link" href="admin">
                <span class="nav-icon oi oi-wrench" aria-hidden="true" title="Admin"></span>
                <span class="nav-text">Admin</span>
            </NavLink>
        </div>
        @if (admin)
        {
            <div class="nav-item px-2">
                <NavLink class="nav-link" href="adminlog">
                    <span class="nav-icon oi oi-box" aria-hidden="true" title="Admin Log"></span>
                    <span class="nav-text">Admin Log</span>
                </NavLink>
            </div>
        }
        @if (Convert.ToBoolean(config.InstructionsEnabled) || admin)
        {
            <div class="nav-item px-2">
                <NavLink class="nav-link" href="instructions">
                    <span class="nav-icon oi oi-book" aria-hidden="true" title="Instructions"></span>
                    <span class="nav-text">Instructions</span>
                </NavLink>
            </div>
        }
        @if (Convert.ToBoolean(config.ConfigurationEnabled) || admin)
        {
            <div class="nav-item px-2">
                <NavLink class="nav-link" href="configuration">
                    <span class="nav-icon oi oi-cog" aria-hidden="true" title="Configuration"></span>
                    <span class="nav-text">Configuration</span>
                </NavLink>
            </div>
        }
        @if (Convert.ToBoolean(config.ReferenceEnabled) || admin)
        {
            <div class="nav-item px-2">
                <NavLink class="nav-link" href="reference">
                    <span class="nav-icon oi oi-book" aria-hidden="true" title="Reference"></span>
                    <span class="nav-text">Reference</span>
                </NavLink>
            </div>
        }
        <div class="nav-item px-2">
            <NavLink class="nav-link" href="generate">
                <span class="nav-icon oi oi-target" aria-hidden="true" title="Generate"></span>
                <span class="nav-text">Generate</span>
            </NavLink>
        </div>
        @if (Convert.ToBoolean(config.GeneratedNamesLogEnabled) || admin)
        {
            <div class="nav-item px-2">
                <NavLink class="nav-link" href="generatednameslog">
                    <span class="nav-icon oi oi-spreadsheet" aria-hidden="true" title="Generated Names Log"></span>
                    <span class="nav-text">Generated Names Log</span>
                </NavLink>
            </div>
        }

        @if (GeneralHelper.IsNotNull(PageType))
        {
            @if (PageType.ToString() == "AzureNamingTool.Components.Pages.Configuration")
            {
                <div class="modern-jump-to-section">
                    <div class="modern-jump-to-header">
                        Jump To
                    </div>
                    <div class="modern-jump-to-links">
                        <a class="modern-jump-to-link" @onclick='(() => OnConfigNavClick("ResourceComponent"))' @onclick:preventDefault href="">Components</a>
                        <a class="modern-jump-to-link" @onclick='(() => OnConfigNavClick("ResourceDelimiter"))' @onclick:preventDefault href="">Delimiters</a>
                        @if (GeneralHelper.IsNotNull(servicesData.ResourceComponents))
                        {
                            @foreach (ResourceComponent resourceComponent in servicesData.ResourceComponents.OrderBy(x => x.Name))
                            {
                                @if (resourceComponent.Name != "ResourceInstance")
                                {
                                    <a class="modern-jump-to-link" @onclick='(() => OnConfigNavClick(resourceComponent.Name))' @onclick:preventDefault href="">@(resourceComponent.DisplayName)</a>
                                }
                            }
                        }
                    </div>
                </div>
            }
            @if (PageType.ToString() == "AzureNamingTool.Components.Pages.Instructions")
            {
                <div class="modern-jump-to-section">
                    <div class="modern-jump-to-header">
                        Jump To
                    </div>
                    <div class="modern-jump-to-links">
                        @if (admin)
                        {
                            <a class="modern-jump-to-link" @onclick='(() => OnConfigNavClick("adminpassword"))' @onclick:preventDefault href="">Global Admin Password</a>
                            <a class="modern-jump-to-link" @onclick='(() => OnConfigNavClick("adminconfiguration"))' @onclick:preventDefault href="">Admin Configuration</a>
                            <a class="modern-jump-to-link" @onclick='(() => OnConfigNavClick("adminlog"))' @onclick:preventDefault href="">Admin Log</a>
                        }
                        <a class="modern-jump-to-link" @onclick='(() => OnConfigNavClick("configuration"))' @onclick:preventDefault href="">Configuration</a>
                        <a class="modern-jump-to-link" @onclick='(() => OnConfigNavClick("generate"))' @onclick:preventDefault href="">Generate</a>
                        <a class="modern-jump-to-link" @onclick='(() => OnConfigNavClick("generatednameslog"))' @onclick:preventDefault href="">Generated Names Log</a>
                        <a class="modern-jump-to-link" @onclick='(() => OnConfigNavClick("reference"))' @onclick:preventDefault href="">Reference</a>
                    </div>
                </div>
            }

            @if ((PageType.ToString() == "AzureNamingTool.Components.Pages.Index") && (connected) && Convert.ToBoolean(config.LatestNewsEnabled))
            {
                <hr />
                <div class="nav-item px-2">
                    <div class="nav-link">
                        <label title="Latest News" style="font-weight:bold;">
                            Latest News
                        </label>
                        <label class="switch" title="Latest News Switch" style="top:-5px; float:right;">
                            <input type="checkbox" checked="@latestnewsenabled" @oninput="NewsChanged">
                            <span class="slider round"></span>
                        </label>
                        <div style="clear:both"></div>
                        @if (latestnewsenabled)
                        {
                            <div classclass="nav-link" style="padding-top:10px">
                                <LatestNews></LatestNews>
                            </div>
                        }
                    </div>
                </div>
            }
        }
    </nav>
</div>

@code {
    [Parameter]
    public Type? PageType { get; set; }
    
    private bool collapseNavMenu = true;
    private ServicesData servicesData = new();
    private SiteConfiguration config = ConfigurationHelper.GetConfigurationData();
    private bool admin;
    private string NavMenuCssClass => collapseNavMenu ? "collapse" : String.Empty;
    private bool latestnewsenabled = true;
    private bool connected = true;
    private string? logopath = String.Empty;
    private string? toolname = String.Empty;

    protected override async Task OnInitializedAsync()
    {
        logopath = !String.IsNullOrEmpty(ConfigurationHelper.GetAppSetting("CustomLogoPath", false)) ? ConfigurationHelper.GetAppSetting("CustomLogoPath", false) : "images/AzureNamingToolLogo-NoText.png";
        toolname = !String.IsNullOrEmpty(ConfigurationHelper.GetAppSetting("CustomToolName", false)) ? ConfigurationHelper.GetAppSetting("CustomToolName", false) : "Azure Naming Tool";
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        var result = await session.GetAsync<bool>("admin");
        admin = (bool)result.Value;
        if (firstRender)
        {
            if (await ConfigurationHelper.VerifyConnectivity())
            {
                servicesData = await ServicesHelper.LoadServicesData(servicesData, admin);
                try
                {
                    result = await storage.GetAsync<bool>("latestnewsenabled");
                    latestnewsenabled = result.Success ? result.Value : true;
                }
                catch
                {
                    latestnewsenabled = true;
                }
                state.LatestNewsEnabled = latestnewsenabled;
            }
            else
            {
                connected = false;
            }
            StateHasChanged();
        }
        else
        {
            if ((GeneralHelper.IsNotNull(servicesData)) || (state._reloadnav))
            {
                servicesData = await ServicesHelper.LoadServicesData(servicesData, admin);
                state.SetNavReload(false);
            }
        }
    }

    private void ToggleNavMenu()
    {
        collapseNavMenu = !collapseNavMenu;
    }

    private async Task HandleMobileMenuToggle()
    {
        Logger.LogInformation("HandleMobileMenuToggle called from C#");
        
        try
        {
            await JsRuntime.InvokeVoidAsync("eval", @"
                console.log('*** BUTTON CLICKED - Blazor invoking toggleMobileMenu ***');
                console.log('Window object:', window);
                console.log('toggleMobileMenu function:', window.toggleMobileMenu);
                
                if (typeof window.toggleMobileMenu === 'function') {
                    console.log('Calling toggleMobileMenu...');
                    window.toggleMobileMenu();
                } else {
                    console.error('toggleMobileMenu function not found!');
                    console.log('Available window properties:', Object.keys(window).filter(k => k.includes('toggle')));
                }
            ");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error toggling mobile menu: {Message}", ex.Message);
            
            // Try console.log to see if JS interop works at all
            await JsRuntime.InvokeVoidAsync("eval", "console.error('Exception in HandleMobileMenuToggle: " + ex.Message + "')");
        }
    }

    private async void OnConfigNavClick(string e)
    {
        await JsRuntime.InvokeVoidAsync("scrollIntoView", e);
    }

    private async void NewsChanged(ChangeEventArgs e)
    {
        if (GeneralHelper.IsNotNull(e.Value))
        {
            latestnewsenabled = (bool)e.Value;
            await storage.SetAsync("newsenabled", latestnewsenabled);
            state.LatestNewsEnabled = latestnewsenabled;
            StateHasChanged();
        }
    }
}
