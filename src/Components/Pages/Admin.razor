@page "/admin"
@using AzureNamingTool.Components.Modals
@using AzureNamingTool.Helpers;
@using AzureNamingTool.Models;
@using System.Runtime.Caching;
@using AzureNamingTool.Services
@using AzureNamingTool.Services.Interfaces;
@using Blazored.Toast.Configuration;
@using BlazorDownloadFile
@using Microsoft.AspNetCore.Html
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.Extensions.Logging
@using System.Reflection;
@using System.Text.Json;
@using Markdig;
@using Microsoft.AspNetCore.Components.Forms
@inject IJSRuntime JsRuntime
@inject StateContainer state
@inject ProtectedSessionStorage session
@inject IToastService toastService
@inject NavigationManager NavigationManager
@inject IHostApplicationLifetime AppLifetime
@inject ProtectedLocalStorage storage
@inject ServicesHelper ServicesHelper
@inject IStorageMigrationService MigrationService

<PageTitle>Azure Naming Tool - Admin</PageTitle>

<div class="modern-page-container">
    <div class="modern-page-title">
        <h1>Admin</h1>
    </div>
    
    <div class="modern-page-description">
        <p>Manage security, configuration, and customization settings</p>
    </div>
    
    @if (admin)
    {
        <div class="modern-page-actions">
            <button class="modern-btn-secondary" title="Instructions" @onclick="@(e => ModalHelper.ShowInformationModal(Modal!, theme, "bg-navcolor", "Admin", String.Empty, "adminconfigurationinstructions", admin))">
                <span class="oi oi-document" aria-hidden="true"></span> Documentation
            </button>
            <button class="modern-btn-secondary" title="Version Information" @onclick="ShowVersionModal">
                <span class="oi oi-info" aria-hidden="true"></span> Version Info
            </button>
        </div>
    }
</div>

<div class="modern-admin-container">
    @if (!admin)
    {
        <!-- Login Card -->
        <div class="modern-card modern-login-card">
            <div class="modern-card-body">
                <div class="login-icon">üîê</div>
                <h3 class="text-center mb-3">Admin Access Required</h3>
                <p class="text-center text-secondary mb-4">
                    Enter the Global Admin Password to configure the Azure Naming Tool site.
                </p>
                <div class="form-group">
                    <label for="password" class="modern-form-label">Global Admin Password</label>
                    <input title="Password" class="modern-form-input" type="password" @onchange="@((ui) => { SetFormValue("login",(string)ui.Value!);})" />
                </div>
                <div class="text-center mt-3">
                    <button type="submit" class="modern-btn-primary" @onclick="@(e => AdminFormAction("login"))" title="Login">Login</button>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Modern Tab Navigation -->
        <div class="modern-tabs-container">
            <div class="modern-tabs">
                @if (((currentuser == "GlobalAdmin") || (showadmindetailstoallusers)) && (GeneralHelper.IsNotNull(environmentvariables)))
                {
                    <button class="modern-tab active" data-tab="tab-system">
                        <span class="oi oi-wrench tab-icon" aria-hidden="true"></span>
                        System
                    </button>
                }
                <button class="modern-tab" data-tab="tab-settings">
                    <span class="oi oi-cog tab-icon" aria-hidden="true"></span>
                    Site Settings
                </button>
                <button class="modern-tab @(((currentuser != "GlobalAdmin") && (!showadmindetailstoallusers)) ? "active" : "")" data-tab="tab-customization">
                    <span class="oi oi-brush tab-icon" aria-hidden="true"></span>
                    Customization
                </button>
                <button class="modern-tab" data-tab="tab-configuration">
                    <span class="oi oi-hard-drive tab-icon" aria-hidden="true"></span>
                    Data
                </button>
                <button class="modern-tab" data-tab="tab-security">
                    <span class="oi oi-lock-locked tab-icon" aria-hidden="true"></span>
                    Security
                </button>
                <button class="modern-tab" data-tab="tab-identity">
                    <span class="oi oi-people tab-icon" aria-hidden="true"></span>
                    Identity Provider
                </button>
            </div>

            <!-- System Details Tab Content -->
            @if (((currentuser == "GlobalAdmin") || (showadmindetailstoallusers)) && (GeneralHelper.IsNotNull(environmentvariables)))
            {
                <div id="tab-system" class="modern-tab-content active">
                    <h3 class="mb-3">System Details</h3>
                    <p class="text-secondary mb-4">
                        View system information, manage cache, and inspect environment variables for the Azure Naming Tool.
                    </p>
                    <!-- View Cache -->
                    <div class="modern-setting-row">
                        <div class="setting-label">View Cache Data</div>
                        <div class="setting-description">
                            View all currently cached data in the application.
                        </div>
                        <div class="setting-actions">
                            <button type="button" class="modern-btn-secondary" @onclick="@(e => AdminFormAction("viewcachedata"))" title="View Cache Data">
                                <span class="oi oi-eye" aria-hidden="true"></span> View Cache
                            </button>
                        </div>
                    </div>

                    <!-- Clear Cache -->
                    <div class="modern-setting-row">
                        <div class="setting-label">Clear Cache</div>
                        <div class="setting-description">
                            Clear all cached data to force a refresh of configuration and resource data.
                        </div>
                        <div class="setting-actions">
                            <button type="button" class="modern-btn-success" @onclick="@(e => AdminFormAction("clearcache"))" title="Clear Cache">
                                <span class="oi oi-trash" aria-hidden="true"></span> Clear Cache
                            </button>
                        </div>
                    </div>

                    <!-- Environment Details -->
                    <div class="modern-setting-row">
                        <div class="setting-label">Environment Variables</div>
                        <div class="setting-description">
                            View system environment variables and configuration details.
                        </div>
                        <div class="mt-3">
                            <ul class="list-unstyled">
                                @foreach (var variable in environmentvariables)
                                {
                                    <li class="mb-2">
                                        <span class="modern-font-semibold">@variable.Key:</span>
                                        <span class="modern-text-secondary">@variable.Value</span>
                                    </li>
                                }
                            </ul>
                        </div>
                    </div>
                </div>
            }

            <!-- Customization Tab Content -->
            <div id="tab-customization" class="modern-tab-content @(((currentuser != "GlobalAdmin") && (!showadmindetailstoallusers)) ? "active" : "")">
                <h3 class="mb-3">Customization</h3>
                <p class="text-secondary mb-4">
                    Customize the Azure Naming Tool site including home content, logo, and navigation links displayed for non-admin users.
                </p>

                <!-- Custom Home Content -->
                <div class="modern-setting-row">
                    <div class="setting-label">Custom Home Content</div>
                    <div class="setting-description">
                        Enter custom <strong>Markdown</strong> content to display on the Home page. This can provide additional information to users.
                    </div>
                    <div class="mt-3">
                        <MarkdownEditor @bind-Value="@customhomecontent" @ref="mdCustomHomeContent" />
                    </div>
                    <div class="setting-actions">
                        <button type="button" class="modern-btn-success" @onclick="@(e => AdminFormAction("customhomecontentsave"))" title="Save Custom Home Content">
                            <span class="oi oi-check" aria-hidden="true"></span> Save
                        </button>
                        <button type="button" class="modern-btn-secondary" @onclick="@(e => AdminFormAction("customhomecontentclear"))" title="Clear Custom Home Content">
                            <span class="oi oi-x" aria-hidden="true"></span> Clear
                        </button>
                    </div>
                </div>

                <!-- Custom Logo -->
                <div class="modern-setting-row">
                    <div class="setting-label">Custom Logo</div>
                    <div class="setting-description">
                        Upload a custom logo for the site. The logo will be displayed in the navigation and home page.
                    </div>
                    @if (!String.IsNullOrEmpty(customlogopath))
                    {
                        <div class="my-3">
                            <img src="@customlogopath" height="100" alt="Custom Logo" class="modern-border modern-rounded p-2" />
                        </div>
                        <div class="setting-actions">
                            <button type="button" class="modern-btn-danger" @onclick="@(e => AdminFormAction("customlogopathclear"))" title="Delete Custom Logo">
                                <span class="oi oi-trash" aria-hidden="true"></span> Delete Logo
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="my-3">
                            <span class="modern-text-secondary fst-italic">No custom logo uploaded.</span>
                        </div>
                    }
                    <div class="mt-3">
                        <label class="modern-form-label">Upload New Logo</label>
                        <InputFile OnChange="UploadLogo" class="modern-form-input" />
                    </div>
                    <div class="modern-notification-info mt-3">
                        <i class="bi bi-info-circle"></i>
                        <div>
                            <strong>Notes:</strong>
                            <ul class="mb-0 mt-2">
                                <li>You may need to refresh the browser for the custom logo to be displayed.</li>
                                <li>If hosting in a container, uploaded logo images will <strong>NOT</strong> be stored in the <strong>/settings</strong> folder and will not be persisted. If the container is recreated, you will need to re-upload the logo file.</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Site Navigation -->
                <div class="modern-setting-row">
                    <div class="setting-label">Site Navigation</div>
                    <div class="setting-description">
                        Configure which navigation links are displayed for non-admin users. Documentation links will always remain visible.
                    </div>
                    
                    <div class="mt-3">
                        <div class="modern-flex modern-flex-column modern-gap-3">
                            <!-- Instructions Toggle -->
                            <div class="modern-toggle-row">
                                <div class="toggle-content">
                                    <div class="toggle-label">Instructions Page</div>
                                    <div class="toggle-description">Enable/Disable the Instructions page for non-admin users</div>
                                </div>
                                <div class="toggle-switch-wrapper">
                                    <label class="modern-toggle-switch" title="Instructions Enabled">
                                        <input type="checkbox" checked="@instructionsenabled" @oninput='args => SettingChanged(args, "instructionsenabled")'>
                                        <span class="modern-toggle-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <!-- Configuration Toggle -->
                            <div class="modern-toggle-row">
                                <div class="toggle-content">
                                    <div class="toggle-label">Configuration Page</div>
                                    <div class="toggle-description">Enable/Disable the Configuration page for non-admin users</div>
                                </div>
                                <div class="toggle-switch-wrapper">
                                    <label class="modern-toggle-switch" title="Configuration Enabled">
                                        <input type="checkbox" checked="@configurationenabled" @oninput='args => SettingChanged(args, "configurationenabled")'>
                                        <span class="modern-toggle-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <!-- Reference Toggle -->
                            <div class="modern-toggle-row">
                                <div class="toggle-content">
                                    <div class="toggle-label">Reference Page</div>
                                    <div class="toggle-description">Enable/Disable the Reference page for non-admin users</div>
                                </div>
                                <div class="toggle-switch-wrapper">
                                    <label class="modern-toggle-switch" title="Reference Enabled">
                                        <input type="checkbox" checked="@referenceenabled" @oninput='args => SettingChanged(args, "referenceenabled")'>
                                        <span class="modern-toggle-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <!-- Generated Names Log Toggle -->
                            <div class="modern-toggle-row">
                                <div class="toggle-content">
                                    <div class="toggle-label">Generated Names Log</div>
                                    <div class="toggle-description">Enable/Disable the Generated Names Log page for non-admin users</div>
                                </div>
                                <div class="toggle-switch-wrapper">
                                    <label class="modern-toggle-switch" title="Generated Names Log Enabled">
                                        <input type="checkbox" checked="@generatednameslogenabled" @oninput='args => SettingChanged(args, "generatednameslogenabled")'>
                                        <span class="modern-toggle-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <!-- Latest News Toggle -->
                            <div class="modern-toggle-row">
                                <div class="toggle-content">
                                    <div class="toggle-label">Latest News</div>
                                    <div class="toggle-description">Enable/Disable the Latest News for all users</div>
                                </div>
                                <div class="toggle-switch-wrapper">
                                    <label class="modern-toggle-switch" title="Latest News Enabled">
                                        <input type="checkbox" checked="@latestnewsenabled" @oninput='args => SettingChanged(args, "latestnewsenabled")'>
                                        <span class="modern-toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        <!-- Site Settings Tab Content -->
        <div id="tab-settings" class="modern-tab-content">
            <h3 class="mb-3">Site Settings</h3>
            <p class="text-secondary mb-4">
                Configure general site settings including duplicate name handling, resource type editing, and webhooks for the Azure Naming Tool.
            </p>

            <!-- Allow Duplicate Names -->
                <div class="modern-toggle-row">
                    <div class="toggle-content">
                        <div class="toggle-label">Allow Duplicate Names</div>
                        <div class="toggle-description">
                            By default, the Azure Naming Tool prevents duplicate resource names from being generated. Enable this setting to allow duplicate names.
                        </div>
                    </div>
                    <div class="toggle-switch-wrapper">
                        <label class="modern-toggle-switch" title="Duplicate Names Allowed">
                            <input type="checkbox" checked="@duplicatenamesallowed" @oninput='args => SettingChanged(args, "duplicatenamesallowed")'>
                            <span class="modern-toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Auto-Increment Resource Instance -->
                <div class="modern-toggle-row">
                    <div class="toggle-content">
                        <div class="toggle-label">Auto-Increment Resource Instance</div>
                        <div class="toggle-description">
                            If enabled, this setting will increment the <strong>Resource Instance</strong> value to the next number for the generated resource type name.
                        </div>
                    </div>
                    <div class="toggle-switch-wrapper">
                        <label class="modern-toggle-switch" title="Auto-Increment Resource Instance">
                            <input type="checkbox" checked="@autoincrementresourceinstance" @oninput='args => SettingChanged(args, "autoincrementresourceinstance")'>
                            <span class="modern-toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Resource Type Editing -->
                <div class="modern-toggle-row">
                    <div class="toggle-content">
                        <div class="toggle-label">Resource Type Editing</div>
                        <div class="toggle-description">
                            By default, <strong>Resource Type Validation</strong> is configured to match the Azure portal. These values can be overridden by enabling this setting.
                        </div>
                        <div class="modern-notification-warning mt-2">
                            <i class="bi bi-exclamation-triangle"></i>
                            <div>
                                <strong>ATTENTION</strong><br />
                                Please see the <a href="https://github.com/mspnp/AzureNamingTool/wiki/Resource-Type-Editing" target="_blank" class="alert-link">Resource Type Editing documentation</a> for guidance on metadata editing.
                            </div>
                        </div>
                    </div>
                    <div class="toggle-switch-wrapper">
                        <label class="modern-toggle-switch" title="Resource Type Editing Enabled">
                            <input type="checkbox" checked="@resourcetypeeditingallowed" @oninput='args => SettingChanged(args, "resourcetypeeditingallowed")'>
                            <span class="modern-toggle-slider"></span>
                        </label>
                    </div>
                </div>

                @if (currentuser == "GlobalAdmin")
                {
                    <!-- Show Admin Data To All Users (GlobalAdmin only) -->
                    <div class="modern-toggle-row">
                        <div class="toggle-content">
                            <div class="toggle-label">Show Admin Data To All Users</div>
                            <div class="toggle-description">
                                By default, admin details are only displayed for the Global Admin. This setting enables admin details to be shown to all admin users.
                            </div>
                        </div>
                        <div class="toggle-switch-wrapper">
                            <label class="modern-toggle-switch" title="Show Admin Details To All Users">
                                <input type="checkbox" checked="@showadmindetailstoallusers" @oninput='args => SettingChanged(args, "showadmindetailstoallusers")'>
                                <span class="modern-toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                }

                <!-- Connectivity Check -->
                <div class="modern-toggle-row">
                    <div class="toggle-content">
                        <div class="toggle-label">Connectivity Check</div>
                        <div class="toggle-description">
                            The Azure Naming Tool will verify the tool has internet connectivity to enable update features. Use this setting to disable the connectivity check functionality.
                        </div>
                    </div>
                    <div class="toggle-switch-wrapper">
                        <label class="modern-toggle-switch" title="Connectivity Check Enabled">
                            <input type="checkbox" checked="@connectivitycheckenabled" @oninput='args => SettingChanged(args, "connectivitycheckenabled")'>
                            <span class="modern-toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Azure Tenant Name Validation -->
                <div class="modern-toggle-row">
                    <div class="toggle-content">
                        <div class="toggle-label">Azure Tenant Name Validation</div>
                        <div class="toggle-description">
                            @if (!isUsingSQLite)
                            {
                                <div class="modern-notification-warning mb-2">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    <div>
                                        <strong>SQLite Required</strong><br />
                                        Azure Tenant Name Validation requires SQLite storage. Migrate to SQLite to enable this feature.
                                    </div>
                                </div>
                            }
                            else
                            {
                                <span>Enable validation of generated names against your Azure tenant to check if a resource name already exists. Configure authentication, conflict resolution, and caching options below.</span>
                            }
                        </div>
                    </div>
                    <div class="toggle-switch-wrapper">
                        <label class="modern-toggle-switch" title="@(isUsingSQLite ? "Azure Tenant Name Validation Enabled" : "Requires SQLite storage")">
                            <input type="checkbox" checked="@azuretenantamevalidationenabled" @oninput='args => SettingChanged(args, "azuretenantamevalidationenabled")' disabled="@(!isUsingSQLite)">
                            <span class="modern-toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Azure Validation Configuration (shown when enabled) -->
                @if (azuretenantamevalidationenabled)
                {
                    <div class="ms-4 mb-4 border-start border-3 border-primary ps-4">
                        
                        <!-- Getting Started Instructions -->
                        <div class="modern-notification-info mb-4">
                            <i class="bi bi-info-circle"></i>
                            <div>
                                <strong>Getting Started with Azure Validation</strong>
                                <ol class="mb-0 mt-2 ps-3">
                                    <li><strong>Choose Authentication Mode</strong> - Managed Identity (recommended for Azure) or Service Principal</li>
                                    <li><strong>Test Connection</strong> - Verify authentication and discover accessible subscriptions</li>
                                    <li><strong>Select Subscriptions</strong> - Choose which subscriptions to validate against (optional)</li>
                                    <li><strong>Select Conflict Strategy</strong> - Choose how to handle existing resource names</li>
                                    <li><strong>Save Settings</strong> - Click the save button at the bottom</li>
                                </ol>
                                <div class="mt-3">
                                    <strong>Required Azure Permissions:</strong>
                                    <ul class="mb-0 mt-2 ps-3">
                                        <li><strong>Reader</strong> role on subscriptions</li>
                                        <li><strong>Resource Graph</strong> access for scoped validation</li>
                                    </ul>
                                </div>
                                <div class="mt-3">
                                    <a href="https://github.com/mspnp/AzureNamingTool/wiki/Azure-Validation" target="_blank" class="text-primary">
                                        <strong>Full Documentation ‚Üí</strong>
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Authentication Mode -->
                        <div class="mb-4">
                            <h6 class="fw-bold">Authentication Mode</h6>
                            <div class="modern-notification-info mb-3">
                                <i class="bi bi-info-circle"></i>
                                <div>
                                    <strong>Managed Identity</strong> - Recommended for Azure-hosted deployments<br />
                                    <strong>Service Principal</strong> - Use when Managed Identity is not available
                                </div>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="authMode" id="authModeManagedIdentity" value="ManagedIdentity" checked="@(azureAuthMode == "ManagedIdentity")" @onchange="@(() => azureAuthMode = "ManagedIdentity")">
                                <label class="form-check-label" for="authModeManagedIdentity">
                                    <strong>Managed Identity</strong> (Recommended)
                                </label>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="radio" name="authMode" id="authModeServicePrincipal" value="ServicePrincipal" checked="@(azureAuthMode == "ServicePrincipal")" @onchange="@(() => azureAuthMode = "ServicePrincipal")">
                                <label class="form-check-label" for="authModeServicePrincipal">
                                    <strong>Service Principal</strong>
                                </label>
                            </div>

                            @if (azureAuthMode == "ServicePrincipal")
                            {
                                <div class="mt-3">
                                    <div class="modern-notification-warning mb-3">
                                        <i class="bi bi-exclamation-triangle"></i>
                                        <div>
                                            Configure Service Principal credentials in <code>settings/azurevalidationsettings.json</code> or use Azure Key Vault.
                                        </div>
                                    </div>
                                    <label class="modern-form-label">Tenant ID</label>
                                    <input type="text" class="modern-form-input mb-3" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" value="@azureTenantId" @oninput="@((e) => azureTenantId = e.Value?.ToString() ?? "")" />
                                    
                                    <label class="modern-form-label">Client ID</label>
                                    <input type="text" class="modern-form-input mb-3" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" value="@azureClientId" @oninput="@((e) => azureClientId = e.Value?.ToString() ?? "")" />
                                    
                                    <small class="text-muted"><i class="bi bi-shield-lock"></i> Client Secret should be stored in Azure Key Vault or configuration file.</small>
                                </div>
                            }
                        </div>

                        <!-- Connection Status -->
                        <div class="mb-4">
                            <h6 class="fw-bold">Connection Status</h6>
                            @if (azureConnectionTested)
                            {
                                @if (azureConnectionSuccess)
                                {
                                    <div class="modern-notification-success">
                                        <i class="bi bi-check-circle"></i>
                                        <div>
                                            <strong>‚úì Connected to Azure</strong><br />
                                            Authentication: @azureConnectionDetails<br />
                                            @if (!string.IsNullOrEmpty(azureTenantInfo))
                                            {
                                                <span>Tenant: @azureTenantInfo</span><br />
                                            }
                                            @if (azureSubscriptionCount > 0)
                                            {
                                                <span>Accessible Subscriptions: @azureSubscriptionCount</span>
                                            }
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <div class="modern-notification-danger">
                                        <i class="bi bi-x-circle"></i>
                                        <div>
                                            <strong>‚úó Connection Failed</strong><br />
                                            @azureConnectionError
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="modern-notification-info">
                                    <i class="bi bi-info-circle"></i>
                                    <div>
                                        Click <strong>Test Connection</strong> to verify Azure authentication and permissions.
                                    </div>
                                </div>
                            }
                            <div class="mt-3">
                                <button type="button" class="modern-btn-primary" @onclick="TestAzureConnection" disabled="@testingConnection" title="Test Azure Connection">
                                    @if (testingConnection)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                        <span>Testing...</span>
                                    }
                                    else
                                    {
                                        <span class="oi oi-wifi" aria-hidden="true"></span>
                                        <span>Test Connection</span>
                                    }
                                </button>
                            </div>
                        </div>

                        <!-- Subscription Configuration -->
                        <div class="mb-4">
                            <h6 class="fw-bold">Subscription Scope</h6>
                            <p class="text-muted small">Select which Azure subscriptions to check for existing resources. Leave all unchecked to query all accessible subscriptions.</p>
                            
                            @if (azureConnectionSuccess && availableSubscriptions.Any())
                            {
                                <div class="subscription-list">
                                    @foreach (var sub in availableSubscriptions)
                                    {
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" 
                                                   id="sub_@sub.SubscriptionId" 
                                                   checked="@selectedSubscriptionIds.Contains(sub.SubscriptionId)"
                                                   @onchange="@(e => ToggleSubscription(sub.SubscriptionId, (bool)e.Value!))">
                                            <label class="form-check-label" for="sub_@sub.SubscriptionId">
                                                <strong>@sub.DisplayName</strong><br/>
                                                <small class="text-muted">@sub.SubscriptionId @(sub.State != "Unknown" ? $"({sub.State})" : "(Previously Saved)")</small>
                                            </label>
                                        </div>
                                    }
                                </div>
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> @selectedSubscriptionIds.Count subscription(s) selected. 
                                    @if (availableSubscriptions.Any(s => s.State == "Unknown"))
                                    {
                                        <span>Click "Test Connection" to verify subscription access. </span>
                                    }
                                    If none are selected, all accessible subscriptions will be queried.
                                </small>
                            }
                            else if (azureConnectionTested && !azureConnectionSuccess)
                            {
                                <p class="text-warning"><i class="bi bi-exclamation-triangle"></i> Connection test failed. Please verify authentication settings and test connection again.</p>
                            }
                            else
                            {
                                <p class="text-muted"><i class="bi bi-arrow-up"></i> Test connection above to see available subscriptions</p>
                            }
                        </div>

                        <!-- Conflict Resolution Strategy -->
                        <div class="mb-4">
                            <h6 class="fw-bold">Conflict Resolution Strategy</h6>
                            <p class="text-muted small">Choose how to handle conflicts when a name already exists in Azure.</p>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="conflictStrategy" id="strategyNotifyOnly" value="NotifyOnly" checked="@(azureConflictStrategy == "NotifyOnly")" @onchange="@(() => azureConflictStrategy = "NotifyOnly")">
                                <label class="form-check-label" for="strategyNotifyOnly">
                                    <strong>Notify Only</strong> (Recommended)<br />
                                    <small class="text-muted">Show warning but keep original name. Works with all naming conventions.</small>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="conflictStrategy" id="strategyAutoIncrement" value="AutoIncrement" checked="@(azureConflictStrategy == "AutoIncrement")" @onchange="@(() => azureConflictStrategy = "AutoIncrement")">
                                <label class="form-check-label" for="strategyAutoIncrement">
                                    <strong>Auto-Increment</strong><br />
                                    <small class="text-muted">Example: vnet-001 ‚Üí vnet-002</small><br />
                                    <small style="color: #d97706;">‚ö†Ô∏è Requires instance component (e.g., -001) in your naming convention</small>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="conflictStrategy" id="strategyFail" value="Fail" checked="@(azureConflictStrategy == "Fail")" @onchange="@(() => azureConflictStrategy = "Fail")">
                                <label class="form-check-label" for="strategyFail">
                                    <strong>Fail</strong><br />
                                    <small class="text-muted">Reject generation with error. Forces manual resolution.</small>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="conflictStrategy" id="strategySuffixRandom" value="SuffixRandom" checked="@(azureConflictStrategy == "SuffixRandom")" @onchange="@(() => azureConflictStrategy = "SuffixRandom")">
                                <label class="form-check-label" for="strategySuffixRandom">
                                    <strong>Suffix Random</strong><br />
                                    <small class="text-muted">Example: vnet-001-a1b2c3</small>
                                </label>
                            </div>
                        </div>

                        <!-- Cache Settings -->
                        <div class="mb-4">
                            <h6 class="fw-bold">Cache Settings</h6>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="azureCacheEnabled" checked="@azureCacheEnabled" @onchange="@((e) => azureCacheEnabled = (bool)(e.Value ?? false))">
                                <label class="form-check-label" for="azureCacheEnabled">
                                    <strong>Enable Validation Cache</strong><br />
                                    <small class="text-muted">Cache validation results to reduce Azure API calls</small>
                                </label>
                            </div>
                            @if (azureCacheEnabled)
                            {
                                <label class="modern-form-label">Cache Duration (minutes)</label>
                                <input type="number" class="modern-form-input" min="1" max="60" value="@azureCacheDuration" @oninput="@((e) => azureCacheDuration = int.TryParse(e.Value?.ToString(), out int val) ? val : 5)" />
                                <small class="text-muted">Default: 5 minutes</small>
                            }
                        </div>

                        <!-- Save Button -->
                        <div class="mb-4">
                            <button type="button" class="modern-btn-success" @onclick="SaveAzureValidationSettings" title="Save Azure Validation Settings">
                                <span class="oi oi-check" aria-hidden="true"></span> Save Azure Validation Settings
                            </button>
                        </div>
                    </div>
                }

                <!-- Generation Webhook -->
                <div class="modern-setting-row">
                    <div class="setting-label">Generation Webhook</div>
                    <div class="setting-description">
                        The Azure Naming Tool can post generated names to a webhook. This can be used to integrate with other systems. Enter a valid URL below to save the webhook setting.
                    </div>
                    <div class="mt-3">
                        <p class="text-secondary">
                            Generated names will be posted using the <strong><a href="https://github.com/mspnp/AzureNamingTool/blob/main/src/Models/GeneratedName.cs" target="_blank">GeneratedName</a></strong> JSON format.
                        </p>
                        <button type="button" class="modern-btn-secondary mb-3" @onclick="@(e => AdminFormAction("samplepost"))" title="Sample Post">
                            <span class="oi oi-beaker" aria-hidden="true"></span> Sample Post
                        </button>
                    </div>
                    <div class="mt-3">
                        <label class="modern-form-label">Webhook URL</label>
                        <input title="Generation Webhook" id="currentgenerationwebhook" class="modern-form-input" type="text" @onchange="@((ui) => { SetFormValue("generationwebhook",(string)ui.Value!);})" value="@currentgenerationwebhook" />
                    </div>
                    <div class="setting-actions">
                        <button type="button" class="modern-btn-success" @onclick="@(e => AdminFormAction("generationwebhooksave"))" title="Save Generate Webhook">
                            <span class="oi oi-check" aria-hidden="true"></span> Save
                        </button>
                    </div>
                </div>

                <!-- Reset Site Settings -->
                <div class="modern-setting-row">
                    <div class="setting-label">Reset Site Settings</div>
                    <div class="setting-description">
                        This will reset <strong>ALL</strong> site settings to the default values. This includes site settings and customizations. This cannot be undone!
                    </div>
                    <div class="setting-actions">
                        <button type="button" class="modern-btn-danger" @onclick="@(e => AdminFormAction("resetsitesettings"))" title="Reset Site Settings">
                            <span class="oi oi-warning" aria-hidden="true"></span> Reset Site Settings
                        </button>
                    </div>
                </div>
            </div>

            <!-- Security Tab Content -->
            <div id="tab-security" class="modern-tab-content">
                <h3 class="mb-3">Security</h3>
                <p class="text-secondary mb-4">
                    Manage security settings including the Global Admin password, API keys, identity headers, and admin users for the Azure Naming Tool.
                </p>
                
                @if (currentuser == "GlobalAdmin")
                {
                    <!-- Global Admin Password -->
                    <div class="modern-setting-row">
                        <div class="setting-label">Global Admin Password</div>
                        <div class="setting-description">
                            Enter a new <strong>Global Admin</strong> password for the site.
                        </div>
                        <div class="modern-notification-info mt-3">
                            <i class="bi bi-info-circle"></i>
                            <div>
                                <strong>Password Requirements:</strong>
                                <ul class="mb-0 mt-2">
                                    <li>Contain a number</li>
                                    <li>Contain one upper case letter</li>
                                    <li>Be at least 8 characters</li>
                                </ul>
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="modern-form-label">New Password</label>
                            <input title="New Password" id="newpassword" class="modern-form-input mb-3" type="password" @onchange="@((ui) => { SetFormValue("password",(string)ui.Value!);})" />
                        </div>
                        <div class="setting-actions">
                            <button title="Save Password" type="button" disabled="@disabled" class="modern-btn-success" @onclick="@(e => AdminFormAction("password"))">
                                <span class="oi oi-check" aria-hidden="true"></span> Save Password
                            </button>
                        </div>
                    </div>

                    <!-- API Keys -->
                    <div class="modern-setting-row">
                        <div class="setting-label">API Keys</div>
                        <div class="setting-description">
                            Manage API keys for accessing the Azure Naming Tool API. Three types of keys are available: Full Access, Name Generation, and Read-Only.
                        </div>

                        <!-- Full Access API Key -->
                        <div class="mt-3 p-3 modern-border modern-rounded">
                            <h6 class="modern-font-semibold">Full Access API Key</h6>
                            <p class="modern-text-secondary">
                                This key provides <strong>full access</strong> to the API. Click <strong>Generate</strong> to create a new random key, or update the text to the desired value.
                            </p>
                            <div class="mb-3">
                                <label class="modern-form-label">API Key</label>
                                <input title="Full Access API Key" id="currentapikey" class="modern-form-input mb-3" type="text" @onchange="@((ui) => { SetFormValue("apikey",(string)ui.Value!);})" value="@currentapikey" />
                            </div>
                            <div class="modern-flex modern-gap-2">
                                <button type="button" class="modern-btn-success" @onclick="@(e => AdminFormAction("apikeysave"))" title="Save Full Access API Key">
                                    <span class="oi oi-check" aria-hidden="true"></span> Save
                                </button>
                                <button type="button" class="modern-btn-secondary" @onclick="@(e => AdminFormAction("apikeygenerate"))" title="Generate Full Access API Key">
                                    <span class="oi oi-reload" aria-hidden="true"></span> Generate
                                </button>
                            </div>
                        </div>

                        <!-- Name Generation API Key -->
                        <div class="mt-3 p-3 modern-border modern-rounded">
                            <h6 class="modern-font-semibold">Name Generation API Key</h6>
                            <p class="modern-text-secondary">
                                This key provides <strong>Name Generation</strong> access to the API (only for name generation). Click <strong>Generate</strong> to create a new random key, or update the text to the desired value.
                            </p>
                            <div class="mb-3">
                                <label class="modern-form-label">API Key</label>
                                <input title="Name Generation API Key" id="currentnamegenerationapikey" class="modern-form-input mb-3" type="text" @onchange="@((ui) => { SetFormValue("namegenerationapikey",(string)ui.Value!);})" value="@currentnamegenerationapikey" />
                            </div>
                            <div class="modern-flex modern-gap-2">
                                <button type="button" class="modern-btn-success" @onclick="@(e => AdminFormAction("namegenerationapikeysave"))" title="Save Name Generation API Key">
                                    <span class="oi oi-check" aria-hidden="true"></span> Save
                                </button>
                                <button type="button" class="modern-btn-secondary" @onclick="@(e => AdminFormAction("namegenerationapikeygenerate"))" title="Generate Name Generation API Key">
                                    <span class="oi oi-reload" aria-hidden="true"></span> Generate
                                </button>
                            </div>
                        </div>

                        <!-- Read-Only API Key -->
                        <div class="mt-3 p-3 modern-border modern-rounded">
                            <h6 class="modern-font-semibold">Read-Only API Key</h6>
                            <p class="modern-text-secondary">
                                This key provides <strong>read-only</strong> access to the API (GET operations only). Click <strong>Generate</strong> to create a new random key, or update the text to the desired value.
                            </p>
                            <div class="mb-3">
                                <label class="modern-form-label">API Key</label>
                                <input title="Read-Only API Key" id="currentreadonlyapikey" class="modern-form-input mb-3" type="text" @onchange="@((ui) => { SetFormValue("readonlyapikey",(string)ui.Value!);})" value="@currentreadonlyapikey" />
                            </div>
                            <div class="modern-flex modern-gap-2">
                                <button type="button" class="modern-btn-success" @onclick="@(e => AdminFormAction("readonlyapikeysave"))" title="Save Read-Only API Key">
                                    <span class="oi oi-check" aria-hidden="true"></span> Save
                                </button>
                                <button type="button" class="modern-btn-secondary" @onclick="@(e => AdminFormAction("readonlyapikeygenerate"))" title="Generate Read-Only API Key">
                                    <span class="oi oi-reload" aria-hidden="true"></span> Generate
                                </button>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="modern-notification-info">
                        <i class="bi bi-info-circle"></i>
                        <div>
                            <span class="fst-italic">Only the Global Admin can perform this action. Please logout and login with the Global Admin password to access this feature.</span>
                        </div>
                    </div>
                }
            </div>

            <!-- Configuration Tab Content -->
            <div id="tab-configuration" class="modern-tab-content">
                <h3 class="mb-3">Configuration Management</h3>
                <p class="text-secondary mb-4">
                    Backup, restore, and manage your Azure Naming Tool configuration data. Configure storage provider and data management options.
                </p>

                <!-- Storage Provider -->
                <div class="modern-setting-row">
                    <div class="mt-3">
                        <h6><i class="bi bi-info-circle"></i> Current Provider</h6>
                        <div class="@(currentStorageProvider == "SQLite" ? "modern-notification-success" : "modern-notification-info")">
                            <strong>@currentStorageProvider</strong>
                            @if (currentStorageProvider == "SQLite")
                            {
                                <span class="ms-2"><i class="bi bi-check-circle"></i> Using SQLite database</span>
                            }
                            else
                            {
                                <span class="ms-2"><i class="bi bi-file-earmark-text"></i> Using JSON files</span>
                            }
                        </div>
                    </div>

                    @if (currentStorageProvider == "FileSystem")
                    {
                        <div class="mt-3">
                            <h6><i class="bi bi-arrow-up-circle"></i> Upgrade to SQLite</h6>
                            <p>
                                Migrate your configuration data from JSON files to an embedded SQLite database for improved performance and reliability.
                            </p>
                            
                            @if (!preMigrationBackupCompleted)
                            {
                                <div class="modern-notification-warning">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    <div>
                                        <strong>Step 1: Backup Required</strong><br />
                                        Before migrating to SQLite, you must create a backup of your current configuration. This backup will allow you to restore your data if needed.
                                    </div>
                                </div>
                                <button type="button" class="modern-btn-primary" @onclick="@(e => CreatePreMigrationBackup())" title="Create Backup">
                                    <i class="bi bi-download"></i>
                                    <span>Create Backup (Step 1)</span>
                                </button>
                            }
                            else
                            {
                                <div class="modern-notification-success">
                                    <i class="bi bi-check-circle"></i>
                                    <div>
                                        <strong>Backup Complete!</strong><br />
                                        Backup file: <code>@preMigrationBackupFileName</code><br />
                                        You can now proceed with the migration.
                                    </div>
                                </div>
                                
                                <div class="modern-notification-danger mt-3">
                                    <i class="bi bi-exclamation-triangle-fill"></i>
                                    <strong>IMPORTANT: Migration is one-way only!</strong>
                                    <ul class="mb-0 mt-2">
                                        <li>This migration cannot be automatically reversed</li>
                                        <li>Your JSON files will be preserved for manual restoration if needed</li>
                                        <li>After migration, use the Configuration page to create SQLite backups</li>
                                        <li>The application will restart after migration</li>
                                    </ul>
                                </div>
                                
                                <button type="button" class="modern-btn-warning" @onclick="@(e => InitiateMigration())" disabled="@isMigrating" title="Migrate to SQLite">
                                    @if (isMigrating)
                                    {
                                        <span class="modern-spinner-small me-2" role="status" aria-hidden="true"></span>
                                        <span>Migrating...</span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-database-gear"></i>
                                        <span>Migrate to SQLite (Step 2)</span>
                                    }
                                </button>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="mt-3">
                            <h6><i class="bi bi-check-circle text-success"></i> SQLite Storage Active</h6>
                            <p>
                                Your configuration is stored in an embedded SQLite database.
                            </p>
                            <div class="modern-notification-info">
                                <i class="bi bi-info-circle"></i>
                                <div>
                                    <strong>Backup & Restore:</strong> Use the backup options below to backup and restore your SQLite database or import/export JSON configurations.
                                </div>
                            </div>
                        </div>
                    }

                    @if (!String.IsNullOrEmpty(migrationErrorMessage))
                    {
                        <div class="modern-notification-danger mt-3">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            <div>
                                <strong>Error:</strong> @migrationErrorMessage
                            </div>
                        </div>
                    }
                </div>

                @if (isUsingSQLite)
                {
                    <!-- SQLite Backup Options -->
                    <div class="modern-setting-row">
                        <div class="setting-label">
                            <i class="bi bi-download"></i> Backup Options
                        </div>
                        <div class="setting-description">
                            Create backups of your configuration data for disaster recovery or migration purposes.
                        </div>
                        
                        <div class="mt-3">
                            <div class="modern-notification-info mb-3">
                                <i class="bi bi-info-circle"></i>
                                <div>
                                    <strong>SQLite Storage Active</strong><br />
                                    You can backup your data as a database file or export as JSON for portability.
                                </div>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="modern-action-card">
                                        <div class="action-card-icon">
                                            <i class="bi bi-database"></i>
                                        </div>
                                        <div class="action-card-content">
                                            <h6 class="action-card-title">Download Database File</h6>
                                            <p class="action-card-description">
                                                Download the complete SQLite database file (azurenamingtool.db) for backup purposes.
                                            </p>
                                            <p class="action-card-use-case">
                                                <strong>When to use:</strong> For routine backups and quick disaster recovery.
                                            </p>
                                            <button type="button" class="modern-btn-primary" @onclick="DownloadDatabaseFile" title="Download Database">
                                                <i class="bi bi-download"></i> Download Database
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="modern-action-card">
                                        <div class="action-card-icon">
                                            <i class="bi bi-file-earmark-code"></i>
                                        </div>
                                        <div class="action-card-content">
                                            <h6 class="action-card-title">Export as JSON</h6>
                                            <p class="action-card-description">
                                                Export all configuration data as JSON format for portability and version control.
                                            </p>
                                            <p class="action-card-use-case">
                                                <strong>When to use:</strong> For sharing configurations or migrating between instances.
                                            </p>
                                            <button type="button" class="modern-btn-primary" @onclick="ExportConfigurationAsJson" title="Export JSON">
                                                <i class="bi bi-file-earmark-arrow-down"></i> Export JSON
                                            </button>
                                            @if (currentuser == "GlobalAdmin")
                                            {
                                                <div class="modern-checkbox-wrapper mt-2">
                                                    <input id="includeAdminExport" title="Include Security/Identity Provider Settings" class="modern-checkbox" type="checkbox" @bind="@includeAdmin">
                                                    <label for="includeAdminExport" class="modern-checkbox-label">
                                                        Include Security/Identity Provider Settings
                                                    </label>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SQLite Restore Options -->
                    <div class="modern-setting-row">
                        <div class="setting-label">
                            <i class="bi bi-arrow-counterclockwise"></i> Restore Options
                        </div>
                        <div class="setting-description">
                            Restore your configuration from a previous backup. This will replace your current data.
                        </div>
                        
                        <div class="mt-3">
                            <div class="modern-notification-danger mb-3">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                                <strong>WARNING:</strong> Restore operations will replace your current configuration data. This action cannot be undone. Always create a backup before restoring.
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="modern-action-card">
                                        <div class="action-card-icon">
                                            <i class="bi bi-database-fill-up"></i>
                                        </div>
                                        <div class="action-card-content">
                                            <h6 class="action-card-title">Restore from Database File</h6>
                                            <p class="action-card-description">
                                                Upload and replace the current database with a previously downloaded SQLite database file.
                                            </p>
                                            <p class="action-card-use-case">
                                                <strong>Use case:</strong> Disaster recovery or reverting to a previous backup.
                                            </p>
                                            <div class="mt-2">
                                                <label class="modern-form-label">Select Database File (.db)</label>
                                                <InputFile OnChange="HandleSQLiteDatabaseUpload" accept=".db" class="modern-form-input" />
                                            </div>
                                            @if (sqliteBackupFile != null)
                                            {
                                                <div class="modern-notification-success mt-2">
                                                    <strong>Selected:</strong> @sqliteBackupFile.Name (@FormatFileSize(sqliteBackupFile.Size))
                                                </div>
                                                <button type="button" class="modern-btn-warning mt-2" @onclick="RestoreFromSQLiteBackup" title="Restore Database">
                                                    <i class="bi bi-arrow-counterclockwise"></i> Restore Database
                                                </button>
                                            }
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="modern-action-card">
                                        <div class="action-card-icon">
                                            <i class="bi bi-file-earmark-arrow-up"></i>
                                        </div>
                                        <div class="action-card-content">
                                            <h6 class="action-card-title">Restore from JSON File</h6>
                                            <p class="action-card-description">
                                                Import configuration data from a JSON backup file. Works with both pre-migration and post-migration JSON exports.
                                            </p>
                                            <p class="action-card-use-case">
                                                <strong>Use case:</strong> Importing configurations from another instance or pre-migration backups.
                                            </p>
                                            <div class="mt-2">
                                                <label class="modern-form-label">Select JSON File (.json)</label>
                                                <InputFile OnChange="HandleJsonConfigUpload" accept=".json" class="modern-form-input" />
                                            </div>
                                            @if (jsonBackupFile != null)
                                            {
                                                <div class="modern-notification-success mt-2">
                                                    <strong>Selected:</strong> @jsonBackupFile.Name (@FormatFileSize(jsonBackupFile.Size))
                                                </div>
                                                <button type="button" class="modern-btn-warning mt-2" @onclick="RestoreFromJsonBackup" title="Restore from JSON">
                                                    <i class="bi bi-arrow-counterclockwise"></i> Restore from JSON
                                                </button>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <!-- FileSystem Export -->
                    <div class="modern-setting-row">
                        <div class="setting-label">
                            <i class="bi bi-download"></i> Export Configuration
                        </div>
                        <div class="setting-description">
                            Export your current Global Configuration as JSON. This includes all components, options, and tool settings.
                        </div>
                        
                        <div class="mt-3">
                            <div class="modern-notification-info mb-3">
                                <i class="bi bi-info-circle"></i>
                                <div>
                                    <strong>FileSystem Storage Active</strong><br />
                                    Your configuration is stored in JSON files. Use this option to create a backup or share your configuration.
                                </div>
                            </div>

                            <button type="button" class="modern-btn-primary" @onclick="@(e => FormAction("Global",0,"download"))" title="Export">
                                <i class="bi bi-file-earmark-arrow-down"></i> Export Configuration
                            </button>
                            @if (currentuser == "GlobalAdmin")
                            {
                                <div class="modern-checkbox-wrapper mt-2">
                                    <input id="includeAdminExportFS" title="Include Security/Identity Provider Settings" class="modern-checkbox" type="checkbox" @bind="@includeAdmin">
                                    <label for="includeAdminExportFS" class="modern-checkbox-label">
                                        Include Security/Identity Provider Settings
                                    </label>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- FileSystem Import -->
                    <div class="modern-setting-row">
                        <div class="setting-label">
                            <i class="bi bi-upload"></i> Import Configuration
                        </div>
                        <div class="setting-description">
                            Import a Global Configuration from JSON. This will update all existing configurations.
                        </div>
                        
                        <div class="mt-3">
                            <div class="modern-notification-danger mb-3">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                                <div>
                                    <strong>WARNING:</strong> This will overwrite your current configuration data and cannot be undone. Create a backup before proceeding.
                                </div>
                            </div>
                            
                            <label class="modern-form-label">Configuration JSON</label>
                            <textarea title="Configuration" class="modern-form-textarea" rows="8" type="text" @onchange="@((ui) => { SetFormValue("newGlobalConfig",(string)ui.Value!);})" />
                            <button type="button" class="modern-btn-success mt-2" @onclick="@(e => FormAction("Global",0,"update"))" title="Import">
                                <i class="bi bi-file-earmark-arrow-up"></i> Import Configuration
                            </button>
                        </div>
                    </div>
                }

                <!-- Individual Component Import/Export - Available for all storage types -->
                <div class="modern-setting-row">
                    <div class="setting-label">
                        <i class="bi bi-box-arrow-in-down"></i> Individual Component Import/Export
                    </div>
                    <div class="setting-description">
                        Export or import individual component type configurations. This allows you to share specific component data between instances.
                    </div>
                    
                    <div class="mt-3">
                        <div class="modern-notification-info mb-3">
                            <i class="bi bi-info-circle"></i>
                            <div>
                                <strong>Component-Level Management</strong><br />
                                Select a component type below to export its current data or import new data. This is useful for sharing configurations between instances or creating backups of specific components.
                            </div>
                        </div>

                        <!-- Component Type Selection -->
                        <div class="mb-3">
                            <label class="modern-form-label">Select Component Type</label>
                            <select class="modern-form-input" @onchange="@((ChangeEventArgs e) => OnComponentTypeSelected(e.Value?.ToString() ?? ""))">
                                <option value="">-- Select a component type --</option>
                                <option value="ResourceType">Resource Types</option>
                                <option value="ResourceLocation">Locations</option>
                                <option value="ResourceEnvironment">Environments</option>
                                <option value="ResourceOrg">Organizations</option>
                                <option value="ResourceProjAppSvc">Projects/Apps/Services</option>
                                <option value="ResourceUnitDept">Units/Departments</option>
                                <option value="ResourceFunction">Functions</option>
                                <option value="ResourceDelimiter">Delimiters</option>
                                <option value="CustomComponent">Custom Components</option>
                            </select>
                        </div>

                        @if (!String.IsNullOrEmpty(selectedComponentType))
                        {
                            <div class="row g-3">
                                <!-- Export Component - Available for all storage types -->
                                <div class="col-md-6">
                                    <div class="modern-action-card">
                                        <div class="action-card-icon">
                                            <i class="bi bi-file-earmark-arrow-down"></i>
                                        </div>
                                        <div class="action-card-content">
                                            <h6 class="action-card-title">Export @GetComponentDisplayName(selectedComponentType)</h6>
                                            <p class="action-card-description">
                                                Download the current @GetComponentDisplayName(selectedComponentType) configuration as JSON for sharing or backup purposes.
                                            </p>
                                            <button type="button" class="modern-btn-primary" @onclick="ExportComponentData" title="Export Component">
                                                <i class="bi bi-download"></i> Export @GetComponentDisplayName(selectedComponentType)
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Import Component - Available for all storage types -->
                                <div class="col-md-6">
                                    <div class="modern-action-card">
                                        <div class="action-card-icon">
                                            <i class="bi bi-file-earmark-arrow-up"></i>
                                        </div>
                                        <div class="action-card-content">
                                            <h6 class="action-card-title">Import @GetComponentDisplayName(selectedComponentType)</h6>
                                            <p class="action-card-description">
                                                Upload and import @GetComponentDisplayName(selectedComponentType) configuration from JSON. This will update your current storage provider.
                                            </p>
                                            <div class="modern-notification-danger mb-3">
                                                <i class="bi bi-exclamation-triangle-fill"></i>
                                                <strong>WARNING:</strong> This will overwrite the current @GetComponentDisplayName(selectedComponentType) data.
                                            </div>
                                            <label class="modern-form-label">@GetComponentDisplayName(selectedComponentType) JSON File</label>
                                            <InputFile OnChange="OnComponentFileSelected" class="form-control" accept=".json" title="Select JSON file" />
                                            @if (!String.IsNullOrEmpty(selectedFileName))
                                            {
                                                <small class="text-muted mt-2 d-block"><i class="bi bi-file-earmark-check"></i> Selected: @selectedFileName</small>
                                            }
                                            <button type="button" class="modern-btn-success mt-2" @onclick="ImportComponentData" title="Import Component" disabled="@(String.IsNullOrEmpty(componentImportJson))">
                                                <i class="bi bi-upload"></i> Import @GetComponentDisplayName(selectedComponentType)
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Reset Configuration - Available for all storage types -->
                <div class="modern-setting-row">
                    <div class="setting-label">
                        <i class="bi bi-arrow-clockwise"></i> Reset Configuration
                    </div>
                    <div class="setting-description">
                        Reset the Global Configuration back to the default values at the time of installation. This will apply to all component configurations.
                    </div>
                    
                    <div class="mt-3">
                        <div class="modern-notification-danger">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            <strong>WARNING:</strong> This will reset your current Global Configuration to factory defaults. This action cannot be undone. Create a backup before proceeding.
                        </div>
                        <button type="button" class="modern-btn-danger mt-3" @onclick="@(e => FormAction("Global",0,"reset"))" title="Reset">
                            <i class="bi bi-arrow-clockwise"></i> Reset Global Configuration
                        </button>
                    </div>
                </div>
            </div>

            <!-- Identity Provider Tab Content -->
            <div id="tab-identity" class="modern-tab-content">
                <h3 class="mb-3">Identity Provider Settings</h3>
                <p class="text-secondary mb-4">
                    Configure the <strong>Identity Provider</strong> settings for the site if authentication is implemented. The Azure Naming Tool is designed to work with <strong><a href="https://learn.microsoft.com/en-us/azure/app-service/overview-authentication-authorization" target="_blank">Azure App Service Authentication</a></strong>, by default.
                </p>
                <p class="text-secondary mb-3">
                    If the Azure Naming Tool is configured to identify users, the site will track user activity. Users can also be designated as Admins using the <strong>Admin Users</strong> configuration. Learn more about Identity Provider Integration <a href="https://soltisweb.com/blog/detail/2023-06-azurenamingtool-identityproviderintegrationdeepdive" target="_blank"><strong>here</strong></a>.
                </p>
                @if (currentuser == "GlobalAdmin")
                {
                    @if (!String.IsNullOrEmpty(currentidentityprovider))
                    {
                        <div class="modern-notification-success mb-3">
                            <i class="bi bi-check-circle"></i>
                            <div>
                                <strong>Azure App Service Authentication Enabled!</strong><br /><br />
                                <strong>Current Identity provider:</strong> @currentidentityprovider.ToUpper()<br /><br />
                                <strong>Default Identity Header Name:</strong> X-MS-CLIENT-PRINCIPAL-NAME
                            </div>
                        </div>
                    }

                    <!-- Identity Header Name -->
                    <div class="modern-setting-row">
                        <div class="setting-label">Identity Header Name</div>
                        <div class="setting-description">
                            This setting is used to identify site users when authenticating using an Identity provider. Authentication using an Identity provider will often inject headers into the request. The site will check for the specified header name and assign the value as the user's identity. This value will be used to log user activity.
                        </div>
                        <div class="mt-3">
                            <label class="modern-form-label">Header Name</label>
                            <input title="Identity Header Name" id="currentidentityheadername" class="modern-form-input mb-3" type="text" @onchange="@((ui) => { SetFormValue("identityheadername",(string)ui.Value!);})" value="@currentidentityheadername" />
                        </div>
                        <div class="setting-actions">
                            <button type="button" class="modern-btn-success" @onclick="@(e => AdminFormAction("identityheadernamesave"))" title="Save Identity Header Name">
                                <span class="oi oi-check" aria-hidden="true"></span> Save
                            </button>
                        </div>
                        <div class="modern-notification-info mt-3">
                            <i class="bi bi-info-circle"></i>
                            <div>
                                <strong>NOTE</strong><br />
                                The Azure Naming Tool is configured for <strong><a href="https://learn.microsoft.com/en-us/azure/app-service/overview-authentication-authorization" target="_blank">Azure App Service Authentication</a></strong> using the <a href="https://learn.microsoft.com/en-us/azure/app-service/configure-authentication-user-identities#access-user-claims-in-app-code" target="_blank"><strong>X-MS-CLIENT-PRINCIPAL-NAME</strong></a> header name. If using a different Identity provider, update the setting to the header name that contains the user's id.
                            </div>
                        </div>
                    </div>

                    <!-- Admin Users -->
                    <!-- Admin Users -->
                    <div class="modern-setting-row">
                        <div class="setting-label">Admin Users</div>
                        <div class="setting-description">
                            When authenticating users with an Identity provider, the <strong>Identity Header Name</strong> setting can be used to identify site users. Enter the user id below to assign the user as an <strong>Admin</strong> for the Azure Naming Tool.
                        </div>

                        @if (!String.IsNullOrEmpty(currentidentityprovider))
                        {
                            @switch (currentidentityprovider.ToLower())
                            {
                                case "aad":
                                    <div class="modern-notification-info mt-3">
                                        <i class="bi bi-info-circle"></i>
                                        <div>
                                            When using <strong>@currentidentityprovider.ToUpper()</strong> for Azure App Service Authentication, the <strong>X-MS-CLIENT-PRINCIPAL-NAME</strong> header value will be the user's email address.<br /><br /><strong>Example:</strong> example@xyz.com<br /><br />This value should be used to designate the user as an <strong>Admin</strong>.
                                        </div>
                                    </div>
                                    break;
                                case "github":
                                    <div class="modern-notification-info mt-3">
                                        <i class="bi bi-info-circle"></i>
                                        <div>
                                            When using <strong>@currentidentityprovider.ToUpper()</strong> for Azure App Service Authentication, the <strong>X-MS-CLIENT-PRINCIPAL-NAME</strong> header value will be the user's name.<br /><br /><strong>Example:</strong> John Smith<br /><br />This value should be used to designate the user as an <strong>Admin</strong>.
                                        </div>
                                    </div>
                                    break;
                                case "google":
                                    <div class="modern-notification-info mt-3">
                                        <i class="bi bi-info-circle"></i>
                                        <div>
                                            When using <strong>@currentidentityprovider.ToUpper()</strong> for Azure App Service Authentication, the <strong>X-MS-CLIENT-PRINCIPAL-NAME</strong> header value will be the user's email address.<br /><br /><strong>Example:</strong> example@gmail.com<br /><br />This value should be used to designate the user as an <strong>Admin</strong>.
                                        </div>
                                    </div>
                                    break;
                            }
                        }

                        <div class="mt-3">
                            <button type="button" class="modern-btn-success" @onclick="@(e => AdminFormAction("adminuseradd"))" title="Add Admin User">
                                <span class="oi oi-plus" aria-hidden="true"></span> Add Admin User
                            </button>
                        </div>

                        @if (GeneralHelper.IsNotNull(servicesData.AdminUsers))
                        {
                            @if (servicesData.AdminUsers.Count > 0)
                            {
                                <div class="table-responsive mt-3">
                                    <table class="modern-table">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in servicesData.AdminUsers)
                                            {
                                                <tr>
                                                    <td>@item.Name</td>
                                                    <td>
                                                        @if (GeneralHelper.NormalizeName(currentuser, true) != GeneralHelper.NormalizeName(@item.Name, true))
                                                        {
                                                            <button type="button" class="modern-btn-danger modern-btn-small" @onclick="@(e => AdminFormAction("adminuserdelete",item.Id))" title="Delete">
                                                                <span class="oi oi-trash" aria-hidden="true"></span>
                                                            </button>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <p class="text-secondary fst-italic mt-3">There are currently no assigned admin users.</p>
                            }
                        }
                        else
                        {
                            <p class="text-secondary fst-italic mt-3">There are currently no assigned admin users.</p>
                        }

                        <div class="modern-notification-warning mt-3">
                            <i class="bi bi-exclamation-triangle"></i>
                            <div>
                                <strong>NOTE</strong><br />
                                Added users will need to close their browser and re-open the site for the change to take effect.
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="modern-notification-info">
                        <i class="bi bi-info-circle"></i>
                        <div>
                            <span class="fst-italic">Only the Global Admin can perform this action. Please logout and login with the Global Admin password to access this feature.</span>
                        </div>
                    </div>
                }
            </div>
            <!-- End of tab-identity -->

        </div>
        <!-- End of modern-tabs-container -->
    }
    <!-- End of else (admin) block -->
</div>
<!-- End of modern-admin-container -->

@code {
    [CascadingParameter]
    protected ThemeInfo theme { get; set; } = new();
    [CascadingParameter]
    public IModalService? Modal { get; set; }
    [CascadingParameter]
    private IdentityProviderDetails identityProviderDetails { get; set; } = new();
    
    [Inject]
    public IAdminService? AdminService { get; set; }
    
    [Inject]
    protected IJSRuntime? JSRuntime { get; set; }
    
    [Inject]
    public IAdminUserService? AdminUserService { get; set; }
    
    [Inject]
    public IAdminLogService? AdminLogService { get; set; }
    
    [Inject]
    public IImportExportService? ImportExportService { get; set; }
    
    [Inject]
    public IBlazorDownloadFileService? BlazorDownloadFileService { get; set; }
    
    [Inject]
    public IConfiguration? Configuration { get; set; }
    
    [Inject]
    public IResourceTypeService? ResourceTypeService { get; set; }
    
    [Inject]
    public IResourceLocationService? ResourceLocationService { get; set; }
    
    [Inject]
    public IResourceEnvironmentService? ResourceEnvironmentService { get; set; }
    
    [Inject]
    public IResourceOrgService? ResourceOrgService { get; set; }
    
    [Inject]
    public IResourceProjAppSvcService? ResourceProjAppSvcService { get; set; }
    
    [Inject]
    public IResourceUnitDeptService? ResourceUnitDeptService { get; set; }
    
    [Inject]
    public IResourceFunctionService? ResourceFunctionService { get; set; }
    
    [Inject]
    public IResourceDelimiterService? ResourceDelimiterService { get; set; }
    
    [Inject]
    public ICustomComponentService? CustomComponentService { get; set; }
    
    [Inject]
    public IAzureValidationService? AzureValidationService { get; set; }
    
    private ServicesData servicesData = new();

    private string currentpassword = String.Empty;
    private string newpassword = String.Empty;
    private string currentapikey = String.Empty;
    private string currentreadonlyapikey = String.Empty;
    private string currentnamegenerationapikey = String.Empty;
    private string currentidentityheadername = String.Empty;
    private string currentidentityprovider = String.Empty;
    private ResponseMessage message = new();
    private bool admin;
    private bool versionalertshown = false;
    private bool disabled = true;
    private bool dismissalert = false;
    private bool duplicatenamesallowed = false;
    private bool connectivitycheckenabled = true;
    private bool resourcetypeeditingallowed = false;
    private bool autoincrementresourceinstance = false;
    private bool instructionsenabled = false;
    private bool generatednameslogenabled = false;
    private bool configurationenabled = false;
    private bool referenceenabled = false;
    private bool latestnewsenabled = false;
    private bool retaingenerateselections = false;
    private bool showadmindetailstoallusers = false;
    private bool azuretenantamevalidationenabled = false;
    private string customhomecontent = String.Empty;
    private bool customHomeContentLoaded = false;
    MarkdownEditor mdCustomHomeContent = new();
    private string customlogopath = String.Empty;
    private string customtoolname = String.Empty;
    private string currentgenerationwebhook = String.Empty;
    private string versionalert = String.Empty;
    private string appversion = String.Empty;
    private SiteConfiguration config = ConfigurationHelper.GetConfigurationData();
    private string currentuser = String.Empty;
    private List<KeyValuePair<string, string>> environmentvariables = new();
    private string releasenotesurl = String.Empty;
    private long maxFileSize = 2000000;
    
    // Storage migration related variables
    private string currentStorageProvider = "FileSystem";
    private bool isMigrating = false;
    private string migrationErrorMessage = String.Empty;
    private bool preMigrationBackupCompleted = false;
    private string preMigrationBackupFileName = String.Empty;

    // Backup/Restore related variables
    private IBrowserFile? sqliteBackupFile;
    private IBrowserFile? jsonBackupFile;
    private bool includeAdmin = false;
    private bool isUsingSQLite => currentStorageProvider == "SQLite";
    private string newGlobalConfig = String.Empty;

    // Individual component import/export variables
    private string selectedComponentType = String.Empty;
    private string componentImportJson = String.Empty;
    private string selectedFileName = String.Empty;

    // Azure Validation variables
    private bool testingConnection = false;
    private bool azureConnectionTested = false;
    private bool azureConnectionSuccess = false;
    private string azureConnectionError = String.Empty;
    private string azureConnectionDetails = String.Empty;
    private string azureTenantInfo = String.Empty;
    private int azureSubscriptionCount = 0;
    private List<SubscriptionAccess> availableSubscriptions = new();
    private HashSet<string> selectedSubscriptionIds = new();
    private string azureAuthMode = "ManagedIdentity";
    private string azureTenantId = String.Empty;
    private string azureClientId = String.Empty;
    private string azureConflictStrategy = "NotifyOnly";
    private bool azureCacheEnabled = true;
    private int azureCacheDuration = 5;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        currentuser = await IdentityHelper.GetCurrentUser(session);
        if (firstRender)
        {
            appversion = ConfigurationHelper.GetAssemblyVersion();
            releasenotesurl = "https://github.com/mspnp/AzureNamingTool/wiki/v" + appversion;

            servicesData = await ServicesHelper.LoadServicesData(servicesData, true);
            var result = await session.GetAsync<bool>("admin");
            admin = (bool)result.Value;
            if (admin)
            {
                currentapikey = GeneralHelper.DecryptString(config.APIKey!, config.SALTKey!);
                currentreadonlyapikey = GeneralHelper.DecryptString(config.ReadOnlyAPIKey!, config.SALTKey!);
                currentnamegenerationapikey = GeneralHelper.DecryptString(config.NameGenerationAPIKey!, config.SALTKey!);
                // Determine if the version notification has been dismissed
                var resultVersionAlert = await session.GetAsync<bool>("versionalert-" + appversion + "-shown");
                versionalertshown = resultVersionAlert.Success ? resultVersionAlert.Value : false;
                versionalert = ConfigurationHelper.GetVersionAlert(true).Result;
                duplicatenamesallowed = Convert.ToBoolean(ConfigurationHelper.GetAppSetting("DuplicateNamesAllowed"));
                connectivitycheckenabled = Convert.ToBoolean(ConfigurationHelper.GetAppSetting("ConnectivityCheckEnabled"));
                resourcetypeeditingallowed = Convert.ToBoolean(ConfigurationHelper.GetAppSetting("ResourceTypeEditingAllowed"));
                autoincrementresourceinstance = Convert.ToBoolean(ConfigurationHelper.GetAppSetting("AutoIncrementResourceInstance"));
                instructionsenabled = Convert.ToBoolean(ConfigurationHelper.GetAppSetting("InstructionsEnabled"));
                generatednameslogenabled = Convert.ToBoolean(ConfigurationHelper.GetAppSetting("GeneratedNamesLogEnabled"));
                configurationenabled = Convert.ToBoolean(ConfigurationHelper.GetAppSetting("ConfigurationEnabled"));
                referenceenabled = Convert.ToBoolean(ConfigurationHelper.GetAppSetting("ReferenceEnabled"));
                latestnewsenabled = Convert.ToBoolean(ConfigurationHelper.GetAppSetting("LatestNewsEnabled"));
                retaingenerateselections = Convert.ToBoolean(ConfigurationHelper.GetAppSetting("RetainGenerateSelections"));
                showadmindetailstoallusers = Convert.ToBoolean(ConfigurationHelper.GetAppSetting("ShowAdminDetailsToAllUsers"));
                azuretenantamevalidationenabled = Convert.ToBoolean(ConfigurationHelper.GetAppSetting("AzureTenantNameValidationEnabled"));
                
                // Load Azure validation settings
                if (AzureValidationService != null)
                {
                    try
                    {
                        var azureSettings = await AzureValidationService.GetSettingsAsync();
                        if (azureSettings != null)
                        {
                            azureAuthMode = azureSettings.AuthMode.ToString();
                            azureTenantId = azureSettings.TenantId ?? String.Empty;
                            azureConflictStrategy = azureSettings.ConflictResolution.Strategy.ToString();
                            azureCacheEnabled = azureSettings.Cache.Enabled;
                            azureCacheDuration = azureSettings.Cache.DurationMinutes;
                            
                            // Load subscription IDs into selected set
                            selectedSubscriptionIds.Clear();
                            if (azureSettings.SubscriptionIds != null && azureSettings.SubscriptionIds.Any())
                            {
                                foreach (var subId in azureSettings.SubscriptionIds)
                                {
                                    selectedSubscriptionIds.Add(subId);
                                    
                                    // Also add to availableSubscriptions so they show in UI before connection test
                                    if (!availableSubscriptions.Any(s => s.SubscriptionId == subId))
                                    {
                                        availableSubscriptions.Add(new SubscriptionAccess
                                        {
                                            SubscriptionId = subId,
                                            DisplayName = $"Subscription (Saved)",
                                            State = "Unknown"
                                        });
                                    }
                                }
                                
                                // Mark that we have saved subscriptions to display
                                if (availableSubscriptions.Any())
                                {
                                    azureConnectionSuccess = true; // Show the subscription list
                                    azureConnectionTested = true;
                                }
                            }
                            
                            // Load Service Principal settings if available
                            if (azureSettings.ServicePrincipal != null)
                            {
                                azureClientId = azureSettings.ServicePrincipal.ClientId ?? String.Empty;
                            }
                        }
                    }
                    catch (Exception ex)
                    {
                        // Silently fail - settings will use defaults
                        await AdminLogService!.PostItemAsync(new AdminLogMessage() 
                        { 
                            Title = "WARNING", 
                            Message = $"Failed to load Azure validation settings: {ex.Message}" 
                        });
                    }
                }
                
                customhomecontent = ConfigurationHelper.GetAppSetting("CustomHomeContent", false);
                customHomeContentLoaded = true;
                customlogopath = ConfigurationHelper.GetAppSetting("CustomLogoPath", false);
                customtoolname = ConfigurationHelper.GetAppSetting("CustomToolName", false);
                currentgenerationwebhook = ConfigurationHelper.GetAppSetting("GenerationWebhook", true);
                currentidentityheadername = ConfigurationHelper.GetAppSetting("IdentityHeaderName", true);
                if (GeneralHelper.IsNotNull(identityProviderDetails))
                {
                    if (!String.IsNullOrEmpty(identityProviderDetails.CurrentIdentityProvider))
                    {
                        currentidentityprovider = identityProviderDetails.CurrentIdentityProvider;
                    }
                }
                environmentvariables = ConfigurationHelper.GetEnvironmentVariables();
                
                // Load current storage provider
                currentStorageProvider = ConfigurationHelper.GetAppSetting("StorageProvider");
                if (string.IsNullOrEmpty(currentStorageProvider))
                {
                    currentStorageProvider = "FileSystem";
                }
            }

            await storage.SetAsync("apptheme", theme.ThemeStyle);
            state.AppTheme = theme.ThemeStyle;

            StateHasChanged();
            
            // Initialize tabs after state has changed and DOM is ready
            if (JSRuntime != null)
            {
                await Task.Delay(100); // Small delay to ensure DOM is rendered
                await JSRuntime.InvokeVoidAsync("initializeTabs");
            }
            
            // Initialize MarkdownEditor with saved content after everything else is ready
            // Using Task.Run to not block the UI and allow the component to fully initialize
            if (customHomeContentLoaded && !string.IsNullOrEmpty(customhomecontent))
            {
                _ = Task.Run(async () =>
                {
                    await Task.Delay(1000); // Wait 1 second for full initialization
                    try
                    {
                        await InvokeAsync(async () =>
                        {
                            await mdCustomHomeContent.SetValueAsync(customhomecontent);
                            StateHasChanged();
                        });
                    }
                    catch (Exception ex)
                    {
                        // Log the error for debugging
                        await AdminLogService!.PostItemAsync(new AdminLogMessage() 
                        { 
                            Title = "WARNING", 
                            Message = $"Failed to initialize Custom Home Content in editor: {ex.Message}" 
                        });
                    }
                });
            }

            var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
            if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("reset", out var _reset))
            {
                if (Convert.ToBoolean(_reset))
                {
                    toastService.ShowSuccess("The site settings have been reset!");
                }
            }

        }
    }

    private async Task CreatePreMigrationBackup()
    {
        try
        {
            var response = await ImportExportService!.ExportConfigAsync(true); // Include admin data
            if (!response.Success || response.ResponseObject == null)
            {
                toastService.ShowError("Failed to create backup: " + response.ResponseMessage);
                return;
            }

            string jsonData = System.Text.Json.JsonSerializer.Serialize(response.ResponseObject);
            preMigrationBackupFileName = $"azurenamingtool-pre-migration-{DateTime.Now:yyyyMMdd-HHmmss}.json";
            byte[] fileBytes = System.Text.Encoding.UTF8.GetBytes(jsonData);
            
            await BlazorDownloadFileService!.DownloadFile(preMigrationBackupFileName, fileBytes, "application/json");
            
            preMigrationBackupCompleted = true;
            StateHasChanged();
            
            toastService.ShowSuccess($"Backup created successfully! File: {preMigrationBackupFileName}");
            
            await AdminLogService!.PostItemAsync(new AdminLogMessage() 
            { 
                Title = "INFORMATION", 
                Message = $"Pre-migration backup created: {preMigrationBackupFileName} (Size: {FormatFileSize(fileBytes.Length)})"
            });
        }
        catch (Exception ex)
        {
            toastService.ShowError("Failed to create backup: " + ex.Message);
            
            await AdminLogService!.PostItemAsync(new AdminLogMessage() 
            { 
                Title = "ERROR", 
                Message = "Pre-migration backup failed: " + ex.Message 
            });
        }
    }

    private async Task InitiateMigration()
    {
        // First confirmation
        var confirm1 = await ModalHelper.ShowConfirmationModal(
            Modal!, 
            "ATTENTION - Migration Confirmation (Step 1 of 2)", 
            "<div style='margin: 1.5rem 0;'><p><strong>You are about to migrate to SQLite storage.</strong></p>" +
            "<p class=\"text-danger\"><strong>IMPORTANT: This migration is ONE-WAY and cannot be automatically reversed!</strong></p>" +
            "<ul>" +
            "<li>Your JSON backup has been created and downloaded</li>" +
            "<li>JSON files will be preserved but no longer used</li>" +
            "<li>To restore from backup later, use the Configuration page</li>" +
            "<li>The application will restart after migration</li>" +
            "</ul>" +
            "<p>Do you understand and want to proceed to Step 2?</p></div>", 
            "bg-warning", 
            theme
        );

        if (!confirm1)
        {
            return;
        }

        // Second confirmation with text input required
        var confirm2 = await ModalHelper.ShowTextConfirmationModal(
            Modal!, 
            "FINAL CONFIRMATION (Step 2 of 2)", 
            "<div style='margin: 1.5rem 0;'><p class=\"text-danger\"><strong>FINAL WARNING: This action cannot be undone!</strong></p>" +
            "<p>The migration to SQLite is irreversible. Your JSON files will be preserved but no longer actively used.</p>" +
            "<p>You will need to use the Configuration page to restore from backups if needed.</p></div>",
            "MIGRATE",
            "bg-danger", 
            theme,
            true  // case-sensitive
        );

        if (!confirm2)
        {
            return;
        }

        try
        {
            isMigrating = true;
            migrationErrorMessage = String.Empty;
            StateHasChanged();

            // Execute the migration
            var result = await MigrationService.MigrateToSQLiteAsync();

            if (result.Success)
            {
                // Update configuration to use SQLite
                ConfigurationHelper.SetAppSetting("StorageProvider", "SQLite");
                currentStorageProvider = "SQLite";

                toastService.ShowSuccess("Migration to SQLite completed successfully! The application will restart in 3 seconds...");
                
                await AdminLogService!.PostItemAsync(new AdminLogMessage() 
                { 
                    Title = "SUCCESS", 
                    Message = $"Migrated to SQLite storage successfully. Pre-migration backup: {preMigrationBackupFileName}"
                });

                // Add JavaScript to attempt auto-reload when server comes back
                await JsRuntime.InvokeVoidAsync("eval", @"
                    setTimeout(function() {
                        var checkInterval = setInterval(function() {
                            fetch('/')
                                .then(function(response) {
                                    if (response.ok) {
                                        clearInterval(checkInterval);
                                        window.location.href = '/';
                                    }
                                })
                                .catch(function() {
                                    // Server still down, keep checking
                                });
                        }, 2000);
                    }, 3000);
                ");

                // Trigger application restart
                await Task.Delay(3000);
                AppLifetime.StopApplication();
            }
            else
            {
                migrationErrorMessage = "Migration failed: " + result.Message;
                toastService.ShowError("Migration to SQLite failed. " + result.Message);
                
                await AdminLogService!.PostItemAsync(new AdminLogMessage() 
                { 
                    Title = "ERROR", 
                    Message = "Migration to SQLite failed: " + result.Message 
                });
            }
        }
        catch (Exception ex)
        {
            migrationErrorMessage = "Migration error: " + ex.Message;
            toastService.ShowError("Migration failed: " + ex.Message);
            
            await AdminLogService!.PostItemAsync(new AdminLogMessage() 
            { 
                Title = "ERROR", 
                Message = "Migration to SQLite failed: " + ex.Message 
            });
        }
        finally
        {
            isMigrating = false;
            StateHasChanged();
        }
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private async void AdminFormAction(string action, int id = 0)
    {
        message = new ResponseMessage();
        message.Header = "INFORMATION";
        message.Type = MessageTypesEnum.INFORMATION;
        ServiceResponse serviceResponse = new();
        bool redirect = false;
        bool confirm = false;
        bool displaymessage = true;

        switch (action)
        {
            case "login":
                // Check the password
                if (currentpassword == GeneralHelper.DecryptString(config.AdminPassword!, config.SALTKey!))
                {
                    state.SetAdmin(true);
                    await session.SetAsync("admin", true);
                    await session.SetAsync("currentuser", "GlobalAdmin");
                    // Load the current API Keys
                    currentapikey = GeneralHelper.DecryptString(config.APIKey!, config.SALTKey!);
                    currentreadonlyapikey = GeneralHelper.DecryptString(config.ReadOnlyAPIKey!, config.SALTKey!);
                    message.Type = MessageTypesEnum.INFORMATION;
                    message.Header = "INFORMATION";
                    message.Message = "Global Admin logged in.";
                    admin = true;
                    redirect = true;
                }
                else
                {
                    state.SetAdmin(false);
                    await session.SetAsync("admin", false);
                    message.Type = MessageTypesEnum.ERROR;
                    message.Header = "ERROR";
                    message.Message = "Login failed!";
                }
                break;
            case "logout":
                state.SetAdmin(false);
                await session.SetAsync("admin", false);
                message.Type = MessageTypesEnum.INFORMATION;
                message.Header = "INFORMATION";
                message.Message = "User Logged out.";
                redirect = true;
                break;
            case "password":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div style='margin: 1.5rem 0;'>This will update the Global Admin Password.</div><div style='margin: 1.5rem 0;'>Are you sure?</div>", "bg-danger", theme);
                if (confirm)
                {
                    // Set the new Global admin password
                    serviceResponse = await AdminService!.UpdatePasswordAsync(newpassword);
                    if (serviceResponse.Success)
                    {
                        message.Type = MessageTypesEnum.SUCCESS;
                        message.Header = "SUCCESS";
                        message.Message = "Global Admin Password updated!";
                    }
                    else
                    {
                        message.Type = MessageTypesEnum.ERROR;
                        message.Header = "ERROR";
                        message.Message = "There was a problem updating the Global Admin Password!";
                    }
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "identityheadernamesave":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div style='margin: 1.5rem 0;'>This will update the Identity Header Name.</div><div style='margin: 1.5rem 0;'>Are you sure?</div>", "bg-danger", theme);
                if (confirm)
                {
                    serviceResponse = await AdminService!.UpdateIdentityHeaderNameAsync(currentidentityheadername);
                    if (serviceResponse.Success)
                    {
                        message.Type = MessageTypesEnum.SUCCESS;
                        message.Header = "SUCCESS";
                        message.Message = "Identity Header Name updated!";
                    }
                    else
                    {
                        message.Type = MessageTypesEnum.ERROR;
                        message.Header = "ERROR";
                        message.Message = "There was a problem updating the Identity Header Name!";
                    }
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "apikeysave":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div style='margin: 1.5rem 0;'>This will update the Full Access API Key.</div><div style='margin: 1.5rem 0;'>Are you sure?</div>", "bg-danger", theme);
                if (confirm)
                {
                    serviceResponse = await AdminService!.UpdateAPIKeyAsync(currentapikey, "fullaccess");
                    if (serviceResponse.Success)
                    {
                        message.Type = MessageTypesEnum.SUCCESS;
                        message.Header = "SUCCESS";
                        message.Message = "Full Access API Key updated!";
                    }
                    else
                    {
                        message.Type = MessageTypesEnum.ERROR;
                        message.Header = "ERROR";
                        message.Message = "There was a problem updating the Full Access API Key!";
                    }
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "apikeygenerate":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div style='margin: 1.5rem 0;'>This will generate a new Full Access API Key.</div><div style='margin: 1.5rem 0;'>Are you sure?</div>", "bg-danger", theme);
                if (confirm)
                {
                    serviceResponse = await AdminService!.GenerateAPIKeyAsync("fullaccess");
                    if (serviceResponse.Success)
                    {
                        if (GeneralHelper.IsNotNull(serviceResponse.ResponseObject))
                        {
                            currentapikey = serviceResponse.ResponseObject!;
                            message.Type = MessageTypesEnum.SUCCESS;
                            message.Header = "SUCCESS";
                            message.Message = "Full Access API Key updated!";
                        }
                        else
                        {
                            message.Type = MessageTypesEnum.ERROR;
                            message.Header = "ERROR";
                            message.Message = "There was a problem generating the Full Access API Key!";
                        }
                    }
                    else
                    {
                        message.Type = MessageTypesEnum.ERROR;
                        message.Header = "ERROR";
                        message.Message = "There was a problem generating the Full Access API Key!";
                    }
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "namegenerationapikeysave":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div style='margin: 1.5rem 0;'>This will update the Name Generation API Key.</div><div style='margin: 1.5rem 0;'>Are you sure?</div>", "bg-danger", theme);
                if (confirm)
                {
                    serviceResponse = await AdminService!.UpdateAPIKeyAsync(currentnamegenerationapikey, "namegeneration");
                    if (serviceResponse.Success)
                    {
                        message.Type = MessageTypesEnum.SUCCESS;
                        message.Header = "SUCCESS";
                        message.Message = "Name Generation API Key updated!";
                    }
                    else
                    {
                        message.Type = MessageTypesEnum.ERROR;
                        message.Header = "ERROR";
                        message.Message = "There was a problem updating the Name Generation API Key!";
                    }
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "namegenerationapikeygenerate":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div style='margin: 1.5rem 0;'>This will generate a new Name Generation API Key.</div><div style='margin: 1.5rem 0;'>Are you sure?</div>", "bg-danger", theme);
                if (confirm)
                {
                    serviceResponse = await AdminService!.GenerateAPIKeyAsync("namegeneration");
                    if (serviceResponse.Success)
                    {
                        if (GeneralHelper.IsNotNull(serviceResponse.ResponseObject))
                        {
                            currentnamegenerationapikey = serviceResponse.ResponseObject!;
                            message.Type = MessageTypesEnum.SUCCESS;
                            message.Header = "SUCCESS";
                            message.Message = "Name Generation API Key updated!";
                        }
                        else
                        {
                            message.Type = MessageTypesEnum.ERROR;
                            message.Header = "ERROR";
                            message.Message = "There was a problem generating the Name Generation API Key!";
                        }
                    }
                    else
                    {
                        message.Type = MessageTypesEnum.ERROR;
                        message.Header = "ERROR";
                        message.Message = "There was a problem generating the Name Generation API Key!";
                    }
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "readonlyapikeysave":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div style='margin: 1.5rem 0;'>This will update the Read-Only API Key.</div><div style='margin: 1.5rem 0;'>Are you sure?</div>", "bg-danger", theme);
                if (confirm)
                {
                    serviceResponse = await AdminService!.UpdateAPIKeyAsync(currentreadonlyapikey, "readonly");
                    if (serviceResponse.Success)
                    {
                        message.Type = MessageTypesEnum.SUCCESS;
                        message.Header = "SUCCESS";
                        message.Message = "Read-Only API Key updated!";
                    }
                    else
                    {
                        message.Type = MessageTypesEnum.ERROR;
                        message.Header = "ERROR";
                        message.Message = "There was a problem updating the Read-Only API Key!";
                    }
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "readonlyapikeygenerate":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div style='margin: 1.5rem 0;'>This will generate a new Read-Only API Key.</div><div style='margin: 1.5rem 0;'>Are you sure?</div>", "bg-danger", theme);
                if (confirm)
                {
                    serviceResponse = await AdminService!.GenerateAPIKeyAsync("readonly");
                    if (serviceResponse.Success)
                    {
                        if (GeneralHelper.IsNotNull(serviceResponse.ResponseObject))
                        {
                            currentreadonlyapikey = serviceResponse.ResponseObject!;
                            message.Type = MessageTypesEnum.SUCCESS;
                            message.Header = "SUCCESS";
                            message.Message = "Read-Only API Key updated!";
                        }
                        else
                        {
                            message.Type = MessageTypesEnum.ERROR;
                            message.Header = "ERROR";
                            message.Message = "There was a problem generating the Read-Only API Key!";
                        }
                    }
                    else
                    {
                        message.Type = MessageTypesEnum.ERROR;
                        message.Header = "ERROR";
                        message.Message = "There was a problem generating the Read-Only API Key!";
                    }
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "generationwebhooksave":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div style='margin: 1.5rem 0;'>This will update the Generation Webhook.</div><div style='margin: 1.5rem 0;'>Are you sure?</div>", "bg-danger", theme);
                if (confirm)
                {
                    if (!String.IsNullOrEmpty(currentgenerationwebhook))
                    {
                        if (!Uri.IsWellFormedUriString(currentgenerationwebhook, UriKind.Absolute))
                        {
                            message.Header = "ERROR";
                            message.Type = MessageTypesEnum.ERROR;
                            message.Message = "You must enter a valid URL!";
                            break;
                        }
                    }
                    ConfigurationHelper.SetAppSetting("GenerationWebhook", currentgenerationwebhook, true);
                    message.Type = MessageTypesEnum.SUCCESS;
                    message.Header = "SUCCESS";
                    message.Message = "Generation Webhook configuration saved!";
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "customhomecontentsave":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div style='margin: 1.5rem 0;'>This will update the Custom Home content.</div><div style='margin: 1.5rem 0;'>Are you sure?</div>", "bg-primary", theme);
                if (confirm)
                {
                    ConfigurationHelper.SetAppSetting("CustomHomeContent", customhomecontent, false);
                    await mdCustomHomeContent.SetValueAsync(customhomecontent);
                    message.Type = MessageTypesEnum.SUCCESS;
                    message.Header = "SUCCESS";
                    message.Message = "Custom Home content saved!";
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "customhomecontentclear":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div style='margin: 1.5rem 0;'>This will clear the Custom Home content.</div><div style='margin: 1.5rem 0;'>Are you sure?</div>", "bg-danger", theme);
                if (confirm)
                {
                    ConfigurationHelper.SetAppSetting("CustomHomeContent", String.Empty, false);
                    customhomecontent = String.Empty;
                    await mdCustomHomeContent.SetValueAsync(customhomecontent);
                    message.Type = MessageTypesEnum.SUCCESS;
                    message.Header = "SUCCESS";
                    message.Message = "Custom Home content cleared!";
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "customlogopathsave":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div style='margin: 1.5rem 0;'>This will update the Custom Logo.</div><div style='margin: 1.5rem 0;'>Are you sure?</div>", "bg-primary", theme);
                if (confirm)
                {
                    ConfigurationHelper.SetAppSetting("CustomLogoPath", customlogopath, false);
                    message.Type = MessageTypesEnum.SUCCESS;
                    message.Header = "SUCCESS";
                    message.Message = "Custom Logo saved!";
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "customlogopathclear":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div style='margin: 1.5rem 0;'>This will clear the Custom Logo.</div><div style='margin: 1.5rem 0;'>Are you sure?</div>", "bg-danger", theme);
                if (confirm)
                {
                    ConfigurationHelper.SetAppSetting("CustomLogoPath", String.Empty, false);
                    customlogopath = String.Empty;
                    message.Type = MessageTypesEnum.SUCCESS;
                    message.Header = "SUCCESS";
                    message.Message = "Custom Logo cleared!";
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "customtoolnamesave":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div style='margin: 1.5rem 0;'>This will update the Custom Tool Name.</div><div style='margin: 1.5rem 0;'>Are you sure?</div>", "bg-primary", theme);
                if (confirm)
                {
                    ConfigurationHelper.SetAppSetting("CustomToolName", customtoolname, false);
                    message.Type = MessageTypesEnum.SUCCESS;
                    message.Header = "SUCCESS";
                    message.Message = "Custom Tool Name saved!";
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "customtoolnameclear":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div style='margin: 1.5rem 0;'>This will clear the Custom Tool Name.</div><div style='margin: 1.5rem 0;'>Are you sure?</div>", "bg-danger", theme);
                if (confirm)
                {
                    ConfigurationHelper.SetAppSetting("CustomToolName", String.Empty, false);
                    customtoolname = String.Empty;
                    message.Type = MessageTypesEnum.SUCCESS;
                    message.Header = "SUCCESS";
                    message.Message = "Custom Tool Name cleared!";
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "clearcache":
                CacheHelper.ClearAllCache();
                // Set session flag to force Configuration page to reload data
                await session.SetAsync("forceconfigreload", true);
                message.Type = MessageTypesEnum.SUCCESS;
                message.Header = "SUCCESS";
                message.Message = "Cache cleared!";
                break;
            case "viewcachedata":
                string cachedata = CacheHelper.GetAllCacheData();
                ModalHelper.ShowInformationModal(Modal!, theme, "bg-navcolor", "Cache Data", "<p>This is the current cache data.</p>" + cachedata, "", admin);
                displaymessage = false;
                break;
            case "samplepost":
                string webhookdata = await FileSystemHelper.ReadFile("samplewebhookdata.json", "");
                ModalHelper.ShowInformationModal(Modal!, theme, "bg-navcolor", "Sample Post", "<p>This is a sample Generation Webhook post.</p><code style=\"display: block; white-space: pre-wrap;\">" + webhookdata + "</code>", "", admin);
                displaymessage = false;
                break;
            case "adminuseradd":
                bool added = await ModalHelper.ShowAddModal(Modal!, servicesData, theme, "bg-navcolor", "Add Admin User", "<p>Add an Admin User.</p>", id, "AdminUser", admin, "");
                if (added)
                {
                    servicesData = await ServicesHelper.LoadServicesData(servicesData, admin);
                    state.SetNavReload(true);
                    StateHasChanged();
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "adminuserdelete":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div style='margin: 1.5rem 0;'>This will delete the Admin User.</div><div style='margin: 1.5rem 0;'>Are you sure?</div>", "bg-danger", theme);
                if (confirm)
                {
                    serviceResponse = await AdminUserService!.DeleteItemAsync(Convert.ToInt32(id));
                    if (serviceResponse.Success)
                    {
                        message.Type = MessageTypesEnum.SUCCESS;
                        message.Message = "Admin User deleted!";
                    }
                    else
                    {
                        message.Type = MessageTypesEnum.ERROR;
                        message.Message = "Admin User deletion failed!";
                        message.MessageDetails = serviceResponse.ResponseMessage;
                    }
                }
                else
                {
                    displaymessage = false;
                }
                break;

            case "resetsitesettings":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div style='margin: 1.5rem 0;'>This will reset <span style='font-weight: 600;'>ALL</span> site settings. This includes site settings and cusomtizations.</div><div style='margin: 1.5rem 0;'>Are you sure?</div>", "bg-danger", theme);
                if (confirm)
                {
                    // Create new default configuration
                    SiteConfiguration resetconfig = new();
                    ConfigurationHelper.SetAppSetting("AutoIncrementResourceInstance", resetconfig.AutoIncrementResourceInstance!, false);
                    ConfigurationHelper.SetAppSetting("DuplicateNamesAllowed", resetconfig.DuplicateNamesAllowed!, false);
                    ConfigurationHelper.SetAppSetting("ResourceTypeEditingAllowed", resetconfig.ResourceTypeEditingAllowed!, false);
                    ConfigurationHelper.SetAppSetting("InstructionsEnabled", resetconfig.InstructionsEnabled!, false);
                    ConfigurationHelper.SetAppSetting("GeneratedNamesLogEnabled", resetconfig.GeneratedNamesLogEnabled!, false);
                    ConfigurationHelper.SetAppSetting("ConfigurationEnabled", resetconfig.ConfigurationEnabled!, false);
                    ConfigurationHelper.SetAppSetting("ReferenceEnabled", resetconfig.ReferenceEnabled!, false);
                    ConfigurationHelper.SetAppSetting("LatestNewsEnabled", resetconfig.LatestNewsEnabled!, false);
                    ConfigurationHelper.SetAppSetting("RetainGenerateSelections", resetconfig.RetainGenerateSelections!, false);
                    ConfigurationHelper.SetAppSetting("CustomHomeContent", String.Empty, false);
                    ConfigurationHelper.SetAppSetting("CustomLogoPath", String.Empty, false);
                    ConfigurationHelper.SetAppSetting("CustomToolName", String.Empty, false);
                    ConfigurationHelper.SetAppSetting("ConnectivityCheckEnabled", resetconfig.ConnectivityCheckEnabled!, false);
                    ConfigurationHelper.SetAppSetting("GenerationWebhook", String.Empty, true);
                    ConfigurationHelper.SetAppSetting("ShowAdminDataToAllUsers", String.Empty, true);
                    await AdminLogService!.PostItemAsync(new AdminLogMessage() { Title = MessageTypesEnum.SUCCESS.ToString(), Message = "Site Settings reset!", Source = currentuser });
                    NavigationManager.NavigateTo("admin?reset=true", true);
                }
                else
                {
                    displaymessage = false;
                }
                break;
        }

        config = ConfigurationHelper.GetConfigurationData();

        if ((GeneralHelper.IsNotNull(message.Message)) && (displaymessage))
        {
            if (!String.IsNullOrEmpty(message.Message))
            {
                switch (message.Type)
                {
                    case MessageTypesEnum.INFORMATION:
                        toastService.ShowInfo(message.Message);
                        break;
                    case MessageTypesEnum.SUCCESS:
                        toastService.ShowSuccess(message.Message);
                        break;
                    case MessageTypesEnum.WARNING:
                        toastService.ShowWarning(message.Message);
                        break;
                    case MessageTypesEnum.ERROR:
                        toastService.ShowError(message.Message);
                        break;
                }
                await AdminLogService!.PostItemAsync(new AdminLogMessage() { Title = message.Type.ToString(), Message = message.Message, Source = currentuser });
            }
        }

        servicesData = await ServicesHelper.LoadServicesData(servicesData, admin);
        state.SetNavReload(true);
        StateHasChanged();

        if (redirect)
        {
            if (admin)
            {
                NavigationManager.NavigateTo(NavigationManager.Uri, true);
            }
            else
            {
                NavigationManager.NavigateTo("", true);
            }
        }

    }

    private void SetFormValue(string type, string value)
    {
        switch (type)
        {
            case "login":
                currentpassword = value;
                break;
            case "password":
                newpassword = value;
                // Validate the password complexity
                if (ValidationHelper.ValidatePassword(newpassword))
                {
                    disabled = false;
                }
                else
                {
                    disabled = true;
                }
                break;
            case "identityheadername":
                currentidentityheadername = value;
                break;
            case "apikey":
                currentapikey = value;
                break;
            case "namegenerationapikey":
                currentnamegenerationapikey = value;
                break;
            case "readonlyapikey":
                currentreadonlyapikey = value;
                break;
            case "generationwebhook":
                currentgenerationwebhook = value;
                break;
            case "customtoolname":
                customtoolname = value;
                break;
            case "newGlobalConfig":
                newGlobalConfig = value;
                break;
        }
    }

    private async void SettingChanged(ChangeEventArgs e, string setting)
    {
        message = new ResponseMessage();
        message.Header = "INFORMATION";
        message.Type = MessageTypesEnum.INFORMATION;
        try
        {
            if (GeneralHelper.IsNotNull(e.Value))
            {
                switch (setting)
                {
                    case "duplicatenamesallowed":
                        ConfigurationHelper.SetAppSetting("DuplicateNamesAllowed", e.Value.ToString()!);
                        message.Message = "Duplicate Names Allowed setting updated to " + e.Value.ToString()!.ToUpper() + "!";
                        break;
                    case "connectivitycheckenabled":
                        ConfigurationHelper.SetAppSetting("ConnectivityCheckEnabled", e.Value.ToString()!);
                        message.Message = "Connectivity Check Enabled setting updated to " + e.Value.ToString()!.ToUpper() + "!";
                        // Update the tool connection setting to true, if the connecvity check is disabled. This will cause the stie to always assume there is connectivity and attempt external connections.
                        if (!(bool)e.Value)
                        {
                            CacheHelper.SetCacheObject("isconnected", true);
                        }
                        else
                        {
                            CacheHelper.InvalidateCacheObject("isconnected");
                        }
                        if (!(bool)e.Value)
                        {
                            ModalHelper.ShowInformationModal(Modal!, theme, "bg-danger", "ATTENTION", "<p>Disabling this setting may result in connectivity errors being logged to the Admin Log.<p>", "", admin);
                        }

                        break;
                    case "resourcetypeeditingallowed":
                        if (GeneralHelper.IsNotNull(e.Value))
                        {
                            ConfigurationHelper.SetAppSetting("ResourceTypeEditingAllowed", e.Value!.ToString() ?? "");
                            message.Message = "Resource Type Editing Allowed setting updated to " + e.Value?.ToString()!.ToUpper() ?? "" + "!";
                            if ((bool)e.Value!)
                            {
                                ModalHelper.ShowInformationModal(Modal!, theme, "bg-danger", "ATTENTION", "<p>Disabling this setting may result in name generation that will fail regex validation for the resource type.</p><p>Please use caution when editing Resource Type validation settings.", "", admin);
                            }
                        }
                        break;
                    case "autoincrementresourceinstance":
                        if (GeneralHelper.IsNotNull(e.Value))
                        {
                            ConfigurationHelper.SetAppSetting("AutoIncrementResourceInstance", e.Value!.ToString() ?? "");
                            message.Message = "Auto Increment Resource Instance setting updated to " + e.Value?.ToString()!.ToUpper() ?? "" + "!";
                        }
                        break;
                    case "instructionsenabled":
                        if (GeneralHelper.IsNotNull(e.Value))
                        {
                            ConfigurationHelper.SetAppSetting("InstructionsEnabled", e.Value!.ToString() ?? "");
                            message.Message = "Instructions Enabled setting updated to " + e.Value?.ToString()!.ToUpper() ?? "" + "!";
                        }
                        break;
                    case "generatednameslogenabled":
                        if (GeneralHelper.IsNotNull(e.Value))
                        {
                            ConfigurationHelper.SetAppSetting("GeneratedNamesLogEnabled", e.Value!.ToString() ?? "");
                            message.Message = "Generated Names Log Enabled setting updated to " + e.Value?.ToString()!.ToUpper() ?? "" + "!";
                        }
                        break;
                    case "configurationenabled":
                        if (GeneralHelper.IsNotNull(e.Value))
                        {
                            ConfigurationHelper.SetAppSetting("ConfigurationEnabled", e.Value!.ToString() ?? "");
                            message.Message = "Configuration Enabled setting updated to " + e.Value?.ToString()!.ToUpper() ?? "" + "!";
                        }
                        break;
                    case "referenceenabled":
                        if (GeneralHelper.IsNotNull(e.Value))
                        {
                            ConfigurationHelper.SetAppSetting("ReferenceEnabled", e.Value!.ToString() ?? "");
                            message.Message = "Reference Enabled setting updated to " + e.Value?.ToString()!.ToUpper() ?? "" + "!";
                        }
                        break;
                    case "latestnewsenabled":
                        if (GeneralHelper.IsNotNull(e.Value))
                        {
                            ConfigurationHelper.SetAppSetting("LatestNewsEnabled", e.Value!.ToString() ?? "");
                            message.Message = "Latest News Enabled setting updated to " + e.Value?.ToString()!.ToUpper() ?? "" + "!";
                        }
                        break;
                    case "retaingenerateselections":
                        if (GeneralHelper.IsNotNull(e.Value))
                        {
                            ConfigurationHelper.SetAppSetting("RetainGenerateSelections", e.Value!.ToString() ?? "");
                            message.Message = "Retain Generate Selections setting updated to " + e.Value?.ToString()!.ToUpper() ?? "" + "!";
                        }
                        break;
                    case "showadmindetailstoallusers":
                        if (GeneralHelper.IsNotNull(e.Value))
                        {
                            ConfigurationHelper.SetAppSetting("ShowAdminDetailsToAllUsers", e.Value!.ToString() ?? "");
                            message.Message = "Show Admin Details To All Users setting updated to " + e.Value?.ToString()!.ToUpper() ?? "" + "!";
                        }
                        break;
                    case "azuretenantamevalidationenabled":
                        if (GeneralHelper.IsNotNull(e.Value))
                        {
                            ConfigurationHelper.SetAppSetting("AzureTenantNameValidationEnabled", e.Value!.ToString() ?? "");
                            azuretenantamevalidationenabled = (bool)e.Value!;
                            message.Message = "Azure Tenant Name Validation setting updated to " + e.Value?.ToString()!.ToUpper() ?? "" + "!";
                            StateHasChanged(); // Force UI refresh to show/hide Azure configuration section
                        }
                        break;
                }
                message.Type = MessageTypesEnum.SUCCESS;
                message.Header = "SUCCESS";
            }
            else
            {
                message.Message = "There was a problem updating the setting!";
                message.Header = "ERROR";
            }
        }
        catch (Exception ex)
        {
            await AdminLogService!.PostItemAsync(new AdminLogMessage() { Title = "ERROR", Message = ex.Message });
            message.Message = "There was a problem updating the setting!";
            message.Header = "ERROR";
        }

        if (GeneralHelper.IsNotNull(message.Message))
        {
            switch (message.Type)
            {
                case MessageTypesEnum.INFORMATION:
                    toastService.ShowInfo(message.Message);
                    break;
                case MessageTypesEnum.SUCCESS:
                    toastService.ShowSuccess(message.Message);
                    break;
                case MessageTypesEnum.WARNING:
                    toastService.ShowWarning(message.Message);
                    break;
                case MessageTypesEnum.ERROR:
                    toastService.ShowError(message.Message);
                    break;
            }
            await AdminLogService!.PostItemAsync(new AdminLogMessage() { Title = message.Type.ToString(), Message = message.Message, Source = currentuser });
        }

        servicesData = await ServicesHelper.LoadServicesData(servicesData, admin);
        state.SetNavReload(true);
        StateHasChanged();
    }

    private async Task OnConfigurationAlertDismissed()
    {
        await session.SetAsync("versionalert-" + appversion + "-shown", true);
        if (dismissalert)
        {
            ConfigurationHelper.DismissVersionAlert();
        }
    }

    private async void ShowVersionModal()
    {
        var parameters = new ModalParameters();
        parameters.Add("VersionNumber", appversion);
        parameters.Add("ReleaseNotesUrl", releasenotesurl);
        parameters.Add("VersionAlert", versionalert);
        
        var options = new ModalOptions()
        {
            HideHeader = false,
            HideCloseButton = false,
            Size = ModalSize.Large
        };
        
        Modal!.Show<VersionInfoModal>("Version Information", parameters, options);
    }

    private async void SubmitGHTopic(string type)
    {
        string githubURL = "";
        switch (type)
        {
            case "bug":
                githubURL = "https://github.com/mspnp/AzureNamingTool/issues/new?assignees=&labels=&projects=&template=bug_report.md&title=";
                break;
            case "feature":
                githubURL = "https://github.com/mspnp/AzureNamingTool/issues/new?assignees=&labels=&projects=&template=feature_request.md&title=";
                break;
            case "discussion":
                githubURL = "https://github.com/mspnp/AzureNamingTool/discussions/new/choose";
                break;
        }
        if (!String.IsNullOrEmpty(githubURL))
        {
            await JsRuntime.InvokeVoidAsync("open", githubURL, "_blank");
        }
    }

    private async void UploadLogo(InputFileChangeEventArgs e)
    {
        message = new ResponseMessage();
        message.Header = "INFORMATION";
        message.Type = MessageTypesEnum.INFORMATION;
        var workingmodaloptions = new ModalOptions()
            {
                HideCloseButton = true,
                UseCustomLayout = true
            };
        var workingmodal = Modal!.Show<WorkingModal>("Working", workingmodaloptions);
        try
        {

            var trustedFileName = Path.GetRandomFileName();
            await using FileStream fs = new(Path.Combine(Environment.CurrentDirectory, "wwwroot/images/" + e.File.Name), FileMode.Create);
            await e.File.OpenReadStream(maxFileSize).CopyToAsync(fs);
            ConfigurationHelper.SetAppSetting("CustomLogoPath", "images/" + e.File.Name ?? "");
            customlogopath = "images/" + e.File.Name;
            message.Message = "Custom Logo uploaded!";
        }
        catch (Exception ex)
        {
            await AdminLogService!.PostItemAsync(new AdminLogMessage() { Title = "ERROR", Message = ex.Message });
            message.Message = "There was a problem uploading the custom logo!";
            message.Header = "ERROR";
        }
        workingmodal.Close();
        if (GeneralHelper.IsNotNull(message.Message))
        {
            switch (message.Type)
            {
                case MessageTypesEnum.INFORMATION:
                    toastService.ShowInfo(message.Message);
                    break;
                case MessageTypesEnum.SUCCESS:
                    toastService.ShowSuccess(message.Message);
                    break;
                case MessageTypesEnum.WARNING:
                    toastService.ShowWarning(message.Message);
                    break;
                case MessageTypesEnum.ERROR:
                    toastService.ShowError(message.Message);
                    break;
            }
            await AdminLogService!.PostItemAsync(new AdminLogMessage() { Title = message.Type.ToString(), Message = message.Message, Source = currentuser });
        }
        StateHasChanged();
    }
    
    // Configuration Backup/Restore Methods
    
    private async Task FormAction(string type, long id, string action, string parentcomponent = "")
    {
        if (type == "Global")
        {
            message = new ResponseMessage();
            bool confirm = false;
            ServiceResponse serviceResponse = new();
            JsonSerializerOptions options = new JsonSerializerOptions
            {
                PropertyNameCaseInsensitive = true
            };
            
            var workingmodaloptions = new ModalOptions()
            {
                HideCloseButton = true,
                UseCustomLayout = true
            };
            
            if (GeneralHelper.IsNotNull(Modal))
            {
                var workingmodal = Modal.Show<WorkingModal>("Working", workingmodaloptions);
                try
                {
                    switch (action)
                    {
                        case "download":
                            serviceResponse = await ImportExportService!.ExportConfigAsync(includeAdmin);
                            if (serviceResponse.Success)
                            {
                                if (GeneralHelper.IsNotNull(serviceResponse.ResponseObject))
                                {
                                    var globaljson = serviceResponse.ResponseObject;
                                    if (GeneralHelper.IsNotNull(BlazorDownloadFileService))
                                    {
                                        await BlazorDownloadFileService.DownloadFileFromText("globalconfig.json", JsonSerializer.Serialize(globaljson).ToString(), System.Text.Encoding.UTF8, "application/octet-stream");
                                    }
                                }
                            }
                            break;
                        case "reset":
                            confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div style='margin: 1.5rem 0;'><p style='margin-bottom: 1rem;'>This will reset the current Global Configuration for all settings and cannot be undone!</p><p style='margin-bottom: 0;'>Are you sure?</p></div>", "bg-danger", theme);
                            if (confirm)
                            {
                                bool confirmglobalreset = await ModalHelper.ShowTextConfirmationModal(Modal!, "ATTENTION", "<div style='margin: 1.5rem 0;'><p style='font-weight: 600; margin-bottom: 1rem;'>Every setting of the site will be reset if you continue!</p><p style='margin-bottom: 1rem;'>It is recommended you take a backup of the configuration before proceeding!</p><p style='margin-bottom: 0;'><strong>Type CONFIRM to proceed:</strong></p></div>", "CONFIRM", "bg-danger", theme);
                                if (confirmglobalreset)
                                {
                                    try
                                    {
                                        // Log the global reset attempt
                                        await AdminLogService!.PostItemAsync(new AdminLogMessage() 
                                        { 
                                            Title = "INFORMATION", 
                                            Message = $"Global configuration reset started. Storage mode: {currentStorageProvider}" 
                                        });

                                        if (isUsingSQLite)
                                        {
                                            // For SQLite: Load all configuration from repository JSON files and save to database
                                            var repositoryPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "repository");
                                            
                                            // Reset all components using ImportExportService
                                            // This loads from repository files and saves to database
                                            var configData = new ConfigurationData();
                                            
                                            // Load each configuration type from repository
                                            JsonSerializerOptions jsonOptions = new JsonSerializerOptions
                                            {
                                                PropertyNameCaseInsensitive = true
                                            };
                                            
                                            // Load resource components
                                            var componentsJson = await File.ReadAllTextAsync(Path.Combine(repositoryPath, "resourcecomponents.json"));
                                            configData.ResourceComponents = JsonSerializer.Deserialize<List<ResourceComponent>>(componentsJson, jsonOptions)!;
                                            
                                            // Load resource delimiters
                                            var delimitersJson = await File.ReadAllTextAsync(Path.Combine(repositoryPath, "resourcedelimiters.json"));
                                            configData.ResourceDelimiters = JsonSerializer.Deserialize<List<ResourceDelimiter>>(delimitersJson, jsonOptions)!;
                                            
                                            // Load resource environments
                                            var environmentsJson = await File.ReadAllTextAsync(Path.Combine(repositoryPath, "resourceenvironments.json"));
                                            configData.ResourceEnvironments = JsonSerializer.Deserialize<List<ResourceEnvironment>>(environmentsJson, jsonOptions)!;
                                            
                                            // Load resource functions
                                            var functionsJson = await File.ReadAllTextAsync(Path.Combine(repositoryPath, "resourcefunctions.json"));
                                            configData.ResourceFunctions = JsonSerializer.Deserialize<List<ResourceFunction>>(functionsJson, jsonOptions)!;
                                            
                                            // Load resource locations
                                            var locationsJson = await File.ReadAllTextAsync(Path.Combine(repositoryPath, "resourcelocations.json"));
                                            configData.ResourceLocations = JsonSerializer.Deserialize<List<AzureNamingTool.Models.ResourceLocation>>(locationsJson, jsonOptions)!;
                                            
                                            // Load resource orgs
                                            var orgsJson = await File.ReadAllTextAsync(Path.Combine(repositoryPath, "resourceorgs.json"));
                                            configData.ResourceOrgs = JsonSerializer.Deserialize<List<ResourceOrg>>(orgsJson, jsonOptions)!;
                                            
                                            // Load resource project/app/services
                                            var projappsvcJson = await File.ReadAllTextAsync(Path.Combine(repositoryPath, "resourceprojappsvcs.json"));
                                            configData.ResourceProjAppSvcs = JsonSerializer.Deserialize<List<ResourceProjAppSvc>>(projappsvcJson, jsonOptions)!;
                                            
                                            // Load resource types
                                            var typesJson = await File.ReadAllTextAsync(Path.Combine(repositoryPath, "resourcetypes.json"));
                                            configData.ResourceTypes = JsonSerializer.Deserialize<List<ResourceType>>(typesJson, jsonOptions)!;
                                            
                                            // Load resource unit/depts
                                            var unitdeptsJson = await File.ReadAllTextAsync(Path.Combine(repositoryPath, "resourceunitdepts.json"));
                                            configData.ResourceUnitDepts = JsonSerializer.Deserialize<List<ResourceUnitDept>>(unitdeptsJson, jsonOptions)!;
                                            
                                            // Load custom components
                                            var customcomponentsJson = await File.ReadAllTextAsync(Path.Combine(repositoryPath, "customcomponents.json"));
                                            configData.CustomComponents = JsonSerializer.Deserialize<List<CustomComponent>>(customcomponentsJson, jsonOptions)!;
                                            
                                            await AdminLogService!.PostItemAsync(new AdminLogMessage() 
                                            { 
                                                Title = "INFORMATION", 
                                                Message = $"Global reset: Loaded all configuration from repository. Calling PostConfigAsync to save to database..." 
                                            });
                                            
                                            // Save all configuration to database
                                            var postResponse = await ImportExportService!.PostConfigAsync(configData);
                                            
                                            if (postResponse.Success)
                                            {
                                                await AdminLogService!.PostItemAsync(new AdminLogMessage() 
                                                { 
                                                    Title = "SUCCESS", 
                                                    Message = "Global reset: All configuration saved to database successfully" 
                                                });
                                                
                                                message.Type = MessageTypesEnum.SUCCESS;
                                                message.Message = "Global configuration reset! Page will refresh in 2 seconds...";
                                                
                                                // Force page refresh to show updated data
                                                await Task.Delay(2000);
                                                NavigationManager!.NavigateTo("/admin", true);
                                            }
                                            else
                                            {
                                                await AdminLogService!.PostItemAsync(new AdminLogMessage() 
                                                { 
                                                    Title = "ERROR", 
                                                    Message = $"Global reset failed: {postResponse.ResponseMessage}" 
                                                });
                                                
                                                message.Type = MessageTypesEnum.ERROR;
                                                message.Message = "Global configuration reset failed! Please check the Admin Log for details.";
                                                message.MessageDetails = postResponse.ResponseMessage;
                                            }
                                        }
                                        else
                                        {
                                            // For FileSystem: Use existing method which copies files and clears cache
                                            if (ConfigurationHelper.ResetSiteConfiguration())
                                            {
                                                await AdminLogService!.PostItemAsync(new AdminLogMessage() 
                                                { 
                                                    Title = "SUCCESS", 
                                                    Message = "Global reset (FileSystem): Files copied and cache cleared" 
                                                });
                                                
                                                message.Type = MessageTypesEnum.SUCCESS;
                                                message.Message = "Global configuration reset! Page will refresh in 2 seconds...";
                                                
                                                // Force page refresh to show updated data
                                                await Task.Delay(2000);
                                                NavigationManager!.NavigateTo("/admin", true);
                                            }
                                            else
                                            {
                                                message.Type = MessageTypesEnum.ERROR;
                                                message.Message = "Global configuration reset failed! Please check the Admin Log for details.";
                                            }
                                        }
                                    }
                                    catch (Exception ex)
                                    {
                                        await AdminLogService!.PostItemAsync(new AdminLogMessage() 
                                        { 
                                            Title = "ERROR", 
                                            Message = $"Global reset exception: {ex.Message}\nStackTrace: {ex.StackTrace}" 
                                        });
                                        
                                        message.Type = MessageTypesEnum.ERROR;
                                        message.Message = $"Global configuration reset failed: {ex.Message}";
                                    }
                                }
                            }
                            break;
                        case "update":
                            if (GeneralHelper.IsNotNull(newGlobalConfig))
                            {
                                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div style='margin: 1.5rem 0;'>This will update the current Global Configuration and cannot be undone!!</div><div style='margin: 1.5rem 0;'>Are you sure?</div>", "bg-danger", theme);
                                if (confirm)
                                {
                                    bool confirmglobalupdate = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div style='margin: 1.5rem 0;'><span style='font-weight: 600;'>Every setting of the site will be updated if you continue!</span></div><div style='margin: 1.5rem 0;'>It is recommended you take a backup of the configuration before proceeding!</div><div style='margin: 1.5rem 0;'>Continue?</div>", "bg-danger", theme);
                                    if (confirmglobalupdate)
                                    {
                                        serviceResponse = await ImportExportService!.PostConfigAsync(JsonSerializer.Deserialize<ConfigurationData>(newGlobalConfig, options)!);
                                        if (serviceResponse.Success)
                                        {
                                            message.Type = MessageTypesEnum.SUCCESS;
                                            message.Message = "Global config update succeeded!";
                                            newGlobalConfig = String.Empty;
                                        }
                                        else
                                        {
                                            message.Type = MessageTypesEnum.ERROR;
                                            message.Message = "Global config update failed! Please check the Admin Log for details.";
                                            message.MessageDetails = serviceResponse.ResponseMessage;
                                        }
                                    }
                                }
                            }
                            break;
                    }
                }
                catch (Exception ex)
                {
                    message.Type = MessageTypesEnum.ERROR;
                    message.Message = $"Operation failed: {ex.Message}";
                }
                finally
                {
                    workingmodal.Close();
                }
            }
            
            // Show message if there is one
            if (!String.IsNullOrEmpty(message.Message))
            {
                await InvokeAsync(() =>
                {
                    string bgcolor = message.Type == MessageTypesEnum.SUCCESS ? "bg-success" : 
                                   message.Type == MessageTypesEnum.WARNING ? "bg-warning" : "bg-danger";
                    ModalHelper.ShowInformationModal(Modal!, theme, bgcolor, message.Type.ToString(), message.Message, message.MessageDetails, admin);
                    StateHasChanged();
                });
                
                await AdminLogService!.PostItemAsync(new AdminLogMessage() { Title = message.Type.ToString(), Message = message.Message, Source = currentuser });
            }
            
            StateHasChanged();
        }
    }
    
    private async Task DownloadDatabaseFile()
    {
        string? tempBackupPath = null;
        try
        {
            // Get the database path from configuration (e.g., "settings/azurenamingtool.db")
            string dbRelativePath = Configuration?.GetValue<string>("StorageOptions:DatabasePath") ?? "settings/azurenamingtool.db";
            string dbPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, dbRelativePath);
            
            if (!File.Exists(dbPath))
            {
                await InvokeAsync(() =>
                {
                    ModalHelper.ShowInformationModal(Modal!, theme, "bg-danger", "ERROR", 
                        $"Database file not found at: {dbPath}. Ensure you are using SQLite storage.", "", admin);
                    StateHasChanged();
                });
                return;
            }

            // Create a temporary copy to avoid file lock issues
            // Use SQLite's VACUUM INTO command which creates a clean backup
            string dbDirectory = Path.GetDirectoryName(dbPath)!;
            tempBackupPath = Path.Combine(dbDirectory, $"temp_backup_{Guid.NewGuid()}.db");
            
            // Use VACUUM INTO to create a backup copy
            // This command creates a clean, defragmented copy of the database
            using (var connection = new Microsoft.Data.Sqlite.SqliteConnection($"Data Source={dbPath}"))
            {
                await connection.OpenAsync();
                using (var command = connection.CreateCommand())
                {
                    command.CommandText = $"VACUUM INTO '{tempBackupPath.Replace("\\", "\\\\")}'";
                    await command.ExecuteNonQueryAsync();
                }
                await connection.CloseAsync();
            }
            
            // Wait for file system to release handles
            await Task.Delay(500);
            
            // Read the backup file with retry logic
            byte[] fileBytes;
            int retryCount = 0;
            while (true)
            {
                try
                {
                    fileBytes = await File.ReadAllBytesAsync(tempBackupPath);
                    break;
                }
                catch (IOException) when (retryCount < 5)
                {
                    retryCount++;
                    await Task.Delay(200);
                }
            }
            string fileName = $"azurenamingtool-backup-{DateTime.Now:yyyyMMdd-HHmmss}.db";
            
            await BlazorDownloadFileService!.DownloadFile(fileName, fileBytes, "application/x-sqlite3");
            
            await InvokeAsync(() =>
            {
                ModalHelper.ShowInformationModal(Modal!, theme, "bg-success", "SUCCESS", 
                    $"Database file downloaded successfully: {fileName}", "", admin);
                StateHasChanged();
            });

            // Log the backup
            AdminLogMessage adminLogMessage = new()
            {
                Title = "INFORMATION",
                Message = $"Database backup downloaded: {fileName} (Size: {FormatFileSize(fileBytes.Length)})"
            };
            await AdminLogService!.PostItemAsync(adminLogMessage);
        }
        catch (Exception ex)
        {
            await InvokeAsync(() =>
            {
                ModalHelper.ShowInformationModal(Modal!, theme, "bg-danger", "ERROR", 
                    $"Failed to download database file: {ex.Message}", "", admin);
                StateHasChanged();
            });

            AdminLogMessage adminLogMessage = new()
            {
                Title = "ERROR",
                Message = $"Database backup download failed: {ex.Message}"
            };
            await AdminLogService!.PostItemAsync(adminLogMessage);
        }
        finally
        {
            // Clean up temporary backup file with retry logic
            if (!string.IsNullOrEmpty(tempBackupPath) && File.Exists(tempBackupPath))
            {
                // Try to delete with retries (file handles may still be releasing)
                for (int i = 0; i < 5; i++)
                {
                    try
                    {
                        // Force garbage collection to release any lingering handles
                        GC.Collect();
                        GC.WaitForPendingFinalizers();
                        
                        await Task.Delay(200);
                        File.Delete(tempBackupPath);
                        break; // Success
                    }
                    catch (IOException) when (i < 4)
                    {
                        // File still locked, wait and retry
                        await Task.Delay(500);
                    }
                    catch (Exception) when (i == 4)
                    {
                        // Final attempt failed, but don't throw to avoid breaking the backup process
                    }
                }
            }
        }
    }

    private async Task ExportConfigurationAsJson()
    {
        try
        {
            var response = await ImportExportService!.ExportConfigAsync(includeAdmin);
            if (!response.Success || response.ResponseObject == null)
            {
                throw new Exception("Failed to export configuration data");
            }

            string jsonData = System.Text.Json.JsonSerializer.Serialize(response.ResponseObject);
            string fileName = $"azurenamingtool-config-{DateTime.Now:yyyyMMdd-HHmmss}.json";
            byte[] fileBytes = System.Text.Encoding.UTF8.GetBytes(jsonData);
            
            await BlazorDownloadFileService!.DownloadFile(fileName, fileBytes, "application/json");
            
            await InvokeAsync(() =>
            {
                ModalHelper.ShowInformationModal(Modal!, theme, "bg-success", "SUCCESS", 
                    $"Configuration exported successfully: {fileName}", "", admin);
                StateHasChanged();
            });

            // Log the export
            AdminLogMessage adminLogMessage = new()
            {
                Title = "INFORMATION",
                Message = $"Configuration JSON export: {fileName} (Size: {FormatFileSize(fileBytes.Length)}, Include Admin: {includeAdmin})"
            };
            await AdminLogService!.PostItemAsync(adminLogMessage);
        }
        catch (Exception ex)
        {
            await InvokeAsync(() =>
            {
                ModalHelper.ShowInformationModal(Modal!, theme, "bg-danger", "ERROR", 
                    $"Failed to export configuration: {ex.Message}", "", admin);
                StateHasChanged();
            });

            AdminLogMessage adminLogMessage = new()
            {
                Title = "ERROR",
                Message = $"Configuration JSON export failed: {ex.Message}"
            };
            await AdminLogService!.PostItemAsync(adminLogMessage);
        }
    }

    private void HandleSQLiteDatabaseUpload(InputFileChangeEventArgs e)
    {
        sqliteBackupFile = e.File;
        StateHasChanged();
    }

    private void HandleJsonConfigUpload(InputFileChangeEventArgs e)
    {
        jsonBackupFile = e.File;
        StateHasChanged();
    }

    private async Task RestoreFromSQLiteBackup()
    {
        if (sqliteBackupFile == null)
        {
            await InvokeAsync(() =>
            {
                ModalHelper.ShowInformationModal(Modal!, theme, "bg-warning", "WARNING", 
                    "Please select a database file to restore.", "", admin);
                StateHasChanged();
            });
            return;
        }

        // Validate file extension
        if (!sqliteBackupFile.Name.EndsWith(".db", StringComparison.OrdinalIgnoreCase))
        {
            await InvokeAsync(() =>
            {
                ModalHelper.ShowInformationModal(Modal!, theme, "bg-danger", "ERROR", 
                    "Invalid file type. Please select a .db file.", "", admin);
                StateHasChanged();
            });
            return;
        }

        // Show text confirmation modal (user must type CONFIRM to confirm)
        string confirmMessage = $"<div style='margin: 1.5rem 0;'>" +
            $"<p>You are about to restore the database from:</p>" +
            $"<p><strong>{sqliteBackupFile.Name}</strong> ({FormatFileSize(sqliteBackupFile.Size)})</p>" +
            $"<p class=\"text-danger mt-3\"><strong>‚ö†Ô∏è WARNING:</strong> This will completely replace your current database!</p>" +
            $"<ul class=\"text-danger text-start\">" +
            $"<li>All current data will be lost</li>" +
            $"<li>A pre-restore backup will be created automatically</li>" +
            $"<li>The application will restart immediately</li>" +
            $"<li><strong>All active users will be disconnected</strong></li>" +
            $"</ul>" +
            $"<p class=\"text-info mt-3\"><i class=\"bi bi-info-circle\"></i> The restore process will:</p>" +
            $"<ol class=\"text-start\">" +
            $"<li>Create a backup of your current database</li>" +
            $"<li>Prepare the uploaded database for restore</li>" +
            $"<li>Automatically restart the application</li>" +
            $"<li>Complete the restore on startup</li>" +
            $"</ol>" +
            $"<p class=\"mt-3\">This is a critical administrative operation.</p></div>";

        bool confirmed = await ModalHelper.ShowTextConfirmationModal(
            Modal!, 
            "Confirm Database Restore", 
            confirmMessage, 
            "CONFIRM", 
            "bg-warning", 
            theme
        );

        if (!confirmed)
        {
            return;
        }

        try
        {
            // Get the database path from configuration (e.g., "settings/azurenamingtool.db")
            string dbRelativePath = Configuration?.GetValue<string>("StorageOptions:DatabasePath") ?? "settings/azurenamingtool.db";
            string dbPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, dbRelativePath);
            
            // Ensure the settings directory exists
            string dbDirectory = Path.GetDirectoryName(dbPath)!;
            if (!Directory.Exists(dbDirectory))
            {
                Directory.CreateDirectory(dbDirectory);
            }
            
            // Save uploaded file as pending restore
            string pendingRestorePath = Path.Combine(dbDirectory, "azurenamingtool-pending-restore.db");
            string backupPath = Path.Combine(dbDirectory, $"azurenamingtool-prerestore-{DateTime.Now:yyyyMMdd-HHmmss}.db");

            // Create a backup of the current database before restoring
            if (File.Exists(dbPath))
            {
                File.Copy(dbPath, backupPath, true);
            }

            // Save the uploaded file as pending restore
            using (var stream = sqliteBackupFile.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024)) // 50MB max
            {
                using (var fileStream = new FileStream(pendingRestorePath, FileMode.Create))
                {
                    await stream.CopyToAsync(fileStream);
                }
            }
            
            // Create a flag file to indicate pending restore
            string flagPath = Path.Combine(dbDirectory, "restore-pending.flag");
            await File.WriteAllTextAsync(flagPath, $"Restore from: {sqliteBackupFile.Name}\nTimestamp: {DateTime.Now:yyyy-MM-dd HH:mm:ss}\nBackup: {Path.GetFileName(backupPath)}");

            // Log the restore preparation
            AdminLogMessage adminLogMessage = new()
            {
                Title = "INFORMATION",
                Message = $"Database restore prepared from: {sqliteBackupFile.Name} (Size: {FormatFileSize(sqliteBackupFile.Size)}). Pre-restore backup saved. Restart required."
            };
            await AdminLogService!.PostItemAsync(adminLogMessage);

            await InvokeAsync(() =>
            {
                ModalHelper.ShowInformationModal(Modal!, theme, "bg-success", "RESTORE PREPARED", 
                    $"<div style='margin: 1.5rem 0;'>" +
                    $"<p><i class=\"bi bi-check-circle\"></i> Database restore has been prepared successfully!</p>" +
                    $"<p class=\"text-info\"><strong>Pre-restore backup:</strong> {Path.GetFileName(backupPath)}</p>" +
                    $"<hr class=\"my-3\"/>" +
                    $"<p><i class=\"bi bi-arrow-repeat\"></i> <strong>The application will restart in 3 seconds...</strong></p>" +
                    $"<p class=\"text-warning\"><i class=\"bi bi-exclamation-triangle\"></i> <strong>Development Mode:</strong></p>" +
                    $"<ul class=\"text-start text-warning\">" +
                    $"<li>The application will stop</li>" +
                    $"<li>Restart it manually with: <code>dotnet run</code></li>" +
                    $"<li>Then refresh this page</li>" +
                    $"</ul>" +
                    $"<p class=\"text-muted small\"><strong>Production Mode:</strong> The application will restart automatically and this page will reload.</p></div>", 
                    "", admin);
                StateHasChanged();
            });

            // Add JavaScript to attempt auto-reload when server comes back
            await JsRuntime.InvokeVoidAsync("eval", @"
                setTimeout(function() {
                    var checkInterval = setInterval(function() {
                        fetch('/')
                            .then(function(response) {
                                if (response.ok) {
                                    clearInterval(checkInterval);
                                    window.location.href = '/';
                                }
                            })
                            .catch(function() {
                                // Server still down, keep checking
                            });
                    }, 2000);
                }, 3000);
            ");

            // Trigger application restart - the restore will complete on startup
            await Task.Delay(3000);
            AppLifetime.StopApplication();
        }
        catch (Exception ex)
        {
            await InvokeAsync(() =>
            {
                ModalHelper.ShowInformationModal(Modal!, theme, "bg-danger", "ERROR", 
                    $"Failed to restore database: {ex.Message}", "", admin);
                StateHasChanged();
            });

            AdminLogMessage adminLogMessage = new()
            {
                Title = "ERROR",
                Message = $"Database restore failed: {ex.Message}"
            };
            await AdminLogService!.PostItemAsync(adminLogMessage);
        }
    }

    private async Task RestoreFromJsonBackup()
    {
        if (jsonBackupFile == null)
        {
            await InvokeAsync(() =>
            {
                ModalHelper.ShowInformationModal(Modal!, theme, "bg-warning", "WARNING", 
                    "Please select a JSON file to restore.", "", admin);
                StateHasChanged();
            });
            return;
        }

        // Validate file extension
        if (!jsonBackupFile.Name.EndsWith(".json", StringComparison.OrdinalIgnoreCase))
        {
            await InvokeAsync(() =>
            {
                ModalHelper.ShowInformationModal(Modal!, theme, "bg-danger", "ERROR", 
                    "Invalid file type. Please select a .json file.", "", admin);
                StateHasChanged();
            });
            return;
        }

        // Show confirmation modal
        string confirmMessage = $"<div style='margin: 1.5rem 0;'><p>You are about to restore configuration from:</p>" +
            $"<p><strong>{jsonBackupFile.Name}</strong> ({FormatFileSize(jsonBackupFile.Size)})</p>" +
            $"<p class=\"text-warning\"><strong>NOTE:</strong> This will overwrite your current configuration data!</p>" +
            $"<p>This works with both pre-migration and post-migration JSON exports.</p>" +
            $"<p>Do you want to proceed?</p></div>";

        bool confirmed = await ModalHelper.ShowConfirmationModal(Modal!, "Confirm JSON Restore", confirmMessage, "bg-warning", theme);

        if (!confirmed)
        {
            return;
        }

        try
        {
            // Read the uploaded JSON file
            string jsonContent;
            using (var stream = jsonBackupFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024)) // 10MB max
            {
                using (var reader = new StreamReader(stream))
                {
                    jsonContent = await reader.ReadToEndAsync();
                }
            }

            // Validate JSON format
            ConfigurationData? configData;
            try
            {
                configData = System.Text.Json.JsonSerializer.Deserialize<ConfigurationData>(jsonContent);
                if (configData == null)
                {
                    throw new Exception("Deserialized configuration data is null.");
                }
            }
            catch (Exception ex)
            {
                await InvokeAsync(() =>
                {
                    ModalHelper.ShowInformationModal(Modal!, theme, "bg-danger", "ERROR", 
                        $"Invalid JSON format: {ex.Message}", "", admin);
                    StateHasChanged();
                });
                return;
            }

            // Import the configuration using the existing ImportExportService
            var result = await ImportExportService!.PostConfigAsync(configData);

            if (result.Success)
            {
                await InvokeAsync(() =>
                {
                    ModalHelper.ShowInformationModal(Modal!, theme, "bg-success", "SUCCESS", 
                        $"<div style='margin: 1.5rem 0;'><p>Configuration restored successfully from JSON!</p>" +
                        $"<p>The page will refresh in 2 seconds...</p></div>", "", admin);
                    StateHasChanged();
                });

                // Log the restore
                AdminLogMessage adminLogMessage = new()
                {
                    Title = "INFORMATION",
                    Message = $"Configuration restored from JSON: {jsonBackupFile.Name} (Size: {FormatFileSize(jsonBackupFile.Size)})"
                };
                await AdminLogService!.PostItemAsync(adminLogMessage);

                // Refresh the page
                await Task.Delay(2000);
                NavigationManager!.NavigateTo("/admin", true);
            }
            else
            {
                await InvokeAsync(() =>
                {
                    ModalHelper.ShowInformationModal(Modal!, theme, "bg-danger", "ERROR", 
                        "Failed to restore configuration from JSON. Check the log for details.", "", admin);
                    StateHasChanged();
                });

                AdminLogMessage adminLogMessage = new()
                {
                    Title = "ERROR",
                    Message = $"Configuration restore from JSON failed: {jsonBackupFile.Name}"
                };
                await AdminLogService!.PostItemAsync(adminLogMessage);
            }
        }
        catch (Exception ex)
        {
            await InvokeAsync(() =>
            {
                ModalHelper.ShowInformationModal(Modal!, theme, "bg-danger", "ERROR", 
                    $"Failed to restore configuration: {ex.Message}", "", admin);
                StateHasChanged();
            });

            AdminLogMessage adminLogMessage = new()
            {
                Title = "ERROR",
                Message = $"Configuration restore from JSON failed: {ex.Message}"
            };
            await AdminLogService!.PostItemAsync(adminLogMessage);
        }
    }

    // Individual Component Import/Export Methods
    private void OnComponentTypeSelected(string componentType)
    {
        selectedComponentType = componentType;
        componentImportJson = String.Empty;
        selectedFileName = String.Empty;
        StateHasChanged();
    }

    private async Task OnComponentFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        
        if (file == null)
        {
            toastService.ShowWarning("No file selected.");
            return;
        }

        // Check file extension
        if (!file.Name.EndsWith(".json", StringComparison.OrdinalIgnoreCase))
        {
            toastService.ShowError("Please select a JSON file (.json).");
            selectedFileName = String.Empty;
            componentImportJson = String.Empty;
            return;
        }

        // Check file size (limit to 10MB)
        const long maxFileSize = 10 * 1024 * 1024;
        if (file.Size > maxFileSize)
        {
            toastService.ShowError($"File size exceeds the maximum allowed size of {maxFileSize / (1024 * 1024)} MB.");
            selectedFileName = String.Empty;
            componentImportJson = String.Empty;
            return;
        }

        try
        {
            // Read file contents
            using var stream = file.OpenReadStream(maxFileSize);
            using var reader = new StreamReader(stream);
            componentImportJson = await reader.ReadToEndAsync();
            selectedFileName = file.Name;
            
            // Validate JSON format
            try
            {
                System.Text.Json.JsonDocument.Parse(componentImportJson);
                toastService.ShowSuccess($"File '{file.Name}' loaded successfully.");
            }
            catch
            {
                toastService.ShowError("The selected file does not contain valid JSON.");
                componentImportJson = String.Empty;
                selectedFileName = String.Empty;
            }
        }
        catch (Exception ex)
        {
            toastService.ShowError($"Error reading file: {ex.Message}");
            componentImportJson = String.Empty;
            selectedFileName = String.Empty;
        }
        
        StateHasChanged();
    }

    private string GetComponentDisplayName(string componentType)
    {
        return componentType switch
        {
            "ResourceType" => "Resource Types",
            "ResourceLocation" => "Locations",
            "ResourceEnvironment" => "Environments",
            "ResourceOrg" => "Organizations",
            "ResourceProjAppSvc" => "Projects/Apps/Services",
            "ResourceUnitDept" => "Units/Departments",
            "ResourceFunction" => "Functions",
            "ResourceDelimiter" => "Delimiters",
            "CustomComponent" => "Custom Components",
            _ => componentType
        };
    }

    private async Task ExportComponentData()
    {
        if (String.IsNullOrEmpty(selectedComponentType))
        {
            toastService.ShowWarning("Please select a component type to export.");
            return;
        }

        try
        {
            ServiceResponse response;
            object? data = null;

            switch (selectedComponentType)
            {
                case "ResourceType":
                    response = await ResourceTypeService!.GetItemsAsync(true);
                    data = response.ResponseObject;
                    break;
                case "ResourceLocation":
                    response = await ResourceLocationService!.GetItemsAsync(true);
                    data = response.ResponseObject;
                    break;
                case "ResourceEnvironment":
                    response = await ResourceEnvironmentService!.GetItemsAsync(true);
                    data = response.ResponseObject;
                    break;
                case "ResourceOrg":
                    response = await ResourceOrgService!.GetItemsAsync(true);
                    data = response.ResponseObject;
                    break;
                case "ResourceProjAppSvc":
                    response = await ResourceProjAppSvcService!.GetItemsAsync(true);
                    data = response.ResponseObject;
                    break;
                case "ResourceUnitDept":
                    response = await ResourceUnitDeptService!.GetItemsAsync(true);
                    data = response.ResponseObject;
                    break;
                case "ResourceFunction":
                    response = await ResourceFunctionService!.GetItemsAsync(true);
                    data = response.ResponseObject;
                    break;
                case "ResourceDelimiter":
                    response = await ResourceDelimiterService!.GetItemsAsync(true);
                    data = response.ResponseObject;
                    break;
                case "CustomComponent":
                    response = await CustomComponentService!.GetItemsAsync(true);
                    data = response.ResponseObject;
                    break;
                default:
                    toastService.ShowError("Unknown component type selected.");
                    return;
            }

            if (data == null)
            {
                toastService.ShowError("Failed to retrieve component data.");
                return;
            }

            // Serialize to JSON
            string jsonData = System.Text.Json.JsonSerializer.Serialize(data, new System.Text.Json.JsonSerializerOptions
            {
                WriteIndented = true
            });

            // Download the file
            string fileName = $"{selectedComponentType.ToLower()}-{DateTime.Now:yyyyMMdd-HHmmss}.json";
            byte[] fileBytes = System.Text.Encoding.UTF8.GetBytes(jsonData);
            
            await BlazorDownloadFileService!.DownloadFile(fileName, fileBytes, "application/json");
            
            toastService.ShowSuccess($"{GetComponentDisplayName(selectedComponentType)} exported successfully!");
            
            await AdminLogService!.PostItemAsync(new AdminLogMessage() 
            { 
                Title = "INFORMATION", 
                Message = $"Component exported: {GetComponentDisplayName(selectedComponentType)} to {fileName}"
            });
        }
        catch (Exception ex)
        {
            toastService.ShowError($"Failed to export component: {ex.Message}");
            await AdminLogService!.PostItemAsync(new AdminLogMessage() 
            { 
                Title = "ERROR", 
                Message = $"Component export failed: {ex.Message}"
            });
        }
    }

    private async Task ImportComponentData()
    {
        if (String.IsNullOrEmpty(selectedComponentType))
        {
            toastService.ShowWarning("Please select a component type to import.");
            return;
        }

        if (String.IsNullOrEmpty(componentImportJson))
        {
            toastService.ShowWarning("Please enter JSON data to import.");
            return;
        }

        // Show confirmation modal
        string confirmMessage = $"<div style='margin: 1.5rem 0;'><p>You are about to import {GetComponentDisplayName(selectedComponentType)} configuration.</p>" +
            $"<p class=\"text-danger\"><strong>WARNING:</strong> This will overwrite your current {GetComponentDisplayName(selectedComponentType)} data!</p>" +
            $"<p>Do you want to proceed?</p></div>";

        bool confirmed = await ModalHelper.ShowConfirmationModal(Modal!, $"Confirm {GetComponentDisplayName(selectedComponentType)} Import", confirmMessage, "bg-warning", theme);

        if (!confirmed)
        {
            return;
        }

        try
        {
            ServiceResponse response;

            switch (selectedComponentType)
            {
                case "ResourceType":
                    var resourceTypes = System.Text.Json.JsonSerializer.Deserialize<List<ResourceType>>(componentImportJson);
                    if (resourceTypes == null) throw new Exception("Invalid JSON format for Resource Types.");
                    response = await ResourceTypeService!.PostConfigAsync(resourceTypes);
                    break;
                case "ResourceLocation":
                    var resourceLocations = System.Text.Json.JsonSerializer.Deserialize<List<Models.ResourceLocation>>(componentImportJson);
                    if (resourceLocations == null) throw new Exception("Invalid JSON format for Locations.");
                    response = await ResourceLocationService!.PostConfigAsync(resourceLocations);
                    break;
                case "ResourceEnvironment":
                    var resourceEnvironments = System.Text.Json.JsonSerializer.Deserialize<List<ResourceEnvironment>>(componentImportJson);
                    if (resourceEnvironments == null) throw new Exception("Invalid JSON format for Environments.");
                    response = await ResourceEnvironmentService!.PostConfigAsync(resourceEnvironments);
                    break;
                case "ResourceOrg":
                    var resourceOrgs = System.Text.Json.JsonSerializer.Deserialize<List<ResourceOrg>>(componentImportJson);
                    if (resourceOrgs == null) throw new Exception("Invalid JSON format for Organizations.");
                    response = await ResourceOrgService!.PostConfigAsync(resourceOrgs);
                    break;
                case "ResourceProjAppSvc":
                    var resourceProjAppSvcs = System.Text.Json.JsonSerializer.Deserialize<List<ResourceProjAppSvc>>(componentImportJson);
                    if (resourceProjAppSvcs == null) throw new Exception("Invalid JSON format for Projects/Apps/Services.");
                    response = await ResourceProjAppSvcService!.PostConfigAsync(resourceProjAppSvcs);
                    break;
                case "ResourceUnitDept":
                    var resourceUnitDepts = System.Text.Json.JsonSerializer.Deserialize<List<ResourceUnitDept>>(componentImportJson);
                    if (resourceUnitDepts == null) throw new Exception("Invalid JSON format for Units/Departments.");
                    response = await ResourceUnitDeptService!.PostConfigAsync(resourceUnitDepts);
                    break;
                case "ResourceFunction":
                    var resourceFunctions = System.Text.Json.JsonSerializer.Deserialize<List<ResourceFunction>>(componentImportJson);
                    if (resourceFunctions == null) throw new Exception("Invalid JSON format for Functions.");
                    response = await ResourceFunctionService!.PostConfigAsync(resourceFunctions);
                    break;
                case "ResourceDelimiter":
                    var resourceDelimiters = System.Text.Json.JsonSerializer.Deserialize<List<ResourceDelimiter>>(componentImportJson);
                    if (resourceDelimiters == null) throw new Exception("Invalid JSON format for Delimiters.");
                    response = await ResourceDelimiterService!.PostConfigAsync(resourceDelimiters);
                    break;
                case "CustomComponent":
                    var customComponents = System.Text.Json.JsonSerializer.Deserialize<List<CustomComponent>>(componentImportJson);
                    if (customComponents == null) throw new Exception("Invalid JSON format for Custom Components.");
                    response = await CustomComponentService!.PostConfigAsync(customComponents);
                    break;
                default:
                    toastService.ShowError("Unknown component type selected.");
                    return;
            }

            if (response.Success)
            {
                toastService.ShowSuccess($"{GetComponentDisplayName(selectedComponentType)} imported successfully!");
                
                await AdminLogService!.PostItemAsync(new AdminLogMessage() 
                { 
                    Title = "INFORMATION", 
                    Message = $"Component imported: {GetComponentDisplayName(selectedComponentType)}"
                });

                // Clear the import JSON
                componentImportJson = String.Empty;
                
                // Refresh the data
                await Task.Delay(1000);
                NavigationManager!.NavigateTo("/admin", true);
            }
            else
            {
                toastService.ShowError($"Failed to import {GetComponentDisplayName(selectedComponentType)}: {response.ResponseMessage}");
                
                await AdminLogService!.PostItemAsync(new AdminLogMessage() 
                { 
                    Title = "ERROR", 
                    Message = $"Component import failed: {GetComponentDisplayName(selectedComponentType)} - {response.ResponseMessage}"
                });
            }
        }
        catch (System.Text.Json.JsonException ex)
        {
            toastService.ShowError($"Invalid JSON format: {ex.Message}");
            await AdminLogService!.PostItemAsync(new AdminLogMessage() 
            { 
                Title = "ERROR", 
                Message = $"Component import failed - Invalid JSON: {ex.Message}"
            });
        }
        catch (Exception ex)
        {
            toastService.ShowError($"Failed to import component: {ex.Message}");
            await AdminLogService!.PostItemAsync(new AdminLogMessage() 
            { 
                Title = "ERROR", 
                Message = $"Component import failed: {ex.Message}"
            });
        }
    }

    // Azure Validation Methods
    private async Task TestAzureConnection()
    {
        testingConnection = true;
        azureConnectionTested = false;
        StateHasChanged();

        try
        {
            if (AzureValidationService == null)
            {
                azureConnectionSuccess = false;
                azureConnectionError = "Azure Validation Service is not available. Ensure Azure SDK packages are installed.";
                azureConnectionTested = true;
                return;
            }

            // Test the connection
            var testResult = await AzureValidationService.TestConnectionAsync();

            azureConnectionSuccess = testResult.Authenticated;
            azureConnectionTested = true;

            if (testResult.Authenticated)
            {
                // Get settings to show connection details
                var settings = await AzureValidationService.GetSettingsAsync();
                if (settings != null)
                {
                    azureConnectionDetails = settings.AuthMode.ToString();
                    azureTenantInfo = settings.TenantId ?? "Default";
                    azureSubscriptionCount = testResult.AccessibleSubscriptions.Count;
                }

                // Replace availableSubscriptions with fresh data from Azure
                availableSubscriptions = testResult.AccessibleSubscriptions.ToList();
                
                // selectedSubscriptionIds is preserved from settings and checkbox interactions
                // Remove any selected subscriptions that are no longer accessible
                var accessibleSubIds = availableSubscriptions.Select(s => s.SubscriptionId).ToHashSet();
                selectedSubscriptionIds.RemoveWhere(id => !accessibleSubIds.Contains(id));
                
                toastService.ShowSuccess("Successfully connected to Azure!");
                
                await AdminLogService!.PostItemAsync(new AdminLogMessage()
                {
                    Title = "INFORMATION",
                    Message = $"Azure connection test successful. Auth: {azureConnectionDetails}, Subscriptions: {azureSubscriptionCount}"
                });
            }
            else
            {
                azureConnectionError = testResult.ErrorMessage ?? "Unknown error occurred during connection test.";
                toastService.ShowError("Azure connection test failed: " + azureConnectionError);
                
                await AdminLogService!.PostItemAsync(new AdminLogMessage()
                {
                    Title = "WARNING",
                    Message = $"Azure connection test failed: {azureConnectionError}"
                });
            }
        }
        catch (Exception ex)
        {
            azureConnectionSuccess = false;
            azureConnectionTested = true;
            azureConnectionError = $"Exception during connection test: {ex.Message}";
            
            toastService.ShowError("Connection test failed: " + ex.Message);
            
            await AdminLogService!.PostItemAsync(new AdminLogMessage()
            {
                Title = "ERROR",
                Message = $"Azure connection test exception: {ex.Message}"
            });
        }
        finally
        {
            testingConnection = false;
            StateHasChanged();
        }
    }

    private void ToggleSubscription(string subscriptionId, bool isChecked)
    {
        if (isChecked)
        {
            selectedSubscriptionIds.Add(subscriptionId);
        }
        else
        {
            selectedSubscriptionIds.Remove(subscriptionId);
        }
    }

    private async Task SaveAzureValidationSettings()
    {
        try
        {
            if (AzureValidationService == null)
            {
                toastService.ShowError("Azure Validation Service is not available.");
                return;
            }

            // Get current settings
            var settings = await AzureValidationService.GetSettingsAsync();
            if (settings == null)
            {
                settings = new AzureValidationSettings
                {
                    Enabled = azuretenantamevalidationenabled
                };
            }

            // Update settings from UI
            settings.Enabled = azuretenantamevalidationenabled;
            settings.AuthMode = Enum.Parse<AuthenticationMode>(azureAuthMode);
            settings.ConflictResolution.Strategy = Enum.Parse<ConflictStrategy>(azureConflictStrategy);
            settings.Cache.Enabled = azureCacheEnabled;
            settings.Cache.DurationMinutes = azureCacheDuration;

            // Parse and update subscription IDs from checkbox selection
            settings.SubscriptionIds.Clear();
            foreach (var subId in selectedSubscriptionIds)
            {
                if (!string.IsNullOrWhiteSpace(subId) && Guid.TryParse(subId, out _))
                {
                    settings.SubscriptionIds.Add(subId);
                }
            }

            // Update Service Principal settings if applicable
            if (azureAuthMode == "ServicePrincipal")
            {
                if (!string.IsNullOrEmpty(azureTenantId))
                {
                    settings.TenantId = azureTenantId;
                }
                
                if (settings.ServicePrincipal == null)
                {
                    settings.ServicePrincipal = new ServicePrincipalSettings();
                }
                
                if (!string.IsNullOrEmpty(azureClientId))
                {
                    settings.ServicePrincipal.ClientId = azureClientId;
                }
            }

            // Save settings
            await AzureValidationService.UpdateSettingsAsync(settings);

            toastService.ShowSuccess("Azure validation settings saved successfully!");
            
            await AdminLogService!.PostItemAsync(new AdminLogMessage()
            {
                Title = "INFORMATION",
                Message = $"Azure validation settings updated. Auth: {azureAuthMode}, Strategy: {azureConflictStrategy}"
            });

            // Reset connection test status to prompt re-test
            azureConnectionTested = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            toastService.ShowError("Failed to save settings: " + ex.Message);
            
            await AdminLogService!.PostItemAsync(new AdminLogMessage()
            {
                Title = "ERROR",
                Message = $"Failed to save Azure validation settings: {ex.Message}"
            });
        }
    }
}








