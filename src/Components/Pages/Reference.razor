@page "/reference"
@using AzureNamingTool.Helpers
@using AzureNamingTool.Models
@using AzureNamingTool.Services
@using AzureNamingTool.Services.Interfaces
@using System.Text.RegularExpressions
@inject IJSRuntime JsRuntime
@inject ILogger<Reference> Logger
@inject NavigationManager NavigationManager
@inject StateContainer state
@inject IToastService toastService
@inject ServicesHelper ServicesHelper

<PageTitle>Azure Naming Tool - Reference</PageTitle>

<div class="modern-page-container">
    <div class="modern-page-title">
        <h1>Reference</h1>
    </div>
    
    <div class="modern-page-description">
        <p>View example names for each resource type using the defined configuration</p>
    </div>
    
    <div class="modern-page-actions">
        <button class="modern-btn-secondary" title="Instructions" @onclick="@(e => ModalHelper.ShowInformationModal(Modal!, theme, "bg-navcolor", "Reference", String.Empty, "referenceinstructions", false))">
            <span class="oi oi-document" aria-hidden="true"></span> Documentation
        </button>
        <button type="button" class="modern-btn-secondary" @onclick="@ExpandAll" title="Expand all sections">
            <span class="oi oi-fullscreen-enter" aria-hidden="true"></span> Expand All
        </button>
        <button type="button" class="modern-btn-secondary" @onclick="@CollapseAll" title="Collapse all sections">
            <span class="oi oi-fullscreen-exit" aria-hidden="true"></span> Collapse All
        </button>
    </div>
</div>

<div class="modern-card">
    <div class="modern-card-body">
        @if (servicesData.ResourceTypes == null)
        {
            <div class="modern-spinner-container">
                <div class="modern-spinner"></div>
            </div>
        }
        else
        {
            <div class="modern-filter-section mb-4">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="modern-form-label">Resource Type Provider (Optional)</label>
                        <select @onchange="OnCategoryChanged" class="modern-form-input" aria-label="Select category">
                            <option value="">Select a resource type provider...</option>
                            @foreach (var category in @categories)
                            {
                                <option value="@category">@category</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="modern-form-label">Resource Type</label>
                        <select @onchange="OnTypeChanged" class="modern-form-input" aria-label="Select type">
                            <option value="">Select a resource type...</option>
                            @foreach (var type in @ResourceTypeService.GetFilteredResourceTypes(servicesData.ResourceTypes, selectedResourceTypeCategory))
                            {
                                @if (!String.IsNullOrEmpty(type.Property))
                                {
                                    <option value="@type.Id">@type.Resource - @type.Property (@type.ShortName)</option>
                                }
                                else
                                {
                                    <option value="@type.Id">@type.Resource (@type.ShortName)</option>
                                }
                            }
                        </select>
                    </div>
                </div>
            </div>

            @foreach (var resourcetype in servicesData.ResourceTypes)
            {
                if (!IsTypeVisible(resourcetype))
                    continue;
                
                <div class="modern-card mb-2" id="@resourcetype.Id">
                    <div class="modern-card-header collapsible @(GetCollapseClass(resourcetype.Id.ToString()))" @onclick="@(() => ToggleCollapse(resourcetype.Id.ToString()))">
                        @if (!String.IsNullOrEmpty(resourcetype.Property))
                        {
                            <h3>
                                <span class="oi oi-chevron-bottom" aria-hidden="true"></span> @resourcetype.Resource - @resourcetype.Property
                            </h3>
                        }
                        else
                        {
                            <h3>
                                <span class="oi oi-chevron-bottom" aria-hidden="true"></span> @resourcetype.Resource
                            </h3>
                        }
                    </div>
                    <div class="modern-card-body @(GetCollapseClass(resourcetype.Id.ToString()))">
                        @if (filteredscopes.Contains(resourcetype.Scope))
                        {
                            <div class="modern-alert-success mb-3">
                                <strong>Example:</strong> @GenerateName(resourcetype, resourcetype.ShortName, resourcetype.StaticValues)
                            </div>
                        }
                        else
                        {
                            <div class="modern-alert-warning mb-3">
                                <strong>Note:</strong> This resource has a lower-level scope and does not require a unique name.
                            </div>
                        }

                        @if (String.IsNullOrEmpty(resourcetype.StaticValues))
                        {
                            <div class="modern-table-container">
                                <table class="modern-table">
                                    <tbody>
                                        @if (filteredscopes.Contains(resourcetype.Scope))
                                        {
                                            <tr class="modern-table-section-header">
                                                <td colspan="2">
                                                    <strong>Components</strong>
                                                </td>
                                            </tr>
                                            @foreach (var resourceComponent in servicesData.ResourceComponents!)
                                            {
                                                if (!resourcetype.Exclude.ToLower().Split(',').Contains(GeneralHelper.NormalizeName(resourceComponent.Name, true)))
                                                {
                                                    if (!resourcetype.Optional.ToLower().Split(',').Contains(GeneralHelper.NormalizeName(resourceComponent.Name, true)))
                                                    {
                                                        switch (resourceComponent.Name)
                                                        {
                                                            case "ResourceEnvironment":
                                                                <tr>
                                                                    <td class="modern-table-label">
                                                                        Environment:
                                                                    </td>
                                                                    <td style="word-wrap:anywhere;overflow-wrap:anywhere;white-space: normal;">
                                                                        @servicesData.ResourceEnvironments![0].Name (@servicesData.ResourceEnvironments[0].ShortName)
                                                                    </td>
                                                                </tr>
                                                                break;
                                                            case "ResourceInstance":
                                                                <tr>
                                                                    <td class="modern-table-label">
                                                                        Instance:
                                                                    </td>
                                                                    <td style="word-wrap:anywhere;white-space: normal;">
                                                                        1
                                                                    </td>
                                                                </tr>
                                                                break;
                                                            case "ResourceLocation":
                                                                <tr>
                                                                    <td class="modern-table-label">
                                                                        Location:
                                                                    </td>
                                                                    <td style="word-wrap:anywhere;overflow-wrap:anywhere;white-space: normal;">
                                                                        @servicesData.ResourceLocations![0].Name (@servicesData.ResourceLocations[0].ShortName)
                                                                    </td>
                                                                </tr>
                                                                break;
                                                            case "ResourceOrg":
                                                                <tr>
                                                                    <td class="modern-table-label">
                                                                        Org:
                                                                    </td>
                                                                    <td style="word-wrap:anywhere;overflow-wrap:anywhere;white-space: normal;">
                                                                        @servicesData.ResourceOrgs![0].Name (@servicesData.ResourceOrgs[0].ShortName)
                                                                    </td>
                                                                </tr>
                                                                break;
                                                            case "ResourceProjAppSvc":
                                                                <tr>
                                                                    <td class="modern-table-label">
                                                                        ProjAppSvc:
                                                                    </td>
                                                                    <td style="word-wrap:anywhere;overflow-wrap:anywhere;white-space: normal;">
                                                                        @servicesData.ResourceProjAppSvcs![0].Name (@servicesData.ResourceProjAppSvcs[0].ShortName)
                                                                    </td>
                                                                </tr>
                                                                break;
                                                            case "ResourceType":
                                                                <tr>
                                                                    <td class="modern-table-label">
                                                                        Type:
                                                                    </td>
                                                                    <td style="word-wrap:anywhere;overflow-wrap:anywhere;white-space: normal;">
                                                                        @resourcetype.Resource (@resourcetype.ShortName)
                                                                    </td>
                                                                </tr>
                                                                break;
                                                            case "ResourceUnitDept":
                                                                <tr>
                                                                    <td class="modern-table-label">
                                                                        Unit/Dept:
                                                                    </td>
                                                                    <td style="word-wrap:anywhere;overflow-wrap:anywhere;white-space: normal;">
                                                                        @servicesData.ResourceUnitDepts![0].Name (@servicesData.ResourceUnitDepts[0].ShortName)
                                                                    </td>
                                                                </tr>
                                                                break;
                                                            case "ResourceFunction":
                                                                <tr>
                                                                    <td class="modern-table-label">
                                                                        Function:
                                                                    </td>
                                                                    <td style="word-wrap:anywhere;overflow-wrap:anywhere;white-space: normal;">
                                                                        @servicesData.ResourceFunctions![0].Name (@servicesData.ResourceFunctions![0].ShortName)
                                                                    </td>
                                                                </tr>
                                                                break;
                                                            default:
                                                                if (resourceComponent.IsCustom)
                                                                {
                                                                    @if (!resourceComponent.IsFreeText)
                                                                    {
                                                                        if (servicesData.CustomComponents!.Where(x => x.ParentComponent == GeneralHelper.NormalizeName(resourceComponent.Name, true)).Count() > 0)
                                                                        {
                                                                            <tr>
                                                                                <td class="modern-table-label">
                                                                                    @resourceComponent.Name:
                                                                                </td>
                                                                                <td style="word-wrap:anywhere;overflow-wrap:anywhere;white-space: normal;">
                                                                                    <span>
                                                                                        @servicesData.CustomComponents!.Where(x => x.ParentComponent == GeneralHelper.NormalizeName(resourceComponent.Name, true)).FirstOrDefault()!.Name
                                                                                        (@servicesData.CustomComponents!.Where(x => x.ParentComponent == GeneralHelper.NormalizeName(resourceComponent.Name, true)).FirstOrDefault()!.ShortName)
                                                                                    </span>
                                                                                </td>
                                                                            </tr>
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        <tr>
                                                                            <td class="modern-table-label">
                                                                                @resourceComponent.Name:
                                                                            </td>
                                                                            <td style="word-wrap:anywhere;overflow-wrap:anywhere;white-space: normal;">
                                                                                <span>
                                                                                    [Free Form / Random]
                                                                                </span>
                                                                            </td>
                                                                        </tr>
                                                                    }
                                                                }
                                                                break;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        <tr class="modern-table-section-header">
                                            <td colspan="2">
                                                <strong>Naming Guidelines</strong>
                                            </td>
                                        </tr>
                                        @if (!String.IsNullOrEmpty(@resourcetype.Optional))
                                        {
                                            <tr>
                                                <td class="modern-table-label">
                                                    Optional Components:
                                                </td>
                                                <td style="word-wrap:anywhere;overflow-wrap:anywhere;white-space: normal;">
                                                    @resourcetype.Optional
                                                </td>
                                            </tr>
                                        }
                                        @if (!String.IsNullOrEmpty(@resourcetype.Exclude))
                                        {
                                            <tr>
                                                <td class="modern-table-label">
                                                    Excluded Components:
                                                </td>
                                                <td style="word-wrap:anywhere;overflow-wrap:anywhere;white-space: normal;">
                                                    @resourcetype.Exclude
                                                </td>
                                            </tr>
                                        }
                                        @if (!String.IsNullOrEmpty(@resourcetype.ShortName))
                                        {
                                            <tr>
                                                <td class="modern-table-label">
                                                    Short Name:
                                                </td>
                                                <td style="word-wrap:anywhere;overflow-wrap:anywhere;white-space: normal;">
                                                    @resourcetype.ShortName
                                                </td>
                                            </tr>
                                        }
                                        @if (!String.IsNullOrEmpty(@resourcetype.Scope))
                                        {
                                            <tr>
                                                <td class="modern-table-label">
                                                    Scope:
                                                </td>
                                                <td style="word-wrap:anywhere;overflow-wrap:anywhere;white-space: normal;">
                                                    @resourcetype.Scope
                                                </td>
                                            </tr>
                                        }
                                        @if ((!String.IsNullOrEmpty(@resourcetype.LengthMin)) && (!String.IsNullOrEmpty(@resourcetype.LengthMax)))
                                        {
                                            <tr>
                                                <td class="modern-table-label">
                                                    Length:
                                                </td>
                                                <td style="word-wrap:anywhere;overflow-wrap:anywhere;white-space: normal;">
                                                    @resourcetype.LengthMin - @resourcetype.LengthMax characters
                                                </td>
                                            </tr>
                                        }
                                        @if (!String.IsNullOrEmpty(@resourcetype.ValidText))
                                        {
                                            <tr>
                                                <td class="modern-table-label">
                                                    Valid Characters:
                                                </td>
                                                <td style="word-wrap:anywhere;overflow-wrap:anywhere;white-space: normal;">
                                                    @resourcetype.ValidText
                                                </td>
                                            </tr>
                                        }
                                        @if (!String.IsNullOrEmpty(@resourcetype.InvalidCharacters))
                                        {
                                            <tr>
                                                <td class="modern-table-label">
                                                    Invalid Characters:
                                                </td>
                                                <td style="word-wrap:anywhere;overflow-wrap:anywhere;white-space: normal;">
                                                    @resourcetype.InvalidCharacters
                                                </td>
                                            </tr>
                                        }
                                        @if (!String.IsNullOrEmpty(@resourcetype.Regx))
                                        {
                                            <tr>
                                                <td class="modern-table-label">
                                                    Regx:
                                                </td>
                                                <td style="word-wrap:anywhere;overflow-wrap:anywhere;white-space: normal;">
                                                    @resourcetype.Regx
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="modern-alert-info">
                                This resource type has a unique naming pattern and must be manually named.
                            </div>
                        }
                    </div>
                </div>
            }
        }
    </div>
</div>


@code {
    [CascadingParameter]
    protected ThemeInfo theme { get; set; } = new();
    [CascadingParameter]
    public IModalService? Modal { get; set; }
    
    [Inject]
    public IResourceTypeService? ResourceTypeService { get; set; }
    
    [Inject]
    public IAdminLogService? AdminLogService { get; set; }
    
    private ServicesData servicesData = new();
    private ResourceDelimiter? resourceDelimiter = new();
    public string filterData { get; set; } = String.Empty;
    private string selectedResourceTypeCategory = String.Empty;
    private string[] filteredscopes = new string[] { "resource group", "resource group & region", "region", "global", "subscription", "tenant" };
    private List<string> categories = new();
    private HashSet<string> collapsedSections = new();

    protected override async Task OnInitializedAsync()
    {
        await SetServicesData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (servicesData == null)
        {
            await SetServicesData();
        }
    }

    private async Task SetServicesData()
    {
        try
        {
            servicesData = await ServicesHelper.LoadServicesData(servicesData, false);
            if (GeneralHelper.IsNotNull(servicesData))
            {
                resourceDelimiter = (ResourceDelimiter)servicesData.ResourceDelimiters![0];

                // Get the list of categories
                categories = ResourceTypeService.GetTypeCategories(servicesData.ResourceTypes!);
                
                // Initialize all sections as collapsed by default
                collapsedSections = new HashSet<string>(servicesData.ResourceTypes!.Select(rt => rt.Id.ToString()));
            }
            else
            {
                toastService.ShowError("There was a problem loading the page. Please try again");
            }
        }
        catch (Exception ex)
        {
            await AdminLogService.PostItemAsync(new AdminLogMessage() { Title = "ERROR", Message = ex.Message });
            toastService.ShowError("There was a problem loading the page. Please try again");
        }
    }

    protected string GenerateName(ResourceType type, string shortName, string staticvalues)
    {
        var name = "";
        if (String.IsNullOrEmpty(staticvalues))
        {
            foreach (ResourceComponent resourceComponent in servicesData.ResourceComponents!)
            {
                string normalizedcomponentname = GeneralHelper.NormalizeName(resourceComponent.Name, true);
                // Check if the component is excluded for the resource type
                if (!type.Exclude.ToLower().Split(',').Contains(normalizedcomponentname))
                {
                    // Remove any optional components
                    if (!type.Optional.ToLower().Split(',').Contains(normalizedcomponentname))
                    {
                        if (name != "")
                        {
                            name += resourceDelimiter!.Delimiter;
                        }
                        switch (resourceComponent.Name)
                        {
                            case "ResourceEnvironment":
                                name += servicesData.ResourceEnvironments![0].ShortName;
                                break;
                            case "ResourceFunction":
                                name += servicesData.ResourceFunctions![0].ShortName;
                                break;
                            case "ResourceInstance":
                                name += "1";
                                break;
                            case "ResourceLocation":
                                name += servicesData.ResourceLocations![0].ShortName;
                                break;
                            case "ResourceOrg":
                                name += servicesData.ResourceOrgs![0].ShortName;
                                break;
                            case "ResourceProjAppSvc":
                                name += servicesData.ResourceProjAppSvcs![0].ShortName;
                                break;
                            case "ResourceType":
                                name += shortName;
                                break;
                            case "ResourceUnitDept":
                                name += servicesData.ResourceUnitDepts![0].ShortName;
                                break;
                            default:
                                if (resourceComponent.IsCustom)
                                {
                                    if (!resourceComponent.IsFreeText)
                                    {
                                        if (servicesData.CustomComponents!.Where(x => x.ParentComponent.ToLower() == normalizedcomponentname).Count() > 0)
                                        {
                                            name += servicesData.CustomComponents!.Where(x => x.ParentComponent.ToLower() == normalizedcomponentname).FirstOrDefault()!.ShortName;
                                        }
                                    }
                                    else
                                    {
                                        name += GeneralHelper.GenerateRandomString(Convert.ToInt32(resourceComponent.MaxLength), resourceComponent.Alphanumeric);
                                    }
                                }
                                break;
                        }
                    }
                }
            }

            // Check if the resource type only allows lowercase
            if (!type.Regx.Contains("A-Z"))
            {
                name = name.ToLower();
            }

            // Apply the regex to the generate name
            Regex regx = new(type.Regx);
            Match match = regx.Match(name);
            if (!match.Success)
            {
                // Strip the delimiter in case that is causing the issue
                if (!String.IsNullOrEmpty(resourceDelimiter!.Delimiter))
                {
                    name = name.Replace(resourceDelimiter!.Delimiter, "");
                }
            }
        }
        else
        {
            name = staticvalues;
        }
        return name;
    }

    private void OnCategoryChanged(ChangeEventArgs e)
    {
        selectedResourceTypeCategory = e.Value!.ToString()!;

    }

    private async void OnTypeChanged(ChangeEventArgs e)
    {
        await JsRuntime.InvokeVoidAsync("scrollIntoView", e.Value!.ToString());
    }

    private void OnInstructionsClick()
    {
        NavigationManager.NavigateTo("instructions");
    }

    public bool IsTypeVisible(ResourceType type)
    {
        bool visible = true;

        if (!string.IsNullOrEmpty(filterData))
        {
            if ((!type.Resource.Contains(filterData, StringComparison.OrdinalIgnoreCase)) && (!type.ShortName.Contains(filterData, StringComparison.OrdinalIgnoreCase)))
                visible = false;
        }
        return visible;
    }
    
    private void ToggleCollapse(string section)
    {
        if (collapsedSections.Contains(section))
        {
            collapsedSections.Remove(section);
        }
        else
        {
            collapsedSections.Add(section);
        }
    }

    private string GetCollapseClass(string section)
    {
        return collapsedSections.Contains(section) ? "collapsed" : "";
    }
    
    private void ExpandAll()
    {
        collapsedSections.Clear();
    }
    
    private void CollapseAll()
    {
        if (servicesData.ResourceTypes != null)
        {
            collapsedSections = new HashSet<string>(
                servicesData.ResourceTypes.Select(rt => rt.Id.ToString())
            );
        }
    }
}
