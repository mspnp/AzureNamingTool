@page "/generate"
@using AzureNamingTool.Helpers
@using AzureNamingTool.Models
@using AzureNamingTool.Services
@using AzureNamingTool.Services.Interfaces
@using AzureNamingTool.Components.Modals;
@using System.Text;
@using AzureNamingTool.Components.General;
@inject ILogger<Generate> Logger
@inject NavigationManager NavigationManager
@inject StateContainer state
@inject ProtectedSessionStorage session
@inject IJSRuntime JsRuntime
@inject IToastService toastService
@inject ServicesHelper ServicesHelper

<PageTitle>Azure Naming Tool - Generate</PageTitle>

<div class="modern-page-container">
    <div class="modern-page-title">
        <h1>Generate</h1>
    </div>
    
    <div class="modern-page-description">
        <p>Generate a name for the selected resource type</p>
    </div>
    
    <div class="modern-page-actions">
        <button class="modern-btn-secondary" title="Instructions" @onclick="@(e => ModalHelper.ShowInformationModal(Modal!, theme, "bg-navcolor", "Generate", String.Empty, "generateinstructions", false))">
            <span class="oi oi-document" aria-hidden="true"></span> Documentation
        </button>
    </div>
</div>

<div class="modern-card">
    <div class="modern-card-body">
        <div class="modern-card mb-4">
            <div class="modern-card-header collapsible @(GetCollapseClass("instructions"))" @onclick="@(() => ToggleCollapse("instructions"))">
                <h3>
                    <span class="oi oi-chevron-bottom" aria-hidden="true"></span> Instructions
                </h3>
            </div>
            <div class="modern-card-body @(GetCollapseClass("instructions"))" id="instructions">
                <ol>
                    <li>
                        Select the desired Resource Type / Resource Types
                    </li>
                    <li>
                        Review the Naming Guidelines (for single resource type)
                    </li>
                    <li>
                        Select the component options
                    </li>
                    <li>
                        Click <span class="fw-bold">Generate</span> to generate the Azure resource name(s)
                    </li>
                    <li>
                        View generated names in the <a href="/generatednameslog" class="modern-link">Generated Names Log</a>
                    </li>
                </ol>
            </div>
        </div>
        @if (servicesData.ResourceTypes == null)
        {
            <div class="spinner-border" role="status">
                <span class="sr-only"></span>
            </div>
        }
        else
        {
            <EditForm Model="@resourceNameRequest" OnValidSubmit="@HandleValidSubmit">
                <DataAnnotationsValidator />
                <ValidationSummary />
                <div id="generator">
                    <div class="modern-card mb-3">
                        <div class="modern-card-header">
                            <h5 class="modern-card-title mb-0">Generate Mode</h5>
                        </div>
                        <div class="modern-card-body">
                            <div class="modern-radio-group">
                                <div class="modern-radio-item">
                                    <input class="modern-radio-input" type="radio" name="generateselect" id="singleselect" value="single" checked @onclick="@(e => OnGenerateModeChange("single"))">
                                    <label class="modern-radio-label" for="singleselect">
                                        <div class="modern-radio-title">Generate Single Resource Type Name</div>
                                        <div class="modern-radio-description">This option will allow the generation of a single resource type name using the selected components.</div>
                                    </label>
                                </div>
                                <div class="modern-radio-item">
                                    <input class="modern-radio-input" type="radio" name="generateselect" id="multiselect" value="multi" @onclick="@(e => OnGenerateModeChange("multi"))">
                                    <label class="modern-radio-label" for="multiselect">
                                        <div class="modern-radio-title">Generate Multiple Resource Type Names</div>
                                        <div class="modern-radio-description">This option will allow the generation of names for multiple resource types using the selected components. <span class="modern-text-warning">All components will be required (Optional and Excluded Components).</span></div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modern-card mb-3 @resourcetypeVisible" id="single">
                        <div class="modern-card-header">
                            <h5 class="modern-card-title mb-0">Resource Type</h5>
                        </div>
                        <div class="modern-card-body">
                            <p>
                                Select the desired resource type.
                            </p>
                            <div class="mb-3">
                                <div class="modern-input-group">
                                    <span class="modern-input-group-icon">
                                        <span class="oi oi-magnifying-glass"></span>
                                    </span>
                                    <input @bind-value="@selectedResourceTypeCategory" @oninput="(EventArgs) => { OnCategoryChanged(EventArgs.Value!.ToString()!);}" class="modern-form-input" list="categorieslist" id="generatecategories" placeholder="Type to filter by category..." autocomplete="off">
                                    <datalist id="categorieslist">
                                        @foreach (var category in @categories)
                                        {
                                            <option value="@category">@category</option>
                                        }
                                    </datalist>
                                </div>
                                <div class="modern-input-group mt-2">
                                    <span class="modern-input-group-icon">
                                        <span class="oi oi-magnifying-glass"></span>
                                    </span>
                                    <input @bind-value="@selectedResourceTypeDisplayName" @oninput="(EventArgs) => { OnTypeChanged(EventArgs.Value!.ToString()!).GetAwaiter();}" class="modern-form-input" list="typeslist" id="generatetypes" placeholder="Type to search resource types..." autocomplete="off">
                                    <datalist id="typeslist">
                                        @foreach (var type in @ResourceTypeService.GetFilteredResourceTypes(servicesData.ResourceTypes, selectedResourceTypeCategory))
                                        {
                                            @if (!String.IsNullOrEmpty(type.Property))
                                            {
                                                <option value="@type.Resource - @type.Property (@type.ShortName)"></option>
                                            }
                                            else
                                            {
                                                <option value="@type.Resource (@type.ShortName)"></option>
                                            }
                                        }
                                    </datalist>
                                </div>
                            </div>
                            <div class="mb-3">
                                <button type="button" class="modern-btn-success" title="Clear" @onclick="@(e => ResetForm(true))">
                                    <span class="oi oi-reload" aria-hidden="true"></span> Clear
                                </button>
                            </div>
                            @if (GeneralHelper.IsNotNull(currentResourceType))
                            {
                                @if (!filteredscopes.Contains(currentResourceType.Scope))
                                {
                                    <div class="modern-alert-warning mt-3">
                                        <strong>Note:</strong> This resource has a lower-level scope and does not require a unique name.
                                    </div>
                                }
                                <div id="guidelines" class="modern-card mt-3">
                                    <div class="modern-card-header modern-card-header-collapsible @(GetCollapseClass("namingguidelines"))" @onclick="@(() => ToggleCollapse("namingguidelines"))">
                                        <span class="oi oi-chevron-bottom modern-collapse-icon" aria-hidden="true"></span>
                                        <span class="modern-card-title">Naming Guidelines</span>
                                    </div>
                                    <div class="modern-card-body @(GetCollapseClass("namingguidelines"))" id="namingguidelines">
                                        @if (!String.IsNullOrEmpty(currentResourceType.LengthMin))
                                        {
                                            <div class="mb-2"><strong>Minimum Length:</strong> @currentResourceType.LengthMin</div>
                                        }
                                        @if (!String.IsNullOrEmpty(currentResourceType.LengthMax))
                                        {
                                            <div class="mb-2"><strong>Maximum Length:</strong> @currentResourceType.LengthMax</div>
                                        }
                                        @if (!String.IsNullOrEmpty(currentResourceType.ValidText))
                                        {
                                            <div class="mb-2"><strong>Valid Text:</strong> @currentResourceType.ValidText</div>
                                        }
                                        @if (!String.IsNullOrEmpty(currentResourceType.Optional))
                                        {
                                            <div class="mb-2"><strong>Optional:</strong> @currentResourceType.Optional</div>
                                        }
                                        @if (!String.IsNullOrEmpty(currentResourceType.Exclude))
                                        {
                                            <div class="mb-2"><strong>Excluded:</strong> @currentResourceType.Exclude</div>
                                        }
                                        @if (!String.IsNullOrEmpty(currentResourceType.Regx))
                                        {
                                            <div class="mb-2"><strong>Regx:</strong> @currentResourceType.Regx</div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                    <div class="modern-card mb-3 @resourcetypesVisible" id="multi">
                        <div class="modern-card-header">
                            <h5 class="modern-card-title mb-0">Resource Types</h5>
                        </div>
                        <div class="modern-card-body">
                            <p>The current selected resource types.</p>
                            <ul>
                                @foreach (string id in multiselectedResourceTypes)
                                {
                                    ResourceType thistype = servicesData.ResourceTypes.Find(x => x.Id == Convert.ToInt32(id))!;
                                    @if (GeneralHelper.IsNotNull(thistype))
                                    {
                                        <li>
                                            @if (!String.IsNullOrEmpty(thistype.Property))
                                            {
                                                <span>@thistype.Resource - @thistype.Property (@thistype.ShortName)</span>
                                            }
                                            else
                                            {
                                                <span>@thistype.Resource (@thistype.ShortName)</span>
                                            }
                                        </li>
                                    }
                                }
                            </ul>
                            <div class="mt-3">
                                <button type="button" title="Select" class="modern-btn-primary" @onclick="OnSelectResourceTypesClick">
                                    <span class="oi oi-list" aria-hidden="true"></span> Select
                                </button>
                                <button type="button" class="modern-btn-success" title="Clear" @onclick="OnClearClick">
                                    <span class="oi oi-reload" aria-hidden="true"></span> Clear
                                </button>
                            </div>

                        </div>
                    </div>

                    @if (((!String.IsNullOrEmpty(selectedResourceType)) && (GeneralHelper.IsNotNull(currentResourceType))) || (multiselectedResourceTypes.Count > 0))
                    {
                        @if (componentsVisible == "collapse")
                        {
                            <div class="mt-3 mb-3">
                                <button type="button" title="Show/Hide Components" class="modern-btn-primary" @onclick="@(() => ToggleCollapse("components"))">
                                    <span class="oi oi-eye" aria-hidden="true"></span> Show/Hide Components
                                </button>
                            </div>
                        }

                        <div class="@componentsVisible @(GetCollapseClass("components"))" id="components">
                            @foreach (ResourceComponent resourceComponent in servicesData.ResourceComponents!)
                            {
                                if ((!selectedResourceTypeExclude.ToLower().Split(',').Contains(GeneralHelper.NormalizeName(resourceComponent.Name, true))) || (multiselectedResourceTypes.Count > 0))
                                {
                                    switch (resourceComponent.Name)
                                    {
                                        case "ResourceEnvironment":
                                            <div class="modern-card mb-3">
                                                <div class="modern-card-header"><h5 class="modern-card-title mb-0">
                                                    @resourceComponent.DisplayName
                                                    @if (((selectedResourceTypeOptional.ToLower().Split(',').Contains("environment")) && (multiselectedResourceTypes.Count == 0)))
                                                    {
                                                        @((MarkupString)optional)
                                                    }
                                                </h5></div><div class="modern-card-body">
                                                    @if (!String.IsNullOrEmpty(resourceComponent.Description))
                                                    {
                                                        <p>@resourceComponent.Description</p>
                                                    }
                                                    <InputSelect title="@resourceComponent.DisplayName" class="modern-form-input" ValueExpression="@(()=>selectedResourceEnvironment)"
                                                                 Value="@selectedResourceEnvironment"
                                                                 ValueChanged="@((string value) => OnComponentChanged("re",value))">
                                                        <option value="">Select an environment</option>
                                                        @foreach (var item in @servicesData.ResourceEnvironments!)
                                                        {
                                                            <option value="@item.ShortName">@item.Name (@item.ShortName)</option>
                                                        }
                                                    </InputSelect>
                                                </div>
                                            </div>
                                            break;
                                        case "ResourceFunction":
                                            <div class="modern-card mb-3">
                                                <div class="modern-card-header"><h5 class="modern-card-title mb-0">
                                                    @resourceComponent.DisplayName
                                                    @if (((selectedResourceTypeOptional.ToLower().Split(',').Contains("function")) && (multiselectedResourceTypes.Count == 0)))
                                                    {
                                                        @((MarkupString)optional)
                                                    }
                                                </h5></div><div class="modern-card-body">
                                                    @if (!String.IsNullOrEmpty(resourceComponent.Description))
                                                    {
                                                        <p>@resourceComponent.Description</p>
                                                    }
                                                    <InputSelect title="@resourceComponent.DisplayName" class="modern-form-input" ValueExpression="@(()=>selectedResourceFunction)"
                                                                 Value="@selectedResourceFunction"
                                                                 ValueChanged="@((string value) => OnComponentChanged("rf",value))">
                                                        <option value="">Select a Function</option>
                                                        @foreach (var item in @servicesData.ResourceFunctions!)
                                                        {
                                                            <option value="@item.ShortName">@item.Name (@item.ShortName)</option>
                                                        }
                                                    </InputSelect>
                                                </div>
                                            </div>
                                            break;
                                        case "ResourceInstance":
                                            <div class="modern-card mb-3">
                                                <div class="modern-card-header"><h5 class="modern-card-title mb-0">
                                                    @resourceComponent.DisplayName
                                                    @if (int.Parse(resourceComponent.MinLength) == int.Parse(resourceComponent.MaxLength))
                                                    {
                                                        <span> (@resourceComponent.MinLength digits) </span>
                                                    }
                                                    else
                                                    {
                                                        <span> (@resourceComponent.MinLength - @resourceComponent.MaxLength digits) </span>
                                                    }
                                                    @if (((selectedResourceTypeOptional.ToLower().Split(',').Contains("instance")) && (multiselectedResourceTypes.Count == 0)))
                                                    {
                                                        @((MarkupString)optional)
                                                    }
                                                </h5></div><div class="modern-card-body">
                                                    @if (!String.IsNullOrEmpty(resourceComponent.Description))
                                                    {
                                                        <p>@resourceComponent.Description</p>
                                                    }
                                                    <InputText title="@resourceComponent.DisplayName" class="modern-form-input" id="ri" ValueExpression="@(()=>selectedResourceInstance)"
                                                               Value="@selectedResourceInstance" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))"
                                                               ValueChanged="@((string value) => OnComponentChanged("ri",value))" />
                                                </div>
                                            </div>
                                            break;
                                        case "ResourceLocation":
                                            <div class="modern-card mb-3">
                                                <div class="modern-card-header"><h5 class="modern-card-title mb-0">
                                                    @resourceComponent.DisplayName
                                                    @if (((selectedResourceTypeOptional.ToLower().Split(',').Contains("location")) && (multiselectedResourceTypes.Count == 0)))
                                                    {
                                                        @((MarkupString)optional)
                                                    }
                                                </h5></div><div class="modern-card-body">
                                                    @if (!String.IsNullOrEmpty(resourceComponent.Description))
                                                    {
                                                        <p>@resourceComponent.Description</p>
                                                    }
                                                    <InputSelect title="@resourceComponent.DisplayName" class="modern-form-input" ValueExpression="@(()=>selectedResourceLocation)"
                                                                 Value="@selectedResourceLocation"
                                                                 ValueChanged="@((string value) => OnComponentChanged("rl",value))">
                                                        <option value="">Select a location</option>
                                                        @foreach (var item in @servicesData.ResourceLocations!)
                                                        {
                                                            <option value="@item.ShortName">@item.Name (@item.ShortName)</option>
                                                        }
                                                    </InputSelect>
                                                </div>
                                            </div>
                                            break;
                                        case "ResourceOrg":
                                            <div class="modern-card mb-3">
                                                <div class="modern-card-header"><h5 class="modern-card-title mb-0">
                                                    @resourceComponent.DisplayName
                                                    @if (((selectedResourceTypeOptional.ToLower().Split(',').Contains("org")) && (multiselectedResourceTypes.Count == 0)))
                                                    {
                                                        @((MarkupString)optional)
                                                    }
                                                </h5></div><div class="modern-card-body">
                                                    @if (!String.IsNullOrEmpty(resourceComponent.Description))
                                                    {
                                                        <p>@resourceComponent.Description</p>
                                                    }
                                                    <InputSelect title="@resourceComponent.DisplayName" class="modern-form-input" ValueExpression="@(()=>selectedResourceOrg)"
                                                                 Value="@selectedResourceOrg"
                                                                 ValueChanged="@((string value) => OnComponentChanged("ro",value))">
                                                        <option value="">Select an org</option>
                                                        @foreach (var item in @servicesData.ResourceOrgs!)
                                                        {
                                                            <option value="@item.ShortName">@item.Name (@item.ShortName)</option>
                                                        }
                                                    </InputSelect>
                                                </div>
                                            </div>
                                            break;
                                        case "ResourceProjAppSvc":
                                            <div class="modern-card mb-3">
                                                <div class="modern-card-header"><h5 class="modern-card-title mb-0">
                                                    @resourceComponent.DisplayName
                                                    @if (((selectedResourceTypeOptional.ToLower().Split(',').Contains("projappsvc")) && (multiselectedResourceTypes.Count == 0)))
                                                    {
                                                        @((MarkupString)optional)
                                                    }
                                                </h5></div><div class="modern-card-body">
                                                    @if (!String.IsNullOrEmpty(resourceComponent.Description))
                                                    {
                                                        <p>@resourceComponent.Description</p>
                                                    }
                                                    <InputSelect title="@resourceComponent.DisplayName" class="modern-form-input" ValueExpression="@(()=>selectedResourceProjAppSvc)"
                                                                 Value="@selectedResourceProjAppSvc"
                                                                 ValueChanged="@((string value) => OnComponentChanged("rpas",value))">
                                                        <option value="">Select a project/app/service</option>
                                                        @foreach (var item in @servicesData.ResourceProjAppSvcs!)
                                                        {
                                                            <option value="@item.ShortName">@item.Name (@item.ShortName)</option>
                                                        }
                                                    </InputSelect>
                                                </div>
                                            </div>
                                            break;
                                        case "ResourceUnitDept":
                                            <div class="modern-card mb-3">
                                                <div class="modern-card-header"><h5 class="modern-card-title mb-0">
                                                    @resourceComponent.DisplayName
                                                    @if (((selectedResourceTypeOptional.ToLower().Split(',').Contains("unitdept")) && (multiselectedResourceTypes.Count == 0)))
                                                    {
                                                        @((MarkupString)optional)
                                                    }
                                                </h5></div><div class="modern-card-body">
                                                    @if (!String.IsNullOrEmpty(resourceComponent.Description))
                                                    {
                                                        <p>@resourceComponent.Description</p>
                                                    }
                                                    <InputSelect title="@resourceComponent.DisplayName" class="modern-form-input" ValueExpression="@(()=>selectedResourceUnitDept)"
                                                                 Value="@selectedResourceUnitDept"
                                                                 ValueChanged="@((string value) => OnComponentChanged("rud",value))">
                                                        <option value="">Select a unit/dept</option>
                                                        @foreach (var item in @servicesData.ResourceUnitDepts!)
                                                        {
                                                            <option value="@item.ShortName">@item.Name (@item.ShortName)</option>
                                                        }
                                                    </InputSelect>
                                                </div>
                                            </div>
                                            break;
                                        default:
                                            @if (resourceComponent.IsCustom)
                                            {
                                                @if (!resourceComponent.IsFreeText)
                                                {
                                                    @if (servicesData.CustomComponents!.Where(x => x.ParentComponent == GeneralHelper.NormalizeName(resourceComponent.Name, true)).Count() > 0)
                                                    {
                                                        <div class="modern-card mb-3">
                                                            <div class="modern-card-header"><h5 class="modern-card-title mb-0">
                                                                @resourceComponent.Name
                                                                @if (((selectedResourceTypeOptional.ToLower().Split(',').Contains(GeneralHelper.NormalizeName(resourceComponent.Name, true))) && (multiselectedResourceTypes.Count == 0)))
                                                                {
                                                                    @((MarkupString)optional)
                                                                }
                                                            </h5></div><div class="modern-card-body">
                                                                @if (!String.IsNullOrEmpty(resourceComponent.Description))
                                                                {
                                                                    <p>@resourceComponent.Description</p>
                                                                }
                                                                <select title="@resourceComponent.DisplayName" class="modern-form-input" value="@selectedCustomComponents[GeneralHelper.NormalizeName(resourceComponent.Name, true)]" @onchange='(e  => OnCustomComponentChanged(e, GeneralHelper.NormalizeName(resourceComponent.Name, true)))'>
                                                                    <option value="">Select a component</option>
                                                                    @foreach (var item in @servicesData.CustomComponents!.Where(x => x.ParentComponent == GeneralHelper.NormalizeName(resourceComponent.Name, true)))
                                                                    {
                                                                        <option value="@item.ShortName">@item.Name (@item.ShortName)</option>
                                                                    }
                                                                </select>
                                                            </div>
                                                        </div>
                                                    }
                                                }
                                                else
                                                {
                                                    <div class="modern-card mb-3">
                                                        <div class="modern-card-header"><h5 class="modern-card-title mb-0">
                                                            @resourceComponent.Name
                                                            @if (int.Parse(resourceComponent.MinLength) == int.Parse(resourceComponent.MaxLength))
                                                            {
                                                                <span> (@resourceComponent.MinLength characters) </span>
                                                            }
                                                            else
                                                            {
                                                                <span> (@resourceComponent.MinLength - @resourceComponent.MaxLength characters) </span>
                                                            }
                                                            @if (((selectedResourceTypeOptional.ToLower().Split(',').Contains(GeneralHelper.NormalizeName(resourceComponent.Name, true))) && (multiselectedResourceTypes.Count == 0)))
                                                            {
                                                                @((MarkupString)optional)
                                                            }
                                                            @if (resourceComponent.EnforceRandom)
                                                            {
                                                                <span class="fst-italic fw-normal"> - GENERATED</span>
                                                            }
                                                        </h5></div><div class="modern-card-body">
                                                            @if (!String.IsNullOrEmpty(resourceComponent.Description))
                                                            {
                                                                <p>@resourceComponent.Description</p>
                                                            }
                                                            <input title="@resourceComponent.DisplayName" readonly="@resourceComponent.EnforceRandom" class="modern-form-input" type="text" value="@selectedCustomComponents[GeneralHelper.NormalizeName(resourceComponent.Name, true)]" @onchange="@((ui) => { OnCustomComponentChanged(ui, GeneralHelper.NormalizeName(resourceComponent.Name, true));})" />
                                                        </div>
                                                    </div>
                                                }
                                            }
                                            break;
                                    }
                                }
                            }

                            @*<div class="card mb-3">
                    <h5 class="card-header bg-default text-dark">
                    Delimiter (Configured by site administrator)
                    </h5></div><div class="modern-card-body">
                    @resourceDelimiter.Name: @resourceDelimiter.Delimiter
                    </div>
                    </div>*@
                            @if (validationErrors.Count > 0)
                            {
                                <div class="alert alert-warning alert-dismissible fade show mb-3" role="alert">
                                    <h4>NOTE</h4>
                                    <ul>
                                        @foreach (string validationError in validationErrors)
                                        {
                                            <li>@validationError</li>
                                        }
                                    </ul>
                                </div>
                            }
                            <div class="mb-3">
                                <br />
                                <div class="d-flex align-items-center gap-3">
                                    <button class="modern-btn-success" type="submit" title="Generate" disabled=@boolFormDisabled>
                                        <span class="oi oi-loop-circular" aria-hidden="true"></span> Generate
                                    </button>
                                    @if (isGenerating)
                                    {
                                        <div class="d-flex align-items-center">
                                            <div class="spinner-border spinner-border-sm me-2" role="status" style="color: var(--color-success); border-width: 2px;">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <span class="fst-italic" style="color: var(--color-text-primary);">@generatingMessage</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                        
                        @if (@namerequested)
                        {
                            <div class="modern-card @resultClass mt-3">
                                <div class="modern-card-header">
                                    <h5 class="modern-card-title mb-0">@resultHeader</h5>
                                </div>
                                <div class="modern-card-body">
                                    @if (GeneralHelper.IsNotNull(@generatedName))
                                    {
                                        @if (!String.IsNullOrEmpty(@generatedName))
                                        {
                                            <div class="mb-3">
                                                <div class="mb-2"><strong>Generated Name(s):</strong></div>
                                                <div class="generated-names-output">
                                                    @((MarkupString)generatedName)
                                                </div>
                                            </div>
                                            <button class="modern-btn-primary" title="Export Generated Names" @onclick="@(e => OnExportGeneratedNames())">
                                                <span class="oi oi-data-transfer-download" aria-hidden="true"></span> Export Generated Names
                                            </button>
                                        }
                                    }
                                    @if (GeneralHelper.IsNotNull(@message))
                                    {
                                        @if (!String.IsNullOrEmpty(@message))
                                        {
                                            <div class="mt-3">
                                                <div class="mb-2"><strong>Message:</strong></div>

                                                @foreach (var sub in message.Split('\n'))
                                                {
                                                    <div>
                                                        @sub
                                                    </div>
                                                }
                                            </div>
                                        }
                                    }
                                </div>
                            </div>
                        }
                    }
                </div>
            </EditForm>
        }
    </div>
</div>
@code {
    [CascadingParameter]
    protected ThemeInfo theme { get; set; } = new();
    [CascadingParameter]
    public IModalService? Modal { get; set; }
    
    [Inject]
    public IResourceTypeService? ResourceTypeService { get; set; }
    
    [Inject]
    public IAdminLogService? AdminLogService { get; set; }
    
    [Inject]
    public IResourceNamingRequestService? ResourceNamingRequestService { get; set; }
    
    private SiteConfiguration config = ConfigurationHelper.GetConfigurationData();
    private ServicesData servicesData = new();
    private ResourceDelimiter resourceDelimiter = new();
    private string selectedResourceEnvironment = String.Empty;
    private string selectedResourceInstance = String.Empty;
    private string selectedResourceLocation = String.Empty;
    private string selectedResourceOrg = String.Empty;
    private string selectedResourceProjAppSvc = String.Empty;
    private String[] selectedResourceTypeFull = new String[3];
    private string selectedResourceTypeCategory = String.Empty;
    private string selectedResourceType = String.Empty;
    private string selectedResourceTypeProperty = String.Empty;
    private string selectedResourceTypeShortName = String.Empty;
    private string selectedResourceTypeDisplayName = String.Empty;
    private string selectedResourceTypeExclude = String.Empty;
    private string selectedResourceTypeOptional = String.Empty;
    private Dictionary<string, string> selectedCustomComponents = new();
    private List<string> categories = new();
    private string selectedResourceUnitDept = String.Empty;
    private string selectedResourceFunction = String.Empty;
    private bool boolFormDisabled = true;
    private string generatedName = String.Empty;
    private string message = String.Empty;
    private string resultClass = String.Empty;
    private string resultHeader = String.Empty;
    private bool isGenerating = false;
    private string generatingMessage = "Generating name...";
    private string componentsVisible = "collapse in";
    private string resourcetypeVisible = "";
    private string resourcetypesVisible = "collapse";
    private string optional = " <span class=\"fst-italic\">** OPTIONAL **</span>";
    private string[] filteredscopes = new string[] { "resource group", "resource group & region", "region", "global", "subscription", "tenant" };
    private ResourceNameRequest resourceNameRequest = new();
    private ResourceNameResponse resourceNameRequestResponse = new();
    private bool namerequested = false;
    private ResourceType? currentResourceType = null;
    private List<string> multiselectedResourceTypes = new();
    private string currentuser = String.Empty;
    private List<string> validationErrors = new();

    protected override async Task OnInitializedAsync()
    {
        await SetServicesData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (resourceDelimiter == null)
        {
            await SetServicesData();
        }

        var currentuservalue = await session.GetAsync<string>("currentuser");
        currentuser = (string)currentuservalue.Value!;

        // TO DO: Implement retention of the selected values
        // Need to determine how to properly load selected values from session.
        // This is a work in progress.
        // await GetRetainedSelections();s
    }

    private async Task SetServicesData()
    {
        try
        {
            servicesData = await ServicesHelper.LoadServicesData(servicesData, false);
            List<ResourceType> filteredtypes = new List<ResourceType>();
            // Filter out the types w/o the scope
            foreach (ResourceType type in servicesData.ResourceTypes!)
            {
                filteredtypes.Add(type);
            }
            servicesData.ResourceTypes = filteredtypes;

            // Get the list of categories
            categories = ResourceTypeService.GetTypeCategories(servicesData.ResourceTypes);
            resourceDelimiter = (ResourceDelimiter)servicesData.ResourceDelimiters![0];
            componentsVisible = "collapse show";
        }
        catch (Exception ex)
        {
            await AdminLogService.PostItemAsync(new AdminLogMessage() { Title = "ERROR", Message = ex.Message });
            toastService.ShowError("There was a problem loading the page. Please try again.");
        }
    }

    private async Task HandleValidSubmit()
    {
        // Queue the work asynchronously to prevent UI blocking on first render
        await InvokeAsync(async () =>
        {
            namerequested = false;
            isGenerating = true;
            
            // Check if Azure validation is enabled to show appropriate message
            var siteConfig = ConfigurationHelper.GetConfigurationData();
            var azureValidationEnabled = siteConfig?.AzureTenantNameValidationEnabled?.Equals("True", StringComparison.OrdinalIgnoreCase) == true;
            generatingMessage = azureValidationEnabled 
                ? "Generating name and validating against Azure..." 
                : "Generating name...";
            
            boolFormDisabled = true;
            StateHasChanged();
            
            // Longer delay to ensure circuit is fully established
            await Task.Delay(100);
            
            try
            {
                if (!GeneralHelper.IsNotNull(servicesData))
                {
                    await SetServicesData();
                }
                StringBuilder sbNames = new();
                StringBuilder sbMessage = new();
                generatedName = "";
                message = "";

                ResourceType resourceType = new();
                // Create the name request
                resourceNameRequest.ResourceEnvironment = selectedResourceEnvironment;
                resourceNameRequest.ResourceFunction = selectedResourceFunction;
                resourceNameRequest.ResourceInstance = selectedResourceInstance;
                resourceNameRequest.ResourceLocation = selectedResourceLocation;
                resourceNameRequest.ResourceOrg = selectedResourceOrg;
                resourceNameRequest.ResourceProjAppSvc = selectedResourceProjAppSvc;
                resourceNameRequest.ResourceUnitDept = selectedResourceUnitDept;
                resourceNameRequest.CustomComponents = selectedCustomComponents;
                string currentuser = await IdentityHelper.GetCurrentUser(session);
                resourceNameRequest.CreatedBy = currentuser;

                sbNames.Append("<table class=\"table text-light generatednames\">");
                sbNames.Append("<thead>");
                sbNames.Append("<tr>");
                sbNames.Append("<th class\"w20\">Resource Type</th>");
                sbNames.Append("<th class\"w20\">Generated Name</th>");
                sbNames.Append("<th class\"w40\">Notes</th>");
                sbNames.Append("<th class\"w20\">Azure Validation</th>");
                sbNames.Append("</tr>");
                sbNames.Append("</thead>");
                sbNames.Append("<tbody>");

                // Check the genrate mode
                if (multiselectedResourceTypes.Count == 0)
                {
                    // Single type generation
                    StringBuilder sbName = new();
                    selectedResourceTypeFull = GeneralHelper.FormatResourceType(selectedResourceTypeDisplayName);
                    if (GeneralHelper.IsNotNull(selectedResourceTypeFull[1]))
                    {
                        selectedResourceType = selectedResourceTypeFull[1];
                    }
                    else
                    {
                        selectedResourceType = selectedResourceTypeFull[0];
                    }
                    // Deternine if a property was returned
                    if (GeneralHelper.IsNotNull(selectedResourceTypeFull[3]))
                    {
                        selectedResourceTypeProperty = selectedResourceTypeFull[3];
                    }
                    selectedResourceTypeShortName = selectedResourceTypeFull[2];
                    if (GeneralHelper.IsNotNull(selectedResourceTypeShortName))
                    {
                        if (!String.IsNullOrEmpty(selectedResourceTypeProperty))
                        {
                            resourceType = servicesData.ResourceTypes!.Find(x => x.Resource == selectedResourceType && x.ShortName == selectedResourceTypeShortName && x.Property == selectedResourceTypeProperty)!;
                        }
                        else
                        {
                            resourceType = servicesData.ResourceTypes!.Find(x => x.Resource == selectedResourceType && x.ShortName == selectedResourceTypeShortName)!;
                        }
                    }
                    else
                    {
                        if (!String.IsNullOrEmpty(selectedResourceTypeProperty))
                        {
                            resourceType = servicesData.ResourceTypes!.Find(x => x.Resource == selectedResourceType && x.Property == selectedResourceTypeProperty)!;
                        }
                        else
                        {
                            resourceType = servicesData.ResourceTypes!.Find(x => x.Resource == selectedResourceType)!;
                        }
                    }
                    if (GeneralHelper.IsNotNull(resourceType))
                    {
                        resourceNameRequest.ResourceType = resourceType.ShortName;
                        resourceNameRequest.ResourceId = resourceType.Id;
                        resourceNameRequestResponse = await ResourceNamingRequestService!.RequestNameAsync(resourceNameRequest);
                        namerequested = true;

                        // Prepare the response
                        sbNames.Append("<tr>");
                        if (!String.IsNullOrEmpty(resourceType.Property))
                        {
                            sbNames.Append("<td class=\"col-3\">" + @resourceType.Resource + " - " + @resourceType.Property + "</td>");
                        }
                        else
                        {
                            sbNames.Append("<td class=\"col-3\">" + @resourceType.Resource + "</td>");
                        }
                        sbNames.Append("<td class=\"col-3\">" + resourceNameRequestResponse.ResourceName + "</td>");
                        sbNames.Append("<td class=\"col-3\">");
                        if (!String.IsNullOrEmpty(resourceNameRequestResponse.Message))
                        {
                            sbNames.Append(resourceNameRequestResponse.Message);
                        }
                        sbNames.Append("</td>");
                        sbNames.Append("<td class=\"col-3\">");
                        // Add Azure validation status
                        if (resourceNameRequestResponse.ValidationMetadata != null)
                        {
                            var vm = resourceNameRequestResponse.ValidationMetadata;
                            if (vm.ValidationPerformed)
                            {
                                if (vm.ExistsInAzure)
                                {
                                    sbNames.Append("<span class=\"badge bg-warning text-dark\">Existed in Azure</span><br/>");
                                    if (!String.IsNullOrEmpty(vm.OriginalName))
                                    {
                                        sbNames.Append($"<small>Original: {vm.OriginalName}</small><br/>");
                                        sbNames.Append($"<small>Resolved: {resourceNameRequestResponse.ResourceName}</small><br/>");
                                        if (vm.IncrementAttempts.HasValue)
                                        {
                                            sbNames.Append($"<small>({vm.IncrementAttempts.Value} attempts)</small><br/>");
                                        }
                                    }
                                }
                                else
                                {
                                    sbNames.Append("<span class=\"badge bg-success\"> Available</span><br/>");
                                }
                                
                                if (!String.IsNullOrEmpty(vm.ValidationWarning))
                                {
                                    sbNames.Append($"<small class=\"text-warning\"> {vm.ValidationWarning}</small>");
                                }
                            }
                            else
                            {
                                sbNames.Append("<span class=\"badge bg-secondary\">Not Validated</span>");
                            }
                        }
                        else
                        {
                            sbNames.Append("<span class=\"badge bg-secondary\">Disabled</span>");
                        }
                        sbNames.Append("</td>");
                        sbNames.Append("</tr>");

                        // Set the result container
                        if (resourceNameRequestResponse.Success)
                        {
                            resultClass = "bg-success";
                            resultHeader = "SUCCESS";
                            componentsVisible = "collapse";
                        }
                        else
                        {
                            resultClass = "bg-danger";
                            resultHeader = "FAILURE";
                            componentsVisible = "collapse show";
                        }
                    }
                }
                else
                {
                    // Attempt to genrate name for each seelct types
                    resultClass = "bg-success";
                    foreach (string id in multiselectedResourceTypes)
                    {
                        resourceType = servicesData.ResourceTypes!.Find(x => x.Id == Convert.ToInt32(id))!;
                        if (GeneralHelper.IsNotNull(resourceType))
                        {
                            resourceNameRequest.ResourceType = resourceType.ShortName;
                            resourceNameRequest.ResourceId = resourceType.Id;
                            resourceNameRequestResponse = await ResourceNamingRequestService!.RequestNameAsync(resourceNameRequest);

                            sbNames.Append("<tr>");
                            if (!String.IsNullOrEmpty(resourceType.Property))
                            {
                                sbNames.Append("<td class=\"col-3\">" + @resourceType.Resource + " - " + @resourceType.Property + "</td>");
                            }
                            else
                            {
                                sbNames.Append("<td class=\"col-3\">" + @resourceType.Resource + "</td>");
                            }
                            sbNames.Append("<td class=\"col-3\">" + resourceNameRequestResponse.ResourceName + "</td>");
                            sbNames.Append("<td class=\"col-3\">");
                            if (!String.IsNullOrEmpty(resourceNameRequestResponse.Message))
                            {
                                sbNames.Append(resourceNameRequestResponse.Message);
                            }
                            sbNames.Append("</td>");
                            sbNames.Append("<td class=\"col-3\">");
                            // Add Azure validation status
                            if (resourceNameRequestResponse.ValidationMetadata != null)
                            {
                                var vm = resourceNameRequestResponse.ValidationMetadata;
                                if (vm.ValidationPerformed)
                                {
                                    if (vm.ExistsInAzure)
                                    {
                                        sbNames.Append("<span class=\"badge bg-warning text-dark\">Existed in Azure</span><br/>");
                                        if (!String.IsNullOrEmpty(vm.OriginalName))
                                        {
                                            sbNames.Append($"<small>Original: {vm.OriginalName}</small><br/>");
                                            sbNames.Append($"<small>Resolved: {resourceNameRequestResponse.ResourceName}</small><br/>");
                                            if (vm.IncrementAttempts.HasValue)
                                            {
                                                sbNames.Append($"<small>({vm.IncrementAttempts.Value} attempts)</small><br/>");
                                            }
                                        }
                                    }
                                    else
                                    {
                                        sbNames.Append("<span class=\"badge bg-success\"> Available</span><br/>");
                                    }
                                    
                                    if (!String.IsNullOrEmpty(vm.ValidationWarning))
                                    {
                                        sbNames.Append($"<small class=\"text-warning\"> {vm.ValidationWarning}</small>");
                                    }
                                }
                                else
                                {
                                    sbNames.Append("<span class=\"badge bg-secondary\">Not Validated</span>");
                                }
                            }
                            else
                            {
                                sbNames.Append("<span class=\"badge bg-secondary\">Disabled</span>");
                            }
                            sbNames.Append("</td>");
                            sbNames.Append("</tr>");

                            // Set the  result container
                            if (!resourceNameRequestResponse.Success)
                            {
                                resultClass = "bg-danger";
                                resultHeader = "FAILURE";
                            }
                        }
                    }

                }

                sbNames.Append("</tbody>");
                sbNames.Append("</table>");

                // Always show the response
                generatedName = sbNames.ToString();
                namerequested = true;
                StateHasChanged();

                // TO DO: Implement retention of the selected values
                //await SetRetainedSelections();
            }
            catch (Exception ex)
            {
                await AdminLogService.PostItemAsync(new AdminLogMessage() { Title = "ERROR", Message = ex.Message });
                toastService.ShowError("There was a problem generting the name(s). Please try again");
            }
            finally
            {
                isGenerating = false;
                StateHasChanged();
            }
        });
    }

    private async Task OnGenerateModeChange(string mode)
    {
        try
        {
            Logger.LogInformation($"OnGenerateModeChange called with mode: {mode}");
            
            if (mode == "multi")
            {
                resourcetypeVisible = "collapse";
                resourcetypesVisible = "";
                toastService.ShowInfo("This option will require all current components to be selected.");
                // Show the multi select modal
                StateHasChanged();
                await Task.Delay(100); // Give UI time to update
                await OpenMultiSelectModal(true);
            }
            else
            {
                // Show the single type selection
                resourcetypeVisible = "";
                resourcetypesVisible = "collapse";
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error in OnGenerateModeChange");
            toastService.ShowError($"Error changing mode: {ex.Message}");
        }
    }

    private async Task OpenMultiSelectModal(bool clearselection)
    {
        try
        {
            Logger.LogInformation("OpenMultiSelectModal called");
            ResetForm(false);

            if (!GeneralHelper.IsNotNull(servicesData))
            {
                await SetServicesData();
            }
            
            Logger.LogInformation($"Modal service is null: {Modal == null}");
            
            var parameters = new ModalParameters();
            parameters.Add("theme", theme);
            parameters.Add("multiselectedResourceTypes", multiselectedResourceTypes);
            var options = new ModalOptions()
                {
                    HideCloseButton = false,
                    UseCustomLayout = true,
                };
            if (GeneralHelper.IsNotNull(Modal))
            {
                Logger.LogInformation("Showing modal");
                var modal = Modal.Show<MultiTypeSelectModal>("Select Resource Types", parameters, options);
                Logger.LogInformation("Waiting for modal result");
                var result = await modal.Result;
                Logger.LogInformation("Got modal result");
                if (GeneralHelper.IsNotNull(result))
                {
                    if (result.Confirmed)
                    {
                        if (GeneralHelper.IsNotNull(result.Data))
                        {
                            multiselectedResourceTypes = (List<string>)result.Data;
                            if (GeneralHelper.IsNotNull(multiselectedResourceTypes))
                            {
                                if (multiselectedResourceTypes.Count > 0)
                                {
                                    ResourceType currentmultiresourcertype = servicesData.ResourceTypes!.Find((t) => t.Id == Convert.ToInt32(multiselectedResourceTypes![0].ToString()))!;
                                    if (GeneralHelper.IsNotNull(currentmultiresourcertype))
                                    {
                                        await OnTypeChanged(currentmultiresourcertype.Resource);
                                    }
                                    componentsVisible = "";
                                    optional = String.Empty;
                                }
                                else
                                {
                                    componentsVisible = "collapse";
                                }
                            }
                        }
                    }
                }
            }
            else
            {
                Logger.LogWarning("Modal service is null!");
                toastService.ShowError("Modal service is not available");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error in OpenMultiSelectModal");
            toastService.ShowError($"Error opening modal: {ex.Message}");
        }
    }

    private async Task OnSelectResourceTypesClick()
    {
        try
        {
            Logger.LogInformation("OnSelectResourceTypesClick called");
            Logger.LogInformation($"Modal is null: {Modal == null}");
            await OpenMultiSelectModal(false);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error in OnSelectResourceTypesClick");
            toastService.ShowError($"Error opening modal: {ex.Message}");
        }
    }

    private void OnClearClick()
    {
        ResetForm(true);
    }

    private void OnCategoryChanged(string value)
    {
        selectedResourceTypeCategory = value;
        selectedResourceType = String.Empty;
        selectedResourceTypeDisplayName = String.Empty;
        componentsVisible = "collapse show";
    }

    private async Task OnTypeChanged(string value)
    {
        try
        {
            if (!GeneralHelper.IsNotNull(servicesData))
            {
                await SetServicesData();
            }
            resourceNameRequestResponse = new();
            // Assign the selected value to the Model
            selectedResourceTypeDisplayName = value;

            if (!String.IsNullOrEmpty(selectedResourceTypeDisplayName))
            {
                selectedResourceTypeFull = GeneralHelper.FormatResourceType(selectedResourceTypeDisplayName);
                if (GeneralHelper.IsNotNull(selectedResourceTypeFull[1]))
                {
                    selectedResourceType = selectedResourceTypeFull[1];
                }
                else
                {
                    selectedResourceType = selectedResourceTypeFull[0];
                }
                if (GeneralHelper.IsNotNull(selectedResourceTypeFull[3]))
                {
                    selectedResourceTypeProperty = selectedResourceTypeFull[3];
                }
                selectedResourceTypeShortName = selectedResourceTypeFull[2];
                if (GeneralHelper.IsNotNull(selectedResourceTypeShortName))
                {
                    if (!String.IsNullOrEmpty(selectedResourceTypeProperty))
                    {
                        currentResourceType = servicesData.ResourceTypes!.Find(x => x.Resource == selectedResourceType && x.ShortName == selectedResourceTypeShortName && x.Property == selectedResourceTypeProperty)!;
                    }
                    else
                    {
                        currentResourceType = servicesData.ResourceTypes!.Find(x => x.Resource == selectedResourceType && x.ShortName == selectedResourceTypeShortName)!;
                    }
                }
                else
                {
                    if (!String.IsNullOrEmpty(selectedResourceTypeProperty))
                    {
                        currentResourceType = servicesData.ResourceTypes!.Find(x => x.Resource == selectedResourceType && x.Property == selectedResourceTypeProperty)!;
                    }
                    else
                    {
                        currentResourceType = servicesData.ResourceTypes!.Find(x => x.Resource == selectedResourceType)!;
                    }
                }

                if (GeneralHelper.IsNotNull(currentResourceType))
                {
                    // Set the optional components
                    selectedResourceTypeOptional = currentResourceType.Optional;

                    // Set the excluded components
                    selectedResourceTypeExclude = currentResourceType.Exclude;

                    // Reset the selected items
                    selectedResourceEnvironment = String.Empty;
                    selectedResourceInstance = String.Empty;
                    selectedResourceLocation = String.Empty;
                    selectedResourceOrg = String.Empty;
                    selectedResourceProjAppSvc = String.Empty;
                    selectedResourceUnitDept = String.Empty;
                    selectedResourceFunction = String.Empty;

                    componentsVisible = "collapse show";

                    // Check if all the components are optional for the resource type
                    selectedCustomComponents.Clear();
                    foreach (var component in servicesData.ResourceComponents!)
                    {
                        if (component.IsCustom)
                        {
                            if (component.EnforceRandom)
                            {
                                GenerateRandomValue(GeneralHelper.NormalizeName(component.Name, true), component.MaxLength, component.Alphanumeric);
                            }
                            else
                            {
                                selectedCustomComponents.Add(GeneralHelper.NormalizeName(component.Name, true), String.Empty);
                            }
                        }
                    }

                    ValidateForm();
                }
            }
            else
            {
                currentResourceType = null;
            }
        }
        catch (Exception ex)
        {
            toastService.ShowError("There was an error setting the resource type! Please try again.");
            await AdminLogService.PostItemAsync(new AdminLogMessage() { Title = "ERROR", Message = ex.Message });
        }

        //return Task.CompletedTask;
    }

    private Task OnComponentChanged(string sender, string value, string key = "")
    {
        switch (sender)
        {
            case "re":
                selectedResourceEnvironment = value;
                break;
            case "ri":
                selectedResourceInstance = value;
                break;
            case "rl":
                selectedResourceLocation = value;
                break;
            case "ro":
                selectedResourceOrg = value;
                break;
            case "rpas":
                selectedResourceProjAppSvc = value;
                break;
            case "rud":
                selectedResourceUnitDept = value;
                break;
            case "rf":
                selectedResourceFunction = value;
                break;
            case "cc":
                // Determine if the custom component aleady exists in the current collection
                if (selectedCustomComponents.ContainsKey(key))
                {
                    selectedCustomComponents[key] = value;
                }
                else
                {
                    // Add the selection
                    selectedCustomComponents.Add(key, value);
                }
                break;
        }

        ValidateForm();
        return Task.CompletedTask;
    }

    private void OnCustomComponentChanged(ChangeEventArgs e, string parentcomponent)
    {
        if (GeneralHelper.IsNotNull(e.Value))
        {
            if (!String.IsNullOrEmpty(e.Value.ToString()))
            {
                OnComponentChanged("cc", e.Value.ToString()!, parentcomponent);
            }
            else
            {
                if (selectedCustomComponents.ContainsKey(parentcomponent))
                {
                    selectedCustomComponents[parentcomponent] = String.Empty;
                }
                ValidateForm();
            }
        }
    }

    private async void ValidateForm()
    {
        validationErrors.Clear();
        if (!GeneralHelper.IsNotNull(servicesData))
        {
            await SetServicesData();
        }
        if ((GeneralHelper.IsNotNull(selectedResourceType)) || (multiselectedResourceTypes.Count > 0))
        {
            boolFormDisabled = false;
            string nomalizedcomponentname;
            @foreach (ResourceComponent resourceComponent in servicesData.ResourceComponents!)
            {
                nomalizedcomponentname = GeneralHelper.NormalizeName(resourceComponent.Name, true);
                // Check if the user is generating names for a single type or multiple types
                if (multiselectedResourceTypes.Count == 0)
                {
                    // Check if the component is excluded for the resource type
                    if (!selectedResourceTypeExclude.ToLower().Split(',').Contains(nomalizedcomponentname))
                    {
                        // Check if the component is optional for the resource type
                        if ((!selectedResourceTypeOptional.ToLower().Split(',').Contains(nomalizedcomponentname)))
                        {
                            switch (resourceComponent.Name)
                            {
                                case "ResourceEnvironment":
                                    if (String.IsNullOrEmpty(selectedResourceEnvironment))
                                    {
                                        validationErrors.Add("Environment component is required.");
                                        boolFormDisabled = true;
                                    }
                                    else
                                    {
                                        // Check of the component value length is valid
                                        if (!ValidationHelper.CheckComponentLength(resourceComponent, selectedResourceEnvironment))
                                        {
                                            validationErrors.Add("Environment component length is not valid.");
                                            boolFormDisabled = true;
                                        }
                                    }
                                    break;

                                case "ResourceInstance":
                                    if (String.IsNullOrEmpty(selectedResourceInstance))
                                    {
                                        validationErrors.Add("Instance component is required.");
                                        boolFormDisabled = true;
                                    }
                                    else
                                    {
                                        // Check of the component value length is valid
                                        if (!ValidationHelper.CheckComponentLength(resourceComponent, selectedResourceInstance))
                                        {
                                            validationErrors.Add("Instance component length is not valid.");
                                            boolFormDisabled = true;
                                        }
                                    }
                                    break;
                                case "ResourceLocation":
                                    if (String.IsNullOrEmpty(selectedResourceLocation))
                                    {
                                        validationErrors.Add("Location component is required.");
                                        boolFormDisabled = true;
                                    }
                                    else
                                    {
                                        // Check of the component value length is valid
                                        if (!ValidationHelper.CheckComponentLength(resourceComponent, selectedResourceLocation))
                                        {
                                            validationErrors.Add("Location component length is not valid.");
                                            boolFormDisabled = true;
                                        }
                                    }
                                    break;
                                case "ResourceOrg":
                                    if (String.IsNullOrEmpty(selectedResourceOrg))
                                    {
                                        validationErrors.Add("Org component is required.");
                                        boolFormDisabled = true;
                                    }
                                    else
                                    {
                                        // Check of the component value length is valid
                                        if (!ValidationHelper.CheckComponentLength(resourceComponent, selectedResourceOrg))
                                        {
                                            validationErrors.Add("Org component length is not valid.");
                                            boolFormDisabled = true;
                                        }
                                    }
                                    break;
                                case "ResourceProjAppSvc":
                                    if (String.IsNullOrEmpty(selectedResourceProjAppSvc))
                                    {
                                        validationErrors.Add("Project/App/Service component is required.");
                                        boolFormDisabled = true;
                                    }
                                    else
                                    {
                                        // Check of the component value length is valid
                                        if (!ValidationHelper.CheckComponentLength(resourceComponent, selectedResourceProjAppSvc))
                                        {
                                            validationErrors.Add("Project/App/Service component length is not valid.");
                                            boolFormDisabled = true;
                                        }
                                    }
                                    break;
                                case "ResourceUnitDept":
                                    if (String.IsNullOrEmpty(selectedResourceUnitDept))
                                    {
                                        validationErrors.Add("Unit/Dept component is required.");
                                        boolFormDisabled = true;
                                    }
                                    else
                                    {
                                        // Check of the component value length is valid
                                        if (!ValidationHelper.CheckComponentLength(resourceComponent, selectedResourceUnitDept))
                                        {
                                            validationErrors.Add("Unit/Dept component length is not valid.");
                                            boolFormDisabled = true;
                                        }
                                    }
                                    break;
                                case "ResourceFunction":
                                    if (String.IsNullOrEmpty(selectedResourceFunction))
                                    {
                                        validationErrors.Add("Function component is required.");
                                        boolFormDisabled = true;
                                    }
                                    else
                                    {
                                        // Check of the component value length is valid
                                        if (!ValidationHelper.CheckComponentLength(resourceComponent, selectedResourceFunction))
                                        {
                                            validationErrors.Add("Function component length is not valid.");
                                            boolFormDisabled = true;
                                        }
                                    }
                                    break;
                                default:
                                    if (resourceComponent.IsCustom)
                                    {
                                        if (!resourceComponent.IsFreeText)
                                        {
                                            if (servicesData.CustomComponents!.Where(x => x.ParentComponent.ToLower() == nomalizedcomponentname).Count() > 0)
                                            {
                                                // Make sure each component has a value
                                                if (String.IsNullOrEmpty(selectedCustomComponents[nomalizedcomponentname]))
                                                {
                                                    validationErrors.Add(resourceComponent.Name + " component is required.");
                                                    boolFormDisabled = true;
                                                }
                                                else
                                                {
                                                    // Check of the component value length is valid
                                                    if (!ValidationHelper.CheckComponentLength(resourceComponent, selectedCustomComponents[nomalizedcomponentname]))
                                                    {
                                                        validationErrors.Add(resourceComponent.Name + " component length is not valid.");
                                                        boolFormDisabled = true;
                                                    }
                                                }
                                            }
                                        }
                                        else
                                        {
                                            // Make sure each component has a value
                                            if (String.IsNullOrEmpty(selectedCustomComponents[nomalizedcomponentname]))
                                            {
                                                validationErrors.Add(resourceComponent.Name + " component is required.");
                                                boolFormDisabled = true;
                                            }
                                            else
                                            {
                                                // Check of the component value length is valid
                                                if (!ValidationHelper.CheckComponentLength(resourceComponent, selectedCustomComponents[nomalizedcomponentname]))
                                                {
                                                    validationErrors.Add(resourceComponent.Name + " component length is not valid.");
                                                    boolFormDisabled = true;
                                                }
                                            }
                                        }
                                    }
                                    break;
                            }
                        }
                        else
                        {
                            switch (resourceComponent.Name)
                            {
                                case "ResourceEnvironment":
                                    if (!String.IsNullOrEmpty(selectedResourceEnvironment))
                                    {
                                        // Check of the component value length is valid
                                        if (!ValidationHelper.CheckComponentLength(resourceComponent, selectedResourceEnvironment))
                                        {
                                            validationErrors.Add("Environment component length is not valid.");
                                            boolFormDisabled = true;
                                        }
                                    }
                                    break;

                                case "ResourceInstance":
                                    if (!String.IsNullOrEmpty(selectedResourceInstance))
                                    {
                                        // Check of the component value length is valid
                                        if (!ValidationHelper.CheckComponentLength(resourceComponent, selectedResourceInstance))
                                        {
                                            validationErrors.Add("Instance component length is not valid.");
                                            boolFormDisabled = true;
                                        }
                                    }
                                    break;
                                case "ResourceLocation":
                                    if (!String.IsNullOrEmpty(selectedResourceLocation))
                                    {
                                        // Check of the component value length is valid
                                        if (!ValidationHelper.CheckComponentLength(resourceComponent, selectedResourceLocation))
                                        {
                                            validationErrors.Add("Location component length is not valid.");
                                            boolFormDisabled = true;
                                        }
                                    }
                                    break;
                                case "ResourceOrg":
                                    if (!String.IsNullOrEmpty(selectedResourceOrg))
                                    {
                                        // Check of the component value length is valid
                                        if (!ValidationHelper.CheckComponentLength(resourceComponent, selectedResourceOrg))
                                        {
                                            validationErrors.Add("Org component length is not valid.");
                                            boolFormDisabled = true;
                                        }
                                    }
                                    break;
                                case "ResourceProjAppSvc":
                                    if (!String.IsNullOrEmpty(selectedResourceProjAppSvc))
                                    {
                                        // Check of the component value length is valid
                                        if (!ValidationHelper.CheckComponentLength(resourceComponent, selectedResourceProjAppSvc))
                                        {
                                            validationErrors.Add("Project/App/Service component length is not valid.");
                                            boolFormDisabled = true;
                                        }
                                    }
                                    break;
                                case "ResourceUnitDept":
                                    if (!String.IsNullOrEmpty(selectedResourceUnitDept))
                                    {
                                        // Check of the component value length is valid
                                        if (!ValidationHelper.CheckComponentLength(resourceComponent, selectedResourceUnitDept))
                                        {
                                            validationErrors.Add("Unit/Dept component length is not valid.");
                                            boolFormDisabled = true;
                                        }
                                    }
                                    break;
                                case "ResourceFunction":
                                    if (!String.IsNullOrEmpty(selectedResourceFunction))
                                    {
                                        // Check of the component value length is valid
                                        if (!ValidationHelper.CheckComponentLength(resourceComponent, selectedResourceFunction))
                                        {
                                            validationErrors.Add("Function component length is not valid.");
                                            boolFormDisabled = true;
                                        }
                                    }
                                    break;
                                default:
                                    if (resourceComponent.IsCustom)
                                    {
                                        if (!resourceComponent.IsFreeText)
                                        {
                                            if (servicesData.CustomComponents!.Where(x => x.ParentComponent == nomalizedcomponentname).Count() > 0)
                                            {
                                                // Make sure each component has a value
                                                if (!String.IsNullOrEmpty(selectedCustomComponents[nomalizedcomponentname]))
                                                {
                                                    // Check of the component value length is valid
                                                    if (!ValidationHelper.CheckComponentLength(resourceComponent, selectedCustomComponents[nomalizedcomponentname]))
                                                    {
                                                        validationErrors.Add(resourceComponent.Name + " component length is not valid.");
                                                        boolFormDisabled = true;
                                                    }
                                                }
                                            }
                                        }
                                        else
                                        {
                                            // Make sure each component has a value
                                            if (!String.IsNullOrEmpty(selectedCustomComponents[nomalizedcomponentname]))
                                            {
                                                // Check of the component value length is valid
                                                if (!ValidationHelper.CheckComponentLength(resourceComponent, selectedCustomComponents[nomalizedcomponentname]))
                                                {
                                                    validationErrors.Add(resourceComponent.Name + " component length is not valid.");
                                                    boolFormDisabled = true;
                                                }
                                            }
                                        }
                                    }
                                    break;
                            }
                        }
                    }
                }
                else
                {
                    // Ensure every component has a value
                    switch (resourceComponent.Name)
                    {
                        case "ResourceEnvironment":
                            if (String.IsNullOrEmpty(selectedResourceEnvironment))
                            {
                                validationErrors.Add("Environment component is required.");
                                boolFormDisabled = true;
                            }
                            else
                            {
                                // Check of the component value length is valid
                                if (!ValidationHelper.CheckComponentLength(resourceComponent, selectedResourceEnvironment))
                                {
                                    validationErrors.Add("Environment component length is not valid.");
                                    boolFormDisabled = true;
                                }
                            }
                            break;

                        case "ResourceInstance":
                            if (String.IsNullOrEmpty(selectedResourceInstance))
                            {
                                validationErrors.Add("Instance component is required.");
                                boolFormDisabled = true;
                            }
                            else
                            {
                                // Check of the component value length is valid
                                if (!ValidationHelper.CheckComponentLength(resourceComponent, selectedResourceInstance))
                                {
                                    validationErrors.Add("Instance component length is not valid.");
                                    boolFormDisabled = true;
                                }
                            }
                            break;
                        case "ResourceLocation":
                            if (String.IsNullOrEmpty(selectedResourceLocation))
                            {
                                validationErrors.Add("Location component is required.");
                                boolFormDisabled = true;
                            }
                            else
                            {
                                // Check of the component value length is valid
                                if (!ValidationHelper.CheckComponentLength(resourceComponent, selectedResourceLocation))
                                {
                                    validationErrors.Add("Location component length is not valid.");
                                    boolFormDisabled = true;
                                }
                            }
                            break;
                        case "ResourceOrg":
                            if (String.IsNullOrEmpty(selectedResourceOrg))
                            {
                                validationErrors.Add("Org component is required.");
                                boolFormDisabled = true;
                            }
                            else
                            {
                                // Check of the component value length is valid
                                if (!ValidationHelper.CheckComponentLength(resourceComponent, selectedResourceOrg))
                                {
                                    validationErrors.Add("Org component length is not valid.");
                                    boolFormDisabled = true;
                                }
                            }
                            break;
                        case "ResourceProjAppSvc":
                            if (String.IsNullOrEmpty(selectedResourceProjAppSvc))
                            {
                                validationErrors.Add("Project/App/Service component is required.");
                                boolFormDisabled = true;
                            }
                            else
                            {
                                // Check of the component value length is valid
                                if (!ValidationHelper.CheckComponentLength(resourceComponent, selectedResourceProjAppSvc))
                                {
                                    validationErrors.Add("Project/App/Service component length is not valid.");
                                    boolFormDisabled = true;
                                }
                            }
                            break;
                        case "ResourceUnitDept":
                            if (String.IsNullOrEmpty(selectedResourceUnitDept))
                            {
                                validationErrors.Add("Unit/Dept component is required.");
                                boolFormDisabled = true;
                            }
                            else
                            {
                                // Check of the component value length is valid
                                if (!ValidationHelper.CheckComponentLength(resourceComponent, selectedResourceUnitDept))
                                {
                                    validationErrors.Add("Unit/Dept component length is not valid.");
                                    boolFormDisabled = true;
                                }
                            }
                            break;
                        case "ResourceFunction":
                            if (String.IsNullOrEmpty(selectedResourceFunction))
                            {
                                validationErrors.Add("Function component is required.");
                                boolFormDisabled = true;
                            }
                            else
                            {
                                // Check of the component value length is valid
                                if (!ValidationHelper.CheckComponentLength(resourceComponent, selectedResourceFunction))
                                {
                                    validationErrors.Add("Function component length is not valid.");
                                    boolFormDisabled = true;
                                }
                            }
                            break;
                        default:
                            if (resourceComponent.IsCustom)
                            {
                                if (!resourceComponent.IsFreeText)
                                {
                                    if (GeneralHelper.IsNotNull(servicesData.CustomComponents))
                                    {
                                        if (servicesData.CustomComponents.Where(x => x.ParentComponent == nomalizedcomponentname).Count() > 0)
                                        {
                                            // Make sure each component has a value
                                            if (String.IsNullOrEmpty(selectedCustomComponents[nomalizedcomponentname]))
                                            {
                                                validationErrors.Add(resourceComponent.Name + " component is required.");
                                                boolFormDisabled = true;
                                            }
                                            else
                                            {
                                                // Check of the component value length is valid
                                                if (!ValidationHelper.CheckComponentLength(resourceComponent, selectedCustomComponents[nomalizedcomponentname]))
                                                {
                                                    validationErrors.Add(resourceComponent.Name + " component length is not valid.");
                                                    boolFormDisabled = true;
                                                }
                                            }
                                        }
                                    }
                                }
                                else
                                {
                                    // Make sure each component has a value
                                    if (String.IsNullOrEmpty(selectedCustomComponents[nomalizedcomponentname]))
                                    {
                                        validationErrors.Add(resourceComponent.Name + " component is required.");
                                        boolFormDisabled = true;
                                    }
                                    else
                                    {
                                        // Check of the component value length is valid
                                        if (!ValidationHelper.CheckComponentLength(resourceComponent, selectedCustomComponents[nomalizedcomponentname]))
                                        {
                                            validationErrors.Add(resourceComponent.Name + " component length is not valid.");
                                            boolFormDisabled = true;
                                        }
                                    }
                                }
                            }
                            break;
                    }
                }
            }
        }

        // TO DO: Implement retention of the selected values
        //await SetRetainedSelections();
    }

    private string GetControlStyle()
    {
        return "form-control " + theme.ThemeStyle;
    }

    private string GetCustomComponentValue(string key)
    {
        return selectedCustomComponents[key];
    }

    private async Task OnExportGeneratedNames()
    {
        await JsRuntime.InvokeVoidAsync("htmlToCSV", "generatednames.csv", "generatednames");
    }

    private void GenerateRandomValue(string customcomponentname, string maxlength, bool alphanumeric)
    {
        string value = GeneralHelper.GenerateRandomString(Convert.ToInt32(maxlength), alphanumeric);
        OnComponentChanged("cc", value, customcomponentname);
    }

    private void ResetForm(bool clearselection)
    {
        selectedResourceTypeCategory = String.Empty;
        Array.Clear(selectedResourceTypeFull);
        selectedResourceTypeProperty = String.Empty;
        selectedResourceTypeShortName = String.Empty;
        selectedResourceTypeDisplayName = String.Empty;
        selectedResourceType = String.Empty;
        componentsVisible = "collapse show";
        currentResourceType = null;
        if (clearselection)
        {
            multiselectedResourceTypes.Clear();
        }
        generatedName = String.Empty;
        namerequested = false;
        optional = " <span class=\"fst-italic\">** OPTIONAL **</span>";
    }

    private async Task GetRetainedSelections()
    {
        // Check if the current selections should be retained
        if (Convert.ToBoolean(config.RetainGenerateSelections))
        {
            selectedResourceType = (await session.GetAsync<string>("selectedResourceType")).Value ?? String.Empty;
            multiselectedResourceTypes = (await session.GetAsync<List<string>>("multiselectedResourceTypes")).Value ?? new List<string>();
            selectedResourceEnvironment = (await session.GetAsync<string>("selectedResourceEnvironment")).Value ?? String.Empty;
            selectedResourceFunction = (await session.GetAsync<string>("selectedResourceFunction")).Value ?? String.Empty;
            selectedResourceInstance = (await session.GetAsync<string>("selectedResourceInstance")).Value ?? String.Empty;
            selectedResourceLocation = (await session.GetAsync<string>("selectedResourceLocation")).Value ?? String.Empty;
            selectedResourceOrg = (await session.GetAsync<string>("selectedResourceOrg")).Value ?? String.Empty;
            selectedResourceProjAppSvc = (await session.GetAsync<string>("selectedResourceProjAppSvc")).Value ?? String.Empty;
            selectedResourceUnitDept = (await session.GetAsync<string>("selectedResourceUnitDept")).Value ?? String.Empty;
            selectedCustomComponents = (await session.GetAsync<Dictionary<string, string>>("selectedCustomComponents")).Value ?? new Dictionary<string, string>();
            StateHasChanged();
        }
    }

    private async Task SetRetainedSelections()
    {
        // Check if the current selections should be retained
        if (Convert.ToBoolean(config.RetainGenerateSelections))
        {
            await session.SetAsync("selectedResourceType", selectedResourceType);
            await session.SetAsync("multiselectedResourceTypes", multiselectedResourceTypes);
            await session.SetAsync("selectedResourceEnvironment", selectedResourceEnvironment);
            await session.SetAsync("selectedResourceFunction", selectedResourceFunction);
            await session.SetAsync("selectedResourceInstance", selectedResourceInstance);
            await session.SetAsync("selectedResourceLocation", selectedResourceLocation);
            await session.SetAsync("selectedResourceOrg", selectedResourceOrg);
            await session.SetAsync("selectedResourceProjAppSvc", selectedResourceProjAppSvc);
            await session.SetAsync("selectedResourceUnitDept", selectedResourceUnitDept);
            await session.SetAsync("selectedCustomComponents", selectedCustomComponents);
        }
    }
    
    // Collapse management for sections
    private HashSet<string> collapsedSections = new HashSet<string> { "instructions", "namingguidelines", "components" };
    
    private void ToggleCollapse(string section)
    {
        if (collapsedSections.Contains(section))
        {
            collapsedSections.Remove(section);
        }
        else
        {
            collapsedSections.Add(section);
        }
    }

    private string GetCollapseClass(string section)
    {
        return collapsedSections.Contains(section) ? "collapsed" : "";
    }
}




