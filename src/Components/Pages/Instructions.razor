@page "/instructions"
@using AzureNamingTool.Components.Instructions
@using AzureNamingTool.Helpers
@using AzureNamingTool.Models
@using AzureNamingTool.Components.General
@inject StateContainer state
@inject ProtectedSessionStorage session
@inject IToastService toastService
@inject NavigationManager NavigationManager

<PageTitle>Azure Naming Tool - Instructions</PageTitle>

<div class="modern-page-container">
    <div class="modern-page-title">
        <h1>Instructions</h1>
    </div>
    
    <div class="modern-page-description">
        <p>Learn how to configure and use the Azure Naming Tool</p>
    </div>
    
    <div class="modern-page-actions">
        <button type="button" class="modern-btn-secondary" @onclick="@ExpandAll" title="Expand all sections">
            <span class="oi oi-fullscreen-enter" aria-hidden="true"></span> Expand All
        </button>
        <button type="button" class="modern-btn-secondary" @onclick="@CollapseAll" title="Collapse all sections">
            <span class="oi oi-fullscreen-exit" aria-hidden="true"></span> Collapse All
        </button>
    </div>
</div>

<div class="modern-card">
    <div class="modern-card-body">
        @if (admin)
        {
            <div class="modern-card mb-3">
                <div class="modern-card-header collapsible @(GetCollapseClass("adminpassword"))" @onclick="@(() => ToggleCollapse("adminpassword"))">
                    <h3>
                        <span class="oi oi-chevron-bottom" aria-hidden="true"></span> Global Admin Password
                    </h3>
                </div>
                <div class="modern-card-body @(GetCollapseClass("adminpassword"))">
                    <AdminPasswordInstructions theme="@theme" admin="@admin" />
                </div>
            </div>
            
            <div class="modern-card mb-3">
                <div class="modern-card-header collapsible @(GetCollapseClass("adminconfiguration"))" @onclick="@(() => ToggleCollapse("adminconfiguration"))">
                    <h3>
                        <span class="oi oi-chevron-bottom" aria-hidden="true"></span> Admin Configuration
                    </h3>
                </div>
                <div class="modern-card-body @(GetCollapseClass("adminconfiguration"))">
                    <AdminConfigurationInstructions theme="@theme" admin="@admin" />
                </div>
            </div>
            
            <div class="modern-card mb-3">
                <div class="modern-card-header collapsible @(GetCollapseClass("adminlog"))" @onclick="@(() => ToggleCollapse("adminlog"))">
                    <h3>
                        <span class="oi oi-chevron-bottom" aria-hidden="true"></span> Admin Log
                    </h3>
                </div>
                <div class="modern-card-body @(GetCollapseClass("adminlog"))">
                    <AdminLogInstructions theme="@theme" admin="@admin" />
                </div>
            </div>
        }
        
        <div class="modern-card mb-3">
            <div class="modern-card-header collapsible @(GetCollapseClass("configuration"))" @onclick="@(() => ToggleCollapse("configuration"))">
                <h3>
                    <span class="oi oi-chevron-bottom" aria-hidden="true"></span> Configuration
                </h3>
            </div>
            <div class="modern-card-body @(GetCollapseClass("configuration"))">
                <ConfigurationInstructions theme="@theme" admin="@admin" />
            </div>
        </div>
        
        <div class="modern-card mb-3">
            <div class="modern-card-header collapsible @(GetCollapseClass("generate"))" @onclick="@(() => ToggleCollapse("generate"))">
                <h3>
                    <span class="oi oi-chevron-bottom" aria-hidden="true"></span> Generate
                </h3>
            </div>
            <div class="modern-card-body @(GetCollapseClass("generate"))">
                <GenerateInstructions theme="@theme" admin="@admin" />
            </div>
        </div>
        
        <div class="modern-card mb-3">
            <div class="modern-card-header collapsible @(GetCollapseClass("generatednameslog"))" @onclick="@(() => ToggleCollapse("generatednameslog"))">
                <h3>
                    <span class="oi oi-chevron-bottom" aria-hidden="true"></span> Generated Names Log
                </h3>
            </div>
            <div class="modern-card-body @(GetCollapseClass("generatednameslog"))">
                <GeneratedNamesLogInstructions theme="@theme" admin="@admin" />
            </div>
        </div>
        
        <div class="modern-card mb-3">
            <div class="modern-card-header collapsible @(GetCollapseClass("reference"))" @onclick="@(() => ToggleCollapse("reference"))">
                <h3>
                    <span class="oi oi-chevron-bottom" aria-hidden="true"></span> Reference
                </h3>
            </div>
            <div class="modern-card-body @(GetCollapseClass("reference"))">
                <ReferenceInstructions theme="@theme" admin="@admin" />
            </div>
        </div>
    </div>
</div>

<AnchorNavigation />
@code {
    [CascadingParameter]
    protected ThemeInfo? theme { get; set; }
    private bool admin = false;
    private SiteConfiguration config = ConfigurationHelper.GetConfigurationData();
    
    // Initialize with all section IDs for collapsed default state
    private HashSet<string> collapsedSections = new HashSet<string>
    {
        "adminpassword",
        "adminconfiguration",
        "adminlog",
        "configuration",
        "generate",
        "generatednameslog",
        "reference"
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var result = await session.GetAsync<bool>("admin");
            admin = (bool)result.Value;
            if (!Convert.ToBoolean(config.InstructionsEnabled) && !admin)
            {
                toastService.ShowWarning("The Instructions page is disabled in the site settings.");
                NavigationManager.NavigateTo("");
            }
            StateHasChanged();
        }
    }
    
    private void ExpandAll()
    {
        collapsedSections.Clear();
    }
    
    private void CollapseAll()
    {
        collapsedSections = new HashSet<string>
        {
            "adminpassword",
            "adminconfiguration",
            "adminlog",
            "configuration",
            "generate",
            "generatednameslog",
            "reference"
        };
    }
    
    private void ToggleCollapse(string section)
    {
        if (collapsedSections.Contains(section))
        {
            collapsedSections.Remove(section);
        }
        else
        {
            collapsedSections.Add(section);
        }
    }

    private string GetCollapseClass(string section)
    {
        return collapsedSections.Contains(section) ? "collapsed" : "";
    }
}
