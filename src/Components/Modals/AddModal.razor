@using AzureNamingTool.Helpers
@using AzureNamingTool.Models
@using AzureNamingTool.Services
@using AzureNamingTool.Services.Interfaces
@using Microsoft.AspNetCore.Html
@using System.Text.RegularExpressions
@inject IToastService toastService
@inject StateContainer state
@inject ProtectedSessionStorage session

<div class="modern-modal-content">
    <div class="modern-modal-body">
        @((MarkupString)message)
        <div class="modern-card" style="margin-bottom: 1rem;">
            <div class="modern-card-header">
                Configuration
            </div>
            <div class="modern-card-body">
                <div style="margin-bottom: 1rem;">
                    Enter the desired configuration.
                </div>
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label for="name" class="modern-form-label">@namelabel</label>
                    <input title="Name" value="@itemName" type="text" class="modern-form-input" id="name" @onchange="@((ui) => { itemName = (string)ui.Value!;})" />
                </div>
                        @switch (type)
                        {
                            case "ResourceComponent":
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <div style="margin-bottom: 1rem;">
                                        <label class="modern-form-label">
                                            Field Type
                                        </label>
                                        <select @bind="itemComponentType" class="modern-form-select">
                                            <option value="standard">Standard - User selects an option from a pre-defined list</option>
                                            <option value="freetext">Free Form / Random</option>
                                        </select>
                                    </div>
                                    @if (itemComponentType == "freetext")
                                    {
                                        <div class="modern-card-body" style="margin-bottom: 1rem;">
                                            <div>
                                                <label class="modern-form-label">
                                                    Generate Random Value
                                                </label>
                                                <div style="margin-bottom: 1rem;">
                                                    By default, Free Form allows any value. If enabled, this setting will generate a random value for the component.
                                                </div>
                                                <div>
                                                    <label class="modern-toggle-switch" title="Generate Random Value">
                                                        <input type="checkbox" checked="@itemEnforceRandom" @oninput='args => ComponentSettingChanged(args, "enforcerandom")'>
                                                        <span class="modern-toggle-slider"></span>
                                                    </label>
                                                    <span class="align-text-top ms-2"> Enable</span>
                                                </div>
                                            </div>
                                            @if (itemEnforceRandom)
                                            {
                                                <div style="margin-top: 1rem;">
                                                    <label class="modern-form-label">
                                                        Generate Alphanumeric Values
                                                    </label>
                                                    <div style="margin-bottom: 1rem;">
                                                        If enabled, the tool will generate a random alphanumeric value for the component. If disabled, only letters will be generated.
                                                    </div>
                                                    <div>
                                                        <label class="modern-toggle-switch" title="Alphanumeric">
                                                            <input type="checkbox" checked="@itemAlphanumeric" @oninput='args => ComponentSettingChanged(args, "alphanumeric")'>
                                                            <span class="modern-toggle-slider"></span>
                                                        </label>
                                                        <span class="align-text-top ms-2"> Enable</span>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                    <div style="margin-bottom: 1rem;">
                                        <label class="modern-form-label">
                                            Description
                                        </label>
                                        <div>
                                            <input title="Description" value="@itemDescription" type="text" class="modern-form-input" id="description" @onchange="@((ui) => { itemDescription = (string)ui.Value!;})" />
                                        </div>
                                    </div>
                                    <div style="margin-bottom: 1rem;">
                                        <label class="modern-form-label">
                                            Minimum Length
                                        </label>
                                        <div>
                                            <input title="Minimum Length" value="@itemMinLength" type="text" class="modern-form-input" id="minlength" @onchange="@((ui) => { itemMinLength = (string)ui.Value!;})" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))" />
                                        </div>
                                    </div>
                                    <div style="margin-bottom: 1rem;">
                                        <label class="modern-form-label">
                                            Maximum Length
                                        </label>
                                        <div>
                                            <input title="Maximum Length" value="@itemMaxLength" type="text" class="modern-form-input" id="maxlength" @onchange="@((ui) => { itemMaxLength = (string)ui.Value!;})" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))" />
                                        </div>
                                    </div>
                                    <div style="margin-bottom: 1rem;">
                                        <label class="modern-form-label">
                                            Apply Before
                                        </label>
                                        <div style="margin-bottom: 1rem;">
                                            If disabled, this setting will not add the current delimiter BEFORE the component value.
                                        </div>
                                        <div>
                                            <label class="modern-toggle-switch" title="Apply Delimiter">
                                                <input type="checkbox" checked="@itemApplyDelimiterBefore" @oninput='args => ComponentSettingChanged(args, "applydelimiterbefore")'>
                                                <span class="modern-toggle-slider"></span>
                                            </label>
                                            <span class="align-text-top ms-2"> Enable</span>
                                        </div>
                                    </div>
                                    <div style="margin-bottom: 1rem;">
                                        <label class="modern-form-label">
                                            Apply Delimiter After
                                        </label>
                                        <div style="margin-bottom: 1rem;">
                                            If disabled, this setting will not add the current delimiter AFTER the component value.
                                        </div>
                                        <div>
                                            <label class="modern-toggle-switch" title="Apply Delimiter">
                                                <input type="checkbox" checked="@itemApplyDelimiterAfter" @oninput='args => ComponentSettingChanged(args, "applydelimiterafter")'>
                                                <span class="modern-toggle-slider"></span>
                                            </label>
                                            <span class="align-text-top ms-2"> Enable</span>
                                        </div>
                                    </div>
                                </div>
                                break;
                            case "ResourceType":
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label for="shortName" class="modern-form-label">Short Name</label>
                                    <input title="Short Name" value="@itemShortName" type="text" class="modern-form-input" id="shortname" @onchange="@((ui) => { itemShortName = (string)ui.Value!;})" />
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <label class="modern-form-label">
                                        Minimum Length
                                    </label>
                                    <div>
                                        <input title="Minimum Length" value="@itemMinLength" type="text" class="modern-form-input" id="minlength" @onchange="@((ui) => { itemMinLength = (string)ui.Value!;})" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))" />
                                    </div>
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <label class="modern-form-label">
                                        Maximum Length
                                    </label>
                                    <div>
                                        <input title="Maximum Length" value="@itemMaxLength" type="text" class="modern-form-input" id="maxlength" @onchange="@((ui) => { itemMaxLength = (string)ui.Value!;})" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))" />
                                    </div>
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <label class="modern-form-label">
                                        Apply Delimiter
                                    </label>
                                    <div style="margin-bottom: 1rem;">
                                        If disabled, the current delimiter will not be used for name generation.
                                    </div>
                                    <div>
                                        <label class="modern-toggle-switch" title="Apply Delimiter">
                                            <input type="checkbox" checked="@itemApplyDelimiter" @oninput='args => ComponentSettingChanged(args, "applydelimiter")'>
                                            <span class="modern-toggle-slider"></span>
                                        </label>
                                        <span class="align-text-top ms-2"> Enable</span>
                                    </div>
                                </div>
                                <div id="typemetdadatacontainer" class="modern-card" style="margin-bottom: 1rem;">
                                    <div class="modern-card-header collapsible @(GetCollapseClass("typemetdadata"))" @onclick="@(() => ToggleCollapse("typemetdadata"))">
                                        <span class="oi oi-chevron-bottom" aria-hidden="true"></span> Resource Type Metadata
                                    </div>
                                    <div class="modern-card-body @(GetCollapseClass("typemetdadata"))" id="typemetdadata">
                                        <div style="margin-bottom: 1rem;">
                                            <p>
                                            This section allows you to edit the Resouce Type metadata.
                                            </p>
                                                <div class="alert alert-danger" style="margin-bottom: 1rem;" role="alert">
                                                    <h4>ATTENTION</h4>
                                                    <span class="modern-font-semibold">Please see the <a href="https://github.com/mspnp/AzureNamingTool/wiki/Resource-Type-Editing" target="_blank">Resource Type Editing documentation</a> for guidance on metadata editing.</span>
                                                </div>

                                        </div>
                                        <div style="margin-bottom: 1rem;">
                                            <div style="margin-bottom: 1rem;">
                                                <label class="modern-form-label">
                                                    Regex
                                                </label>
                                                <div style="margin-bottom: 1rem;">
                                                    Regex to apply to generated names.
                                                </div>
                                                <div>
                                                    <input title="RegEx" value="@itemRegEx" type="text" class="modern-form-input" id="regex" @onchange="@((ui) => { itemRegEx = (string)ui.Value!;})" />
                                                </div>
                                            </div>

                                            <label class="modern-form-label">
                                                Scope
                                            </label>
                                            <div>
                                                <input title="Scope" value="@itemScope" type="text" class="modern-form-input" id="scope" @onchange="@((ui) => { itemScope = (string)ui.Value!;})" />
                                            </div>
                                        </div>
                                        <div style="margin-bottom: 1rem;">
                                            <label class="modern-form-label">
                                                Valid Text
                                            </label>
                                            <div>
                                                <input title="Valid Text" value="@itemValidText" type="text" class="modern-form-input" id="validtext" @onchange="@((ui) => { itemValidText = (string)ui.Value!;})" />
                                            </div>
                                        </div>
                                        <div style="margin-bottom: 1rem;">
                                            <label class="modern-form-label">
                                                Invalid Text
                                            </label>
                                            <div>
                                                <input title="Invalid Text" value="@itemInvalidText" type="text" class="modern-form-input" id="invalidtext" @onchange="@((ui) => { itemInvalidText = (string)ui.Value!;})" />
                                            </div>
                                        </div>
                                        <div style="margin-bottom: 1rem;">
                                            <label class="modern-form-label">
                                                Invalid Characters
                                            </label>
                                            <div>
                                                <input title="Invalid Characters" value="@itemInvalidCharacters" type="text" class="modern-form-input" id="invalidcharacters" @onchange="@((ui) => { itemInvalidCharacters = (string)ui.Value!;})" />
                                            </div>
                                        </div>
                                        <div style="margin-bottom: 1rem;">
                                            <label class="modern-form-label">
                                                Invalid Characters Start
                                            </label>
                                            <div>
                                                <input title="Invalid Characters Start" value="@itemInvalidCharactersStart" type="text" class="modern-form-input" id="invalidcharactersstart" @onchange="@((ui) => { itemInvalidCharactersStart = (string)ui.Value!;})" />
                                            </div>
                                        </div>
                                        <div style="margin-bottom: 1rem;">
                                            <label class="modern-form-label">
                                                Invalid Characters End
                                            </label>
                                            <div>
                                                <input title="Invalid Characters End" value="@itemInvalidCharactersEnd" type="text" class="modern-form-input" id="invalidcharactersend" @onchange="@((ui) => { itemInvalidCharactersEnd = (string)ui.Value!;})" />
                                            </div>
                                        </div>
                                        <div style="margin-bottom: 1rem;">
                                            <label class="modern-form-label">
                                                Invalid Characters Consecutive
                                            </label>
                                            <div>
                                                <input title="Invalid Characters Consecutive" value="@itemInvalidCharactersConsecutive" type="text" class="modern-form-input" id="invalidcharactersconsecutive" @onchange="@((ui) => { itemInvalidCharactersConsecutive = (string)ui.Value!;})" />
                                            </div>
                                        </div>
                                        <div style="margin-bottom: 1rem;">
                                            <label class="modern-form-label">
                                                Static Values
                                            </label>
                                            <div>
                                                <input title="Static Values" value="@itemStaticValues" type="text" class="modern-form-input" id="staticvalues" @onchange="@((ui) => { itemStaticValues = (string)ui.Value!;})" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                break;
                            case "AdminUser":
                                break;
                            default:
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label for="shortName" class="modern-form-label">Short Name</label>
                                    <input title="Short Name" value="@itemShortName" type="text" class="modern-form-input" id="shortname" @onchange="@((ui) => { itemShortName = (string)ui.Value!;})" />
                                </div>
                                break;
                        }
                </div>
            </div>
        </div>

    <div class="modern-modal-footer">
        <button title="Add" @onclick="Save" class="modern-btn-success">Add</button>
        <button title="Cancel" @onclick="Cancel" class="modern-btn-secondary">Cancel</button>
    </div>
</div>

@code {
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; } = new();
    [Parameter] public ThemeInfo theme { get; set; } = new();

    [Parameter] public int id { get; set; } = 0;
    [Parameter] public string title { get; set; } = String.Empty;
    [Parameter] public string message { get; set; } = String.Empty;
    [Parameter] public string type { get; set; } = String.Empty;
    [Parameter] public string parentcomponent { get; set; } = String.Empty;
    [Parameter] public string headerstyle { get; set; } = String.Empty;
    [Parameter] public bool admin { get; set; } = false;
    [Parameter] public ServicesData servicesData { get; set; } = new();
    
    [Inject]
    public IResourceComponentService? ResourceComponentService { get; set; }
    
    [Inject]
    public IAdminUserService? AdminUserService { get; set; }
    
    [Inject]
    public IResourceEnvironmentService? ResourceEnvironmentService { get; set; }
    
    [Inject]
    public IResourceLocationService? ResourceLocationService { get; set; }
    
    [Inject]
    public IResourceOrgService? ResourceOrgService { get; set; }
    
    [Inject]
    public IResourceProjAppSvcService? ResourceProjAppSvcService { get; set; }
    
    [Inject]
    public IResourceTypeService? ResourceTypeService { get; set; }
    
    [Inject]
    public IResourceUnitDeptService? ResourceUnitDeptService { get; set; }
    
    [Inject]
    public IResourceFunctionService? ResourceFunctionService { get; set; }
    
    [Inject]
    public IResourceDelimiterService? ResourceDelimiterService { get; set; }
    
    [Inject]
    public ICustomComponentService? CustomComponentService { get; set; }
    
    [Inject]
    public IAdminLogService? AdminLogService { get; set; }


    private ServiceResponse serviceResponse = new();
    private string itemName = String.Empty;
    private string itemShortName = String.Empty;
    private string itemDescription = String.Empty;
    private string itemMinLength = "1";
    private string itemMaxLength = "10";
    private string itemScope = "";
    private string itemValidText = String.Empty;
    private string itemInvalidText = String.Empty;
    private string itemInvalidCharacters = String.Empty;
    private string itemInvalidCharactersStart = String.Empty;
    private string itemInvalidCharactersEnd = String.Empty;
    private string itemInvalidCharactersConsecutive = String.Empty;
    private string itemRegEx = String.Empty;
    private string itemStaticValues = String.Empty;
    private string itemComponentType = "standard";
    private bool itemEnforceRandom = false;
    private bool itemAlphanumeric = true;
    private bool itemIsFreeText = false;
    private bool itemApplyDelimiterBefore = true;  // Used to determine if the delimiter will be added before the component
    private bool itemApplyDelimiterAfter = true;   // Used to determine if the delimiter will be added after the component
    private bool itemApplyDelimiter = true; // Used to determine if the delimiter is applied to the resource type (all components)
    private string currentuser = String.Empty;
    private string namelabel = "Name";

    protected override async void OnInitialized()
    {
        currentuser = await IdentityHelper.GetCurrentUser(session);
        if (type == "ResourceType")
        {
            namelabel = "Resource";
        }
    }

    async Task Save()
    {
        bool valid = false;
        switch (type)
        {
            case "ResourceComponent":
                if (!String.IsNullOrEmpty(itemName))
                {
                    // Make sure the min/max length is valid
                    if (Convert.ToInt32(itemMaxLength) < Convert.ToInt32(itemMinLength))
                    {
                        toastService.ShowError("The Maximum Length must equal/greater than the Minimum length!");
                    }
                    else
                    {
                        // Make sure the name is unique
                        ArgumentNullException.ThrowIfNull(servicesData.ResourceComponents);
                        List<ResourceComponent> resourceComponents = servicesData.ResourceComponents;
                        if (resourceComponents.Where(x => GeneralHelper.NormalizeName(x.Name, true) == GeneralHelper.NormalizeName(itemName, true)).Count() > 0)
                        {
                            toastService.ShowError("You must enter a unique component name!");
                        }
                        else
                        {
                            valid = true;
                            if (itemComponentType == "freetext")
                            {
                                itemIsFreeText = true;
                            }
                            ResourceComponent resourceComponent = new()
                                {
                                    Name = itemName,
                                    DisplayName = itemName,
                                    Description = itemDescription,
                                    IsCustom = true,
                                    IsFreeText = itemIsFreeText,
                                    MinLength = itemMinLength,
                                    MaxLength = itemMaxLength,
                                    EnforceRandom = itemEnforceRandom,
                                    Alphanumeric = itemAlphanumeric,
                                    ApplyDelimiterBefore = itemApplyDelimiterBefore,
                                    ApplyDelimiterAfter = itemApplyDelimiterAfter
                                };
                            serviceResponse = await ResourceComponentService.PostItemAsync(resourceComponent);
                        }
                    }
                }
                else
                {
                    toastService.ShowError("You must enter a component name!");
                }
                break;
            case "AdminUser":
                if (!String.IsNullOrEmpty(itemName))
                {
                    // Check if the item already exists
                    serviceResponse = await AdminUserService.GetItemsAsync();
                    ArgumentNullException.ThrowIfNull(servicesData.AdminUsers);
                    List<AdminUser> adminUsers = servicesData.AdminUsers;
                    if (adminUsers.Any(x => x.Name == itemName))
                    {
                        toastService.ShowError("You must enter a unique Admin User name!");
                    }
                    else
                    {
                        valid = true;
                        AdminUser adminUser = new AdminUser()
                            {
                                Name = itemName
                            };
                        serviceResponse = await AdminUserService.PostItemAsync(adminUser);
                    }
                }
                break;
            default:
                if ((GeneralHelper.IsNotNull(itemName)) && (GeneralHelper.IsNotNull(itemShortName)))
                {
                    if ((!String.IsNullOrEmpty(itemName)) && (!String.IsNullOrEmpty(itemShortName)))
                    {
                        if (itemShortName.Any(Char.IsWhiteSpace))
                        {
                            toastService.ShowError("You must enter a valid short name with no spaces!");
                            break;
                        }

                        if (await ValidationHelper.ValidateShortName(ResourceComponentService!, type, itemShortName, this.parentcomponent))
                        {
                            string normailzedname = GeneralHelper.NormalizeName(itemName, true);
                            switch (type)
                            {
                                case "ResourceEnvironment":
                                    // Check if the item already exists
                                    ArgumentNullException.ThrowIfNull(servicesData.ResourceEnvironments);
                                    List<ResourceEnvironment> resourceEnvironments = servicesData.ResourceEnvironments;
                                    if (resourceEnvironments.Any(x => GeneralHelper.NormalizeName(x.Name, true) == normailzedname || x.ShortName == itemShortName))
                                    {
                                        toastService.ShowError("You must enter a unique Resource Environment name and short name!");
                                    }
                                    else
                                    {
                                        valid = true;
                                        ResourceEnvironment resourceEnvironment = new ResourceEnvironment()
                                            {
                                                Name = itemName,
                                                ShortName = itemShortName

                                            };
                                        serviceResponse = await ResourceEnvironmentService.PostItemAsync(resourceEnvironment);
                                    }
                                    break;
                                case "ResourceLocation":
                                    // Check if the item already exists
                                    serviceResponse = await ResourceLocationService.GetItemsAsync();
                                    ArgumentNullException.ThrowIfNull(servicesData.ResourceLocations);
                                    List<ResourceLocation> resourceLocations = servicesData.ResourceLocations;
                                    if (resourceLocations.Any(x => GeneralHelper.NormalizeName(x.Name, true) == normailzedname || x.ShortName == itemShortName))
                                    {
                                        toastService.ShowError("You must enter a unique Resource Location name and short name!");
                                    }
                                    else
                                    {
                                        valid = true;
                                        ResourceLocation resourceLocation = new ResourceLocation()
                                            {
                                                Name = itemName,
                                                ShortName = itemShortName

                                            };
                                        serviceResponse = await ResourceLocationService.PostItemAsync(resourceLocation);
                                    }
                                    break;
                                case "ResourceOrg":
                                    // Check if the item already exists
                                    serviceResponse = await ResourceOrgService.GetItemsAsync();
                                    ArgumentNullException.ThrowIfNull(servicesData.ResourceOrgs);
                                    List<ResourceOrg> resourceOrgs = servicesData.ResourceOrgs;
                                    if (resourceOrgs.Any(x => GeneralHelper.NormalizeName(x.Name, true) == normailzedname || x.ShortName == itemShortName))
                                    {
                                        toastService.ShowError("You must enter a unique Resource Org name and short name!");
                                    }
                                    else
                                    {
                                        valid = true;
                                        ResourceOrg resourceOrg = new ResourceOrg()
                                            {
                                                Name = itemName,
                                                ShortName = itemShortName

                                            };
                                        serviceResponse = await ResourceOrgService.PostItemAsync(resourceOrg);
                                    }
                                    break;
                                case "ResourceProjAppSvc":
                                    // Check if the item already exists
                                    serviceResponse = await ResourceProjAppSvcService.GetItemsAsync();
                                    ArgumentNullException.ThrowIfNull(servicesData.ResourceProjAppSvcs);
                                    List<ResourceProjAppSvc> resourceProjAppSvcs = servicesData.ResourceProjAppSvcs;
                                    if (resourceProjAppSvcs.Any(x => GeneralHelper.NormalizeName(x.Name, true) == normailzedname || x.ShortName == itemShortName))
                                    {
                                        toastService.ShowError("You must enter a unique Resource Project/App/Service name and short name!");
                                    }
                                    else
                                    {
                                        valid = true;
                                        ResourceProjAppSvc resourceProjAppSvc = new ResourceProjAppSvc()
                                            {
                                                Name = itemName,
                                                ShortName = itemShortName

                                            };
                                        serviceResponse = await ResourceProjAppSvcService.PostItemAsync(resourceProjAppSvc);
                                    }
                                    break;
                                case "ResourceType":
                                    // Check if the item already exists
                                    serviceResponse = await ResourceTypeService.GetItemsAsync();
                                    ArgumentNullException.ThrowIfNull(servicesData.ResourceTypes);
                                    List<ResourceType> resourceTypes = servicesData.ResourceTypes;
                                    if (resourceTypes.Any(x => GeneralHelper.NormalizeName(x.Resource, true) == normailzedname || x.ShortName == itemShortName))
                                    {
                                        toastService.ShowError("You must enter a unique Resource Type name and short name!");
                                    }
                                    else
                                    {
                                        try
                                        {
                                            // Check the regex is valid
                                            Regex regx = new(itemRegEx);
                                        }
                                        catch (Exception)
                                        {
                                            toastService.ShowError("The Regex is not valid. Please review the code and try again!");
                                            return;
                                        }

                                        // If the above code is valid, then continue with the execution
                                        valid = true;
                                        ResourceType resourceType = new ResourceType()
                                            {
                                                Resource = itemName,
                                                ShortName = itemShortName,
                                                LengthMin = itemMinLength,
                                                LengthMax = itemMaxLength,
                                                ApplyDelimiter = itemApplyDelimiter,
                                                Regx = itemRegEx,
                                                Scope = itemScope,
                                                ValidText = itemValidText,
                                                InvalidText = itemInvalidText,
                                                InvalidCharacters = itemInvalidCharacters,
                                                InvalidCharactersStart = itemInvalidCharactersStart,
                                                InvalidCharactersEnd = itemInvalidCharactersEnd,
                                                InvalidCharactersConsecutive = itemInvalidCharactersConsecutive,
                                                StaticValues = itemStaticValues
                                            };
                                        serviceResponse = await ResourceTypeService.PostItemAsync(resourceType);
                                    }
                                    break;
                                case "ResourceUnitDept":
                                    // Check if the item already exists
                                    serviceResponse = await ResourceUnitDeptService.GetItemsAsync();
                                    ArgumentNullException.ThrowIfNull(servicesData.ResourceUnitDepts);
                                    List<ResourceUnitDept> resourceUnitDepts = servicesData.ResourceUnitDepts;
                                    if (resourceUnitDepts.Any(x => GeneralHelper.NormalizeName(x.Name, true) == normailzedname || x.ShortName == itemShortName))
                                    {
                                        toastService.ShowError("You must enter a unique Resource Unit/Dept name and short name!");
                                    }
                                    else
                                    {
                                        valid = true;
                                        ResourceUnitDept resourceUnitDept = new ResourceUnitDept()
                                            {
                                                Name = itemName,
                                                ShortName = itemShortName

                                            };
                                        serviceResponse = await ResourceUnitDeptService.PostItemAsync(resourceUnitDept);
                                    }
                                    break;
                                case "ResourceFunction":
                                    // Check if the item already exists
                                    serviceResponse = await ResourceFunctionService.GetItemsAsync();
                                    ArgumentNullException.ThrowIfNull(servicesData.ResourceFunctions);
                                    List<ResourceFunction> resourceFunctions = servicesData.ResourceFunctions;
                                    if (resourceFunctions.Any(x => GeneralHelper.NormalizeName(x.Name, true) == normailzedname || x.ShortName == itemShortName))
                                    {
                                        toastService.ShowError("You must enter a unique Resource Function name and short name!");
                                    }
                                    else
                                    {
                                        valid = true;
                                        ResourceFunction resourceFunction = new ResourceFunction()
                                            {
                                                Name = itemName,
                                                ShortName = itemShortName

                                            };
                                        serviceResponse = await ResourceFunctionService.PostItemAsync(resourceFunction);
                                    }
                                    break;
                                case "CustomComponent":
                                    // Check if the item already exists
                                    serviceResponse = await CustomComponentService.GetItemsAsync();
                                    ArgumentNullException.ThrowIfNull(servicesData.CustomComponents);
                                    List<CustomComponent> customComponents = servicesData.CustomComponents;
                                    if (customComponents.Any(x => GeneralHelper.NormalizeName(x.Name, true) == normailzedname || x.ShortName == itemShortName))
                                    {
                                        toastService.ShowError("You must enter a unique Custom Component name and short name!");
                                    }
                                    else
                                    {
                                        valid = true;
                                        CustomComponent customComponent = new CustomComponent()
                                            {
                                                Name = itemName,
                                                ShortName = itemShortName,
                                                ParentComponent = GeneralHelper.NormalizeName(this.parentcomponent, true),
                                                MinLength = itemMinLength,
                                                MaxLength = itemMaxLength
                                            };
                                        serviceResponse = await CustomComponentService.PostItemAsync(customComponent);
                                    }
                                    break;
                            }
                        }
                        else
                        {
                            toastService.ShowError("You must enter a valid name and short name! Please check the Minimum and Maximum length requirements.");
                        }
                    }
                    else
                    {
                        toastService.ShowError("You must enter a name and short name!");
                    }
                }
                break;
        }

        if (valid)
        {
            if (serviceResponse.Success)
            {
                await ModalInstance.CloseAsync();
                toastService.ShowSuccess(type.Replace("Resource", "Resource ") + " added!");
                await AdminLogService?.PostItemAsync(new AdminLogMessage() { Title = "SUCCESS", Message = "(" + type + ") " + itemName + " added!", Source = currentuser });
            }
            else
            {
                toastService.ShowError("There was an error adding the " + GeneralHelper.NormalizeName(type, false) + "!");
            }
        }
    }

    private async Task ComponentSettingChanged(ChangeEventArgs e, string setting)
    {
        try
        {
            if (GeneralHelper.IsNotNull(e.Value))
            {
                switch (setting)
                {
                    case "enforcerandom":
                        itemEnforceRandom = (bool)e.Value;
                        break;
                    case "alphanumeric":
                        itemAlphanumeric = (bool)e.Value;
                        break;
                    case "applydelimiterbefore":
                        itemApplyDelimiterBefore = (bool)e.Value;
                        break;
                    case "applydelimiterafter":
                        itemApplyDelimiterAfter = (bool)e.Value;
                        break;
                    case "applydelimiter":
                        itemApplyDelimiter = (bool)e.Value;
                        break;
                }
            }
            else
            {
                toastService.ShowError("There was an error updating the component!");
            }
        }
        catch (Exception ex)
        {
            await AdminLogService?.PostItemAsync(new AdminLogMessage() { Title = "ERROR", Message = ex.Message });
            toastService.ShowError("There was an error updating the " + GeneralHelper.NormalizeName(type, false) + "! " + ex.Message);
        }
    }


    async Task Cancel() => await ModalInstance.CancelAsync();
    
    // Collapse management for sections
    private HashSet<string> collapsedSections = new HashSet<string> { "typemetdadata" };
    
    private void ToggleCollapse(string section)
    {
        if (collapsedSections.Contains(section))
        {
            collapsedSections.Remove(section);
        }
        else
        {
            collapsedSections.Add(section);
        }
    }

    private string GetCollapseClass(string section)
    {
        return collapsedSections.Contains(section) ? "collapsed" : "";
    }
}

